<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.renamerole">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62193,54694.82347</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""loadbody()"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !,"<table><tr><td>",!
	Write "<form name=""myform"">"
	Write !,..InsertHiddenFields(""),!
	Write !,"Введите название роли:</td><td>",!
	Write "<input type=""text"" name=""rolename"" width=100 value="""">"
	Write "</td></tr>",!
	Write "<tr><td>Функции роли:</td><td>",!
	f j=1:1:i w "<INPUT TYPE=checkbox NAME=""comp"_j,""" VALUE=""",j,""">",func(j),"</td></tr><tr><td></td><td>",!
	Write !,"</td></tr><tr><td></td><td>",!
	Write "<input type=""button"" value=""Изменить"" onclick=""Savechange()"">"
	Write !,"</form>"
	Write !,"</table>",!
	Write "</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !,!
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !
	s sbor="",sborka=""
	&sql(declare perscur Cursor for
	select ID,Name into :IDname,:Funcname 
	from Users.Functions)
	&sql(open perscur)
	f  &sql(fetch perscur) q:SQLCODE  d
	.i $I(i)
	.s iden(i)=IDname
	.s func(i)=Funcname
	&sql(close perscur)
	s namerole=""
	s namerole=$G(%request.Data("rolename",1))
	&sql(declare mycursor Cursor for
	select NameFunction into :namefunc from Users.roles where Name=:namerole)
	&sql(open mycursor)
	f  &sql(fetch mycursor) q:SQLCODE  d
	.i $I(c)
	.s function(c)=namefunc
	&sql(close mycursor)
	f j=1:1:$G(c) {i function(j) s sbor=sbor_"myform.comp"_j_".checked=true; " else  s sbor=sbor_"myform.comp"_j_".checked=false; "}
	f k=1:1:i d
	.s sborka=sborka_"if (myform.comp"_k_".checked==true){(func["_k_"]="_iden(k)_")};                                                           "
	Write !,"<script language=""Jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<script language=""JScript"">"
	Write !,"var func=new Array();",!
	Write "var rolesavearr=new Array();",!
	Write "function loadbody(){ ",!
	Write "	number='"_(namerole)_"';",!
	Write "	document.myform.rolename.value=number;",!
	Write "	 "_(sbor),!
	Write "     }",!
	Write "	",!
	Write "	function Savechange(){",!
	Write "	qwe="_(i)_";",!
	Write "	param=true;",!
	Write "	for(l=1;l<=qwe;l++){",!
	Write "		 func[l]=0;}",!
	Write "		role=document.myform.rolename.value;",!
	Write "		"_(sborka),!
	Write "		 var str = func.join(""~""); ",!
	Write "		ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Users.Roles.RenameRole:csp.renamerole"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',number,role,str);",!
	Write "		if (ok==1){alert(""невозможно изменить данную роль"");}",!
	Write "	    	ok="""";",!
	Write "	    	window.close();",!
	Write "	}",!
	Write "</script>"
	Write !,"<title>	Пользователи </title>",!
	Write !,(..HyperEventHead())
	Write "</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html>"
	Write !
	Do ..OnPageHEAD()
	Write !
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  s login=$G(%session.Data("user"))
  i '+login s %response.ServerSideRedirect="norights.csp" 
  q 1
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\renamerole.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/renamerole.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>61711,3253</Default>
</Parameter>
</Class>
</Export>
