<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.Login2">
<Description>
Приведение к стандартной схеме </Description>
<Super>%CSP.Login</Super>
<TimeCreated>62353,74163.314544</TimeCreated>

<Method name="OnPage">
<Description>
Output the default login page as HTML</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	// text strings
	Set ConfigName = $P($zu(86),"*",2)
	// get key, lookup in localization global
	Set tLang = $get(^%SYS("LANGUAGE","CURRENT"),"en")
	Set tTitle = $$FormatText^%occMessages($$$GetSysMessage(tLang,..#DOMAIN,"logintitle","Login %1"),ConfigName)
	Set tPrompt = $$$GetSysMessage(tLang,..#DOMAIN,"loginenter","Please enter your user name and password")
	Set tUserName = $$$GetSysMessage(tLang,..#DOMAIN,"loginusername","User Name")
	Set tPassword = $$$GetSysMessage(tLang,..#DOMAIN,"loginpassword","Password")
	Set tLogin = $$$GetSysMessage(tLang,..#DOMAIN,"login","Login")
	Set tLogout = $$$GetSysMessage(tLang,..#DOMAIN,"loginlogout","You are logged out")
	&html<<html><head>
		<title>#(tTitle)#</title>
	>

	Do ..DrawHEAD()
	
	// js functions
	&html<<script language="javascript">
// called when page is loaded
function pageLoad()
{
	// see if we can give focus to the UserName field:
	if (self.document.Login && self.document.Login.CacheUserName) {
		self.document.Login.CacheUserName.focus();
	}

	return true;
}
	</script>>
 
 &html<</head>
 	<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onload="pageLoad();">
 	>
 
	Do ..DrawTitle(tTitle)
	If $G(%request.Data("LOGOUT",1)) = 1 {
		Set %session.EndSession = 1
		&html<<center><h3>#(tLogout)#</h3></center>>
	}
    
    s errorPage=$g(%request.Data("Error:URL",1))
	// Show standard login form
 	&html<<table border="0" align="center">
 	<tr>
	<td colspan="10" align="center">
 	<table border="0" class="LayoutMain" width="100%" cellpadding="0" cellspacing="0">
 	<tr><td class="LayoutContentCol" width="80%" align="left"><br>
	<div class="Text1" style="padding-bottom: 5px; color: darkblue; font-size: 0.9em;">#(tPrompt)#:</div>
	</td></tr>
	<tr><td align="center">
	<form name="Login" method="post" action="#(..EscapeURL(errorPage))#">>

	Write ..InsertHiddenFields(errorPage)

	&html<
	<table class="AutoForm">
	<tr><td>
	<tr class="AutoForm" valign="center">
	<td class="AutoFormCaption" nowrap>#(tUserName)#:</td>
	<td class="AutoFormControl" nowrap>
 		<input type="text" size="40" name="CacheUserName">&nbsp;
 	</td>
 	</tr>
	<tr>
	<td class="AutoFormCaption" nowrap>#(tPassword)#:</td>
	<td class="AutoFormControl" nowrap>
		<input type="password" size="25" name="CachePassword">&nbsp;
	</td>
	</tr>
	<tr>
 	<td>&nbsp;</td>
	 <td><input type="submit" name="CacheLogin" value="#(tLogin)#"></td>
	</tr>
	</table>
	</form>>

	// test for error
	Set tMsg = $Get(%request.Data("Error:ErrorCode",1))
 	If ((tMsg'="")&&($$$GETERRORCODE(tMsg)'=864)) {
	 	Do ShowError^%apiCSP(tMsg)
 	}

	&html<</body></html>>

	Quit $$$OK
]]></Implementation>
</Method>
</Class>
</Export>
