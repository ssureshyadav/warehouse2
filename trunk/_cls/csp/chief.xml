<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.chief">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<IncludeCode>xmlmacros</IncludeCode>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62301,49216.159031</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""load()"" onunload=""unload()"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !,"<TABLE cellSpacing=0 width=""100%"" celpadding=""0"" >",!
	Write "<TR>",!
	Write "<td width=10%>"
	Write "<img alt=""Обновить раздел"" src=""images/refresh.gif"" onclick=""window.location.reload()"">"
	Write "</td>",!
	Write "<TD width=80% align=center style=""BACKGROUND: rgb(233,243,255); FONT-size: 18px ; font-family: arial; COLOR: rgb(0,0,102); BORDER-BOTTOM: rgb(0,0,102) 1px solid"" colspan=2><strong>Рабочее место сервис менеджера</strong></TD>",!
	Write "<td  width=10% align=right>"
	Write "<!--<a href=""talk.csp"" ><img src=""images/BIGProp.gif"" width=""20"" height=25 border=0></a>-->"
	Write "</td>",!
	Write "</tr>",!
	Write "</TABLE>",!
	Write "<br>",!
	Write !,!,"<!--  Таблица с планами   -->"
	Write !,"<input type=""checkbox"" id=""hideplan"" onclick=""hideplanFn()"">"
	Write " Скрыть план руководителя",!
	Write "<fieldset id=""planfield""><legend>План</legend>",!
	Write "Период c "
	Write "<input type=text id=""dat1"" value="""_($ZD($H,4))_""" onclick=""fnCalendar(this)"" class=""datar"">"
	Write " по "
	Write "<input type=text id=""dat2"" value="""_($ZD($H,4))_""" onclick=""fnCalendar(this)"" class=""datar"">"
	Write !,!,"<img src=""images/ok.gif"" onmouseover=""okbut1.src='images/Onok.gif'"" onmouseout=""okbut1.src='images/ok.gif'""  id=""okbut1"" name=""okbut1"" alt=""Показать записи"" onclick=""ShowPlan()"" style="""">"
	Write "<br>",!
	Write " <SKLADList:listview width=100% height=100 id=""plan"" onAddColumns=""ShowPlan()"" ClassName=""Operation.Plan"" zonDblClick=""ItemPlan(plan.ItemID)"" /><br>",!
	Write "  <table width=100% ><tr><td width=100%>",!
	Write "  "
	Write !,"<img src=""images/new.gif"" onmouseover=""newtov1.src='images/Onnew.gif'"" onmouseout=""newtov1.src='images/new.gif'""  id=""newtov1"" name=""newtov1"" alt=""Создать запись"" onclick=""ItemPlan()"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/edit.gif"" onmouseover=""edititem.src='images/Onedit.gif'"" onmouseout=""edititem.src='images/edit.gif'""  id=""edititem"" name=""edititem"" alt=""Редактировать запись"" onclick=""ItemPlan(plan.ItemID)"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/down.gif"" onmouseover=""deltov78.src='images/Ondown.gif'"" onmouseout=""deltov78.src='images/down.gif'""  id=""deltov78"" name=""deltov78"" alt=""Создать инструкцию"" onclick=""InstrFromPlan()"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/print.gif"" onmouseover=""printpan.src='images/Onprint.gif'"" onmouseout=""printpan.src='images/print.gif'""  id=""printpan"" name=""printpan"" alt=""Распечатать план"" onclick=""PrintPlanFn()"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/excel.gif"" onmouseover=""btnOpenExcel.src='images/Onexcel.gif'"" onmouseout=""btnOpenExcel.src='images/excel.gif'""  id=""btnOpenExcel"" name=""btnOpenExcel"" alt=""Открыть в Excel"" onclick=""OpenExcel(plan.ItemID)"" style="""">"
	Write !,"  </td>",!
	Write "  <td>",!
	Write "  "
	Write !,"<img src=""images/del.gif"" onmouseover=""deltov1.src='images/Ondel.gif'"" onmouseout=""deltov1.src='images/del.gif'""  id=""deltov1"" name=""deltov1"" alt=""Удалить запись"" onclick=""DelItem()"" style="""">"
	Write !,"  </td>",!
	Write "  </tr>",!
	Write "  </table>",!
	Write "</fieldset>",!
	Write "<br>",!
	Write !,"<!--  Таблица с инструкциями   -->"
	Write !,"<fieldset ><legend>Инструкции</legend>",!
	Write "<table>",!
	Write "<tr>",!
	Write "	<td><b>Период</b>",!
	Write "	<td><b>Статус</b>",!
	Write "	<td><b>Контрагент</b>",!
	Write "	<td><b>Номер</b>",!
	Write "	<td>&nbsp;",!
	Write "</tr>",!
	Write "<tr>",!
	Write "	<td>c "
	Write "<input type=text id=""dat11"" value="""_($ZD($H,4))_""" onclick=""fnCalendar(this)"" class=""datar"">"
	Write " по "
	Write "<input type=text id=""dat21"" value="""_($ZD($H,4))_""" onclick=""fnCalendar(this)"" class=""datar"">"
	Write !,"	<td>",!
	Write "		"
	w "<select id=""qwer"">"
	w ##class(Docs.Action2).GetDisplaylistOptions("","Operation.Instructions||State")
	w "<option value=""all"">Все включая завершённые</option>"
	w "</select>"
	Write !,"	<td>",!
	Write "		"
	Write "<select id=""ChooseKontragent"" onchange=""ChooseKontragentFunc()"">"
	Write !,"			"
	Write "<option value=""all"">"
	Write "Все</option>",!
	Write "			"
	Write "<option value=""choose"">"
	Write "Выбрать контрагента...</option>",!
	Write "		"
	Write "</select>"
	Write !,"	<td>"
	Write "<input type=text id=""InstrComment"" name=""InstrComment"" style=""border:solid 1 black;width:50px"" title=""Для поиска можно вводить лишь первые символы номера"">"
	Write !,"	<td>"
	Write !,"<img src=""images/ok.gif"" onmouseover=""okbut11.src='images/Onok.gif'"" onmouseout=""okbut11.src='images/ok.gif'""  id=""okbut11"" name=""okbut11"" alt=""Показать записи"" onclick=""ShowInstr()"" style="""">"
	Write !,"</tr>",!
	Write "</table>",!
	Write "<SKLADList:listview width=100% height=100 id=""instr"" onAddColumns=""ShowInstr()"" ClassName=""Operation.Instructions"" zonDblClick=""ItemInstr(instr.ItemID)"" zClick=""showtovsins()"" Skip=""Source->Name,child->Name""/>",!
	Write "  <table width=100%><tr><td width=80%>",!
	Write "  "
	Write !,"<img src=""images/new.gif"" onmouseover=""newtov.src='images/Onnew.gif'"" onmouseout=""newtov.src='images/new.gif'""  id=""newtov"" name=""newtov"" alt=""Создать запись"" onclick=""ItemInstr()"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/edit.gif"" onmouseover=""edittov.src='images/Onedit.gif'"" onmouseout=""edittov.src='images/edit.gif'""  id=""edittov"" name=""edittov"" alt=""Редактировать запись"" onclick=""ItemInstr(instr.ItemID)"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/ok2.gif"" onmouseover=""approve.src='images/Onok2.gif'"" onmouseout=""approve.src='images/ok2.gif'""  id=""approve"" name=""approve"" alt=""Утвердить"" onclick=""changestat('2')"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/calendar.gif"" onmouseover=""eltov.src='images/Oncalendar.gif'"" onmouseout=""eltov.src='images/calendar.gif'""  id=""eltov"" name=""eltov"" alt=""Просмотр внутренней инструкции"" onclick=""lookinnerinstr(instr.ItemID)"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/history.gif"" onmouseover=""lookhistory.src='images/Onhistory.gif'"" onmouseout=""lookhistory.src='images/history.gif'""  id=""lookhistory"" name=""lookhistory"" alt=""История инструкции"" onclick=""lookhist(instr.ItemID)"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/ok.gif"" onmouseover=""fin.src='images/Onok.gif'"" onmouseout=""fin.src='images/ok.gif'""  id=""fin"" name=""fin"" alt=""Завершить"" onclick=""changestat('9')"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/txt.gif"" onmouseover=""tx.src='images/Ontxt.gif'"" onmouseout=""tx.src='images/txt.gif'""  id=""tx"" name=""tx"" alt=""Создать документ на основании инструкции"" onclick=""doc()"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/copy.gif"" onmouseover=""copyInstr.src='images/Oncopy.gif'"" onmouseout=""copyInstr.src='images/copy.gif'""  id=""copyInstr"" name=""copyInstr"" alt=""Копировать инстукцию"" onclick=""CopyInstr(instr.ItemID)"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/print.gif"" onmouseover=""printInstr.src='images/Onprint.gif'"" onmouseout=""printInstr.src='images/print.gif'""  id=""printInstr"" name=""printInstr"" alt=""Печать инстукции"" onclick=""PrintInstr(instr.ItemID)"" style="""">"
	Write !,"  "
	Write "<img src=""images/VertDelimeter.gif"">"
	Write !,"  	"
	Write !,"<img src=""images/txt.gif"" onmouseover=""btnLookBrakComment.src='images/Ontxt.gif'"" onmouseout=""btnLookBrakComment.src='images/txt.gif'""  id=""btnLookBrakComment"" name=""btnLookBrakComment"" alt=""Показать негативный отзыв контрагента"" onclick=""ShowFieldFn(instr.ItemID,'Operation.Instructions','BrakComment')"" style="""">"
	Write !,"	"
	Write !,"<img src=""images/txt.gif"" onmouseover=""btnSetBrakAnswer.src='images/Ontxt.gif'"" onmouseout=""btnSetBrakAnswer.src='images/txt.gif'""  id=""btnSetBrakAnswer"" name=""btnSetBrakAnswer"" alt=""Ответить на негативный отзыв"" onclick=""SetInstrField(instr.ItemID,'SetBrakAnswer','Ответ на негативный отзыв','Ответ на негативный отзыв сохранён')"" style="""">"
	Write !,"	"
	Write !,"<img src=""images/txt.gif"" onmouseover=""btnLookBrakCommentAnsw.src='images/Ontxt.gif'"" onmouseout=""btnLookBrakCommentAnsw.src='images/txt.gif'""  id=""btnLookBrakCommentAnsw"" name=""btnLookBrakCommentAnsw"" alt=""Показать ответ на негативный отзыв контрагента"" onclick=""ShowFieldFn(instr.ItemID,'Operation.Instructions','BrakCommentAnswer')"" style="""">"
	Write !,"  "
	Write "<img src=""images/VertDelimeter.gif"">"
	Write !,"  	"
	Write !,"<img src=""images/stop.gif"" onmouseover=""btnStop.src='images/Onstop.gif'"" onmouseout=""btnStop.src='images/stop.gif'""  id=""btnStop"" name=""btnStop"" alt=""Отклонить заявку"" onclick=""RefuseInstr(instr.ItemID)"" style="""">"
	Write !,"  </td><td width=20% align=right>",!
	Write "  "
	Write !,"<img src=""images/del.gif"" onmouseover=""deltov.src='images/Ondel.gif'"" onmouseout=""deltov.src='images/del.gif'""  id=""deltov"" name=""deltov"" alt=""Удалить запись"" onclick=""DelItemInstr()"" style="""">"
	Write !,"  "
	Write !,"<img src=""images/del+.gif"" onmouseover=""deltov2.src='images/Ondel+.gif'"" onmouseout=""deltov2.src='images/del+.gif'""  id=""deltov2"" name=""deltov2"" alt=""Удалить все документы инструкции руководителя"" onclick=""DelInstrDocs()"" style="""">"
	Write !,"  </td></tr></table>",!
	Write "  "
	Write "<!--",!
	Write "  <sklad:LittleButton name=""ok"" id=""acceptinstr"" onclick=""changestat()"" alt=""Подтвердить завершение""><br>  ",!
	Write "  -->"
	Write !,"</fieldset>",!
	Write !,!,"<!--  Таблица с товарами   -->"
	Write !,"<input type=""checkbox"" id=""hideGoods"" onclick=""hideGoodsFn()"">"
	Write " Не выводить товары",!
	Write "<fieldset id=""GoodsField""><legend>Товары "
	Write "<span id=""whostovar"">"
	Write "</span>"
	Write "</legend>",!
	Write "<!--",!
	Write "<SKLADList:listview width=100% height=100 id=""tovars"" onAddColumns=""LoadGoodsFromCard()"" ClassName=""Goods.Goods""/><br>",!
	Write "<SKLAD2:table id=""docstr"" width=100% height=100 ClassName=""Operation.InstructionsItems"" />",!
	Write "-->"
	Write !,"<SKLADiGrid:iGrid id=""docstr"" width=""100%"" height=""200"" Enabled=""true""/>",!
	Write "</fieldset>",!
	Write "<span id=""InstrReminder"">"
	Write "</span>"
	Write !,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !,!,!
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<style>"
	Write !,"input{border:none;width:15px}",!
	Write "</style>"
	Write !,"<script language=""jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<script language=""Jscript"">"
	Write !,"var CardId=""""; //условие для отбора товаров",!
	Write "sessionid="""_(%session.SessionId)_""";",!
	Write "var j = new Array();",!
	Write !,"//при загрузке страницы",!
	Write "function load()",!
	Write "{",!
	Write "	hideplan.checked=ReturnBoolean(GetCookie(""hideplanchecked""));",!
	Write "	hideGoods.checked=ReturnBoolean(GetCookie(""hideGoodschecked""));",!
	Write "		plan.LoadHeaders(""Parent,Comment"");",!
	Write "		instr.LoadHeaders(""Doc,DocType,Tim,Dat,Summa,Stat,Operation"");",!
	Write "	//docstr.LoadHeadersXML(""Doc,DocType,quantplan,addr,addr2,spravka,Client,goodsdir,garant,sn,seller"");",!
	Write "	",!
	Write "	var Captions = new Array(4);",!
	Write "	var Keys = new Array(4);",!
	Write "	var Tags = new Array(4);",!
	Write "	",!
	Write "	Captions[0]=""Товар"";",!
	Write "	Captions[1]=""Количество"";",!
	Write "	Captions[2]=""Цена"";",!
	Write "	Captions[3]=""Сумма"";",!
	Write "	",!
	Write "	Tags[0]=""Goods.Goods"";",!
	Write "	Tags[1]=""%Numeric"";",!
	Write "	Tags[2]=""%Numeric"";",!
	Write "	Tags[3]=""%Numeric"";",!
	Write "	",!
	Write "	Keys[0]=""Goods"";",!
	Write "	Keys[1]=""Quantity"";",!
	Write "	Keys[2]=""Price"";",!
	Write "	Keys[3]=""Total"";",!
	Write "	docstr.DrawHeaders(Captions,Keys,Tags);",!
	Write "	",!
	Write "	hideplanFn();",!
	Write "	hideGoodsFn();",!
	Write "	FillInstrReminder();	//проверить пропущенные инструкции",!
	Write "}",!
	Write !,"function ItemPlan(PlanID){",!
	Write "PlanID=ReturnSpace(PlanID)",!
	Write "WinResult=window.showModalDialog(""PlanIgrid.csp?source=""+PlanID,"""",""center:yes;status:no;dialogHeight:600px;dialogWidth:800px;resizable:yes;"")",!
	Write "if(WinResult==1)ShowPlan();",!
	Write "}",!
	Write !,"function ShowPlan(){",!
	Write "var Data1=ConvertDateSql(dat1.value);",!
	Write "var Data2=ConvertDateSql(dat2.value);",!
	Write "plan.DownLoad(""PlanDate2>=CAST('""+Data1+""' AS DATE) AND PlanDate<=CAST('""+Data2+""' AS DATE)"");",!
	Write "}",!
	Write !,"function DelItem(){",!
	Write "	if(!window.confirm(""Вы хотите удалить выбранный пункт?"")){return false;}",!
	Write "	ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.deletedoc:csp.chief"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',plan.ClassName,plan.ItemID)",!
	Write "	if(ok==1){ShowPlan();}",!
	Write "	else{alert(ok)}",!
	Write "}",!
	Write !,"function ShowInstr()",!
	Write "{",!
	Write "	var Data1=ConvertDateSql(dat11.value);",!
	Write "	var Data2=ConvertDateSql(dat21.value);",!
	Write "	var InstrCommentVar="""";",!
	Write "	if(qwer.value!="""")",!
	Write "	{",!
	Write "		var stat=""and State=""+qwer.value;",!
	Write "		if(qwer.value==""all"")var stat="""";",!
	Write "	}",!
	Write "	else",!
	Write "	{",!
	Write "		var stat=""and State<9"";",!
	Write "	}",!
	Write "	if(InstrComment.value!=""""){var InstrCommentVar="" and Name %STARTSWITH '""+InstrComment.value+""'""}",!
	Write "	var variable=""InstDate>=CAST('""+Data1+""' AS DATE) and InstDate<=CAST('""+Data2+""' AS DATE) ""+stat+InstrCommentVar",!
	Write "	",!
	Write "	var currentKontragent=ChooseKontragent.value;",!
	Write "	if(currentKontragent!=""all""){var variable=variable+"" and Kontr=""+currentKontragent}",!
	Write "	",!
	Write "	instr.DownLoad(variable);",!
	Write "}",!
	Write !,"function ItemInstr(item,source){",!
	Write "	item=ReturnSpace(item)",!
	Write "	//source=ReturnSpace(source)",!
	Write "	//var CspFile=""createinstruct.csp"";",!
	Write "	//if(OpenIGrid.checked){}",!
	Write "	var CspFile=""createinstructIgrid.csp"";var source=item;",!
	Write "	mok=window.showModalDialog(CspFile+""?source=""+source,item+"";""+instr.ClassName,""center:yes;status:no;dialogHeight:600px;dialogWidth:720px;resizable:yes;"")",!
	Write "	if(mok==1){ShowInstr()}",!
	Write "}",!
	Write !,"// удалить инструкцию",!
	Write "function DelItemInstr(){",!
	Write "	if(!window.confirm(""Вы хотите удалить инструкцию '""+instr.ItemName+""'?"")){return false;}",!
	Write "	DelInstrDocs();",!
	Write "	ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.deletedoc:csp.chief"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',instr.ClassName,instr.ItemID)",!
	Write "	if(ok==1){ShowInstr();}",!
	Write "	else{alert(ok)}",!
	Write "}",!
	Write !,"//удалить документы инструкции ",!
	Write "function DelInstrDocs(){",!
	Write "	if(!window.confirm(""Вы хотите удалить все документы инструкции руководителя ""+instr.ItemName+""?"")){return false;}",!
	Write "	var ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Operation.InstrActions.DeleteInstrChildren:csp.chief"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',instr.ItemID)",!
	Write "	if(ok==1){alert(""Все документы инструкции руководителя ""+instr.ItemName+"" успешно удалены."");}",!
	Write "	else{alert(ok)}",!
	Write "}",!
	Write !,"function showtovsins(){",!
	Write "CardId=instr.ItemID+""@""+instr.ClassName;",!
	Write "//tovars.LoadHeaders();",!
	Write "docstr.Clear()",!
	Write "loadgoods(instr.ItemID);",!
	Write "}",!
	Write !,"function LoadGoodsFromCard(){",!
	Write "	tovars.GetFromCard(CardId);",!
	Write "}",!
	Write !,"//вывести на печать внутреннюю инструкцию",!
	Write "function lookinnerinstr(ItemID)",!
	Write "{",!
	Write "	window.open(""PrintInnerFromChief.csp?super=""+ItemID+""&sessionid=""+sessionid)",!
	Write "}",!
	Write !,"function changestat(newstat){",!
	Write "	var HasBeenSent="""";",!
	Write "	if(newstat==9)",!
	Write "	{",!
	Write "		var InstrType="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Operation.InstrActions.GetInstrType:csp.chief"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',instr.ItemID)	",!
	Write "		if((InstrType==4)||(InstrType==10)||(InstrType==11))",!
	Write "		{",!
	Write "			var answer=window.confirm(""Поставить инструкции ""+instr.ItemName+"" статус 'Отправлена'?"")",!
	Write "			if(answer){var HasBeenSent=1;}",!
	Write "			else{var HasBeenSent=0;}",!
	Write "			",!
	Write "		}",!
	Write "	}",!
	Write "	ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Operation.InstrActions.changestat:csp.chief"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',instr.ItemID,newstat,HasBeenSent)",!
	Write "	if(ok.split(""@"")[0]!=1){alert(ok)}",!
	Write "	else",!
	Write "	{",!
	Write "		//если требовали завершить и все успешно",!
	Write "		if(newstat==9)",!
	Write "		{",!
	Write "			instr.DelItems()",!
	Write "		}	",!
	Write "		",!
	Write "		if(newstat==2)",!
	Write "		{",!
	Write "			instr.ChangeCell(""State"",ok.split(""@"")[1])",!
	Write "			alert(""Инструкция руководителя утверждена"");",!
	Write "		}",!
	Write "		",!
	Write "		//отклонение заявки",!
	Write "		if(newstat==8.6)",!
	Write "		{",!
	Write "			SetInstrField(instr.ItemID,'RefuseReason','Пояснения контрагенту о причинах отклонения заявки','Причины отклонения сохранены');",!
	Write "		}",!
	Write "	}",!
	Write "}",!
	Write !,"function lookhist(instrItemID){",!
	Write "window.showModalDialog(""instrhistory.csp?instr=""+instrItemID,"""",""center:yes;status:no;dialogHeight:300px;dialogWidth:600px;resizable:yes;"")",!
	Write "}",!
	Write !,"function loadgoods(DocID){",!
	Write "if(!hideGoods.checked){",!
	Write "	docstr.loadfrommethod(""Docs.Action2.ChiefInstructStr"",DocID);",!
	Write "	}",!
	Write "}",!
	Write !,"// создание дочерних документов от инструкции",!
	Write "function doc(){",!
	Write "ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.DocFromInstr:csp.chief"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',instr.ItemID)",!
	Write "if(isNaN(ok)){alert(ok)}",!
	Write "else{alert(""Документ успешно создан"")}",!
	Write "}",!
	Write !,"// при закрытии окна",!
	Write "function unload(){",!
	Write "	//plan.saveColunmsSettings();",!
	Write "	//instr.saveColunmsSettings();",!
	Write "}",!
	Write !,"//Клонировать инструкцию",!
	Write "function CopyInstr(instrItemID){",!
	Write "if(ReturnSpace(instrItemID)==""""){return }",!
	Write "var ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.CloneDoc:csp.chief"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',instrItemID)",!
	Write "if(isNaN(ok)){alert(ok)}",!
	Write "else{ShowInstr()}",!
	Write "}",!
	Write !,"//Создать инструкцию на основе плана",!
	Write "function InstrFromPlan(){",!
	Write "//'',plan.ItemID+'@'+plan.ClassName",!
	Write "if(!window.confirm(""Создать инструкцию на основе плана?""))return;",!
	Write "var InstrId="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Operation.InstrActions.InstrFromPlan:csp.chief"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',plan.ItemID)",!
	Write "if(InstrId==""PlanIsClosed"")",!
	Write "	{",!
	Write "	if(window.confirm(""На основе плана уже была создана инструкция, вы хотите создать ещё одну?""))",!
	Write "		{",!
	Write "		var InstrId="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Operation.InstrActions.InstrFromPlan:csp.chief"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',plan.ItemID,1)",!
	Write "		}",!
	Write "	else",!
	Write "		{",!
	Write "		return",!
	Write "		}",!
	Write "	}",!
	Write "if(isNaN(InstrId)){alert(InstrId);}",!
	Write "else{ItemInstr(InstrId);ShowPlan();}",!
	Write "}",!
	Write !,"//скрыть показать план руководителя",!
	Write "function hideplanFn(){",!
	Write "if(hideplan.checked){planfield.style.display=""none"";}",!
	Write "else{planfield.style.display=""inline"";}",!
	Write "SetCookie(""hideplanchecked"",hideplan.checked);",!
	Write "}",!
	Write !,"//скрыть показать товары инструкций",!
	Write "function hideGoodsFn(){",!
	Write "if(hideGoods.checked){GoodsField.style.display=""none"";}",!
	Write "else{GoodsField.style.display=""inline"";}",!
	Write "SetCookie(""hideGoodschecked"",hideGoods.checked);",!
	Write "}",!
	Write !,"function PrintPlanFn(){",!
	Write "if(ReturnSpace(plan.ItemID)=="""")return",!
	Write "window.open(""screen/ChiefPlanHtml.csp?docid=""+plan.ItemID)",!
	Write "}",!
	Write !,"function PrintInstr(ItemID){",!
	Write "if(ReturnSpace(ItemID)=="""")return",!
	Write "window.open(""screen/ChiefInstr.csp?docid=""+ItemID);",!
	Write "}",!
	Write !,"// Выбрать контрагента",!
	Write "function ChooseKontragentFunc()",!
	Write "{",!
	Write "	var UsersSelection=ChooseKontragent.options(ChooseKontragent.selectedIndex).value;",!
	Write "	if(UsersSelection==""choose"")",!
	Write "	{",!
	Write "		var newKontragent=window.showModalDialog(""Dictionary.csp"",""Common.Kontragent"",""center:yes;status:no;dialogHeight:400px;dialogWidth:650px;resizable:yes;"");",!
	Write "		if(newKontragent==null){",!
	Write "			ChooseKontragent.selectedIndex=0;",!
	Write "			return false;}",!
	Write "		var ChooseKontragentLength = ChooseKontragent.options.length;",!
	Write "		ChooseKontragent.options.length= ChooseKontragentLength + 1;",!
	Write "		ChooseKontragent.options(ChooseKontragentLength).value=newKontragent.split(""~"")[0];",!
	Write "		ChooseKontragent.options(ChooseKontragentLength).text=newKontragent.split(""~"")[1];",!
	Write "		ChooseKontragent.selectedIndex=ChooseKontragentLength;",!
	Write "	}",!
	Write "}",!
	Write !,"function FillInstrReminder()",!
	Write "{",!
	Write "	var count = "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Operation.InstrActions.GetInstrReminderText:csp.chief"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',1);",!
	Write "	if (count==0)return;",!
	Write "	var str = "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Operation.InstrActions.GetInstrReminderText:csp.chief"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"');",!
	Write "	if (str != """")",!
	Write "	{",!
	Write "		InstrReminder.innerHTML = ""<p style='color:#de1111'>Внимание! Некоторые инструкции не укомплектованы или не завершены более "_($G(DaysCount))_" дней:</p>""",!
	Write "		+	str ",!
	Write "		+ ""<br><input type='button' style='width:300px' value='проверить пропущенные заявки' onclick='FillInstrReminder();'>"";",!
	Write "	}",!
	Write "}",!
	Write !,"//сервис менеджер отвечает на негативный отзыв контрагента",!
	Write "function SetInstrField(DocId,Field,Description,SuccessMessage)",!
	Write "{",!
	Write "	var Answer = window.prompt(Description,"""");	",!
	Write "	if (Answer==null) return;",!
	Write "	ok = "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("csp.chief.WriteInstrField:csp.chief"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',DocId,Answer,Field)",!
	Write "	if (isNaN(ok)){alert(ok);}",!
	Write "	else{alert(SuccessMessage);}",!
	Write "}",!
	Write !,"//указанное поле документа в отдельном окне",!
	Write "function ShowFieldFn(DocId,Class,PropertyName)",!
	Write "{",!
	Write "	window.showModalDialog(""Info.csp?docid=""+DocId+""&class=""+Class+""&property=""+PropertyName,"""",""center:yes;status:no;dialogHeight:450px;dialogWidth:600px;resizable:yes;"");",!
	Write "}",!
	Write !,"function RefuseInstr(InstrId)",!
	Write "{",!
	Write "	if(!window.confirm(""Отклонить заявку "" + instr.ItemName + "" ?""))return;",!
	Write "	changestat('8.6');",!
	Write "}",!
	Write "</script>"
	Write !,"<script language=""VBScript"">"
	Write !,"Sub OpenExcel(docid)",!
	Write "if docid="""" then Exit Sub",!
	Write "dim objXML,objExcel",!
	Write "set objXML = CreateObject(""Msxml2.DOMDocument.3.0"")",!
	Write "objXML.async = false",!
	Write "objXML.validateOnParse = false",!
	Write "If objXML.parseError.errorCode <> 0 Then msgbox(""Ошибка анализа XML"" & vbCr & objXML.parseError.reason)",!
	Write "res=objXML.load(""screen/ChiefPlanXml.csp?docid=""&docid)",!
	Write "If objXML.parseError.errorCode <> 0 Then",!
	Write "	msgbox(""Ошибка XML"" & vbCr & objXML.parseError.reason)",!
	Write "	Exit Sub",!
	Write "End If",!
	Write "'if(xmlobj.selectSingleNode(""root/comment"")!=null){",!
	Write "'	var xmlcomment=xmlobj.selectSingleNode(""root/comment"").text;",!
	Write "'	if(xmlcomment!="""")alert(xmlcomment)}",!
	Write !,"Set objExcel = CreateObject(""Excel.Application"")",!
	Write "objExcel.Visible = True",!
	Write "Set objWorkbook = objExcel.Workbooks.Add",!
	Write "'SheetsCount=objWorkbook.Sheets.Count",!
	Write !,"set oNodeList = objXML.selectNodes(""//AllObjects/*"")",!
	Write "For i=0 To (oNodeList.length-1)",!
	Write "	CurrentSheetNumber = (i+1)",!
	Write "	if i>(objWorkbook.Sheets.Count-1) Then ",!
	Write "		objWorkbook.Sheets.Add",!
	Write "		CurrentSheetNumber = 3",!
	Write "	end if",!
	Write "	Set objWorksheet = objWorkbook.Worksheets(CurrentSheetNumber)",!
	Write "	set currentobj=oNodeList.item(i)",!
	Write "	ModelName = currentobj.selectSingleNode(""Model/Name"").text",!
	Write "	ModelCode = currentobj.selectSingleNode(""Model/Code"").text",!
	Write "	objWorksheet.Name = ModelCode",!
	Write "	objExcel.Workbooks(1).Sheets(CurrentSheetNumber).Select",!
	Write "	objWorksheet.Cells(1, 2).Value = ModelCode & "" "" & ModelName",!
	Write "	set Parts = currentobj.selectNodes(""Parts/*"")",!
	Write "	For z=0 To (Parts.length-1)",!
	Write "		set currentpart = Parts.item(z)",!
	Write "		objWorksheet.Cells((z+3), 1).Value = currentpart.selectSingleNode(""Number"").getAttribute(""Text"")",!
	Write "		objWorksheet.Cells((z+3), 2).Value = currentpart.selectSingleNode(""Name"").getAttribute(""Text"")",!
	Write "		objWorksheet.Cells((z+3), 3).Value = currentpart.selectSingleNode(""Pos"").getAttribute(""Text"")",!
	Write "		objWorksheet.Cells((z+3), 4).Value = currentpart.selectSingleNode(""Quantity"").getAttribute(""Text"")",!
	Write "	Next",!
	Write "	objWorksheet.Columns(""A:A"").ColumnWidth = 8.43",!
	Write "	objWorksheet.Columns(""B:B"").ColumnWidth = 35.71",!
	Write "	objWorksheet.Columns(""C:C"").ColumnWidth = 22.29",!
	Write "	objWorksheet.Columns(""D:D"").ColumnWidth = 15.29",!
	Write "	zRange=""A2:D""&(z+2)",!
	Write "	objWorksheet.Range(zRange).Select",!
	Write "	for z=7 To 12",!
	Write "		objExcel.Selection.Borders(z).Weight = 2",!
	Write "	Next",!
	Write "	objWorksheet.Cells(2, 1).Value = ""No""",!
	Write "	objWorksheet.Cells(2, 2).Value = ""Part name""",!
	Write "	objWorksheet.Cells(2, 3).Value = ""№""",!
	Write "	objWorksheet.Cells(2, 4).Value = ""Quantity""",!
	Write "	objWorksheet.Range(""A1:D2"").Select",!
	Write "	objExcel.Selection.Font.Size=14",!
	Write "	objExcel.Selection.Font.Bold = True",!
	Write "Next",!
	Write "End Sub",!
	Write "</script>"
	Write !,(..HyperEventHead())
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLADList XMLNS:SKLADiGrid>"
	Write !,"<IMPORT NAMESPACE=""SKLADiGrid"" IMPLEMENTATION=""htc/iGridV7.htc"">",!
	Write "<IMPORT NAMESPACE=""SKLADList"" IMPLEMENTATION=""htc/listview2.htc"">",!
	Do ..OnPageHEAD()
	Write !
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  s DaysCount = $$$TunesVariableGlobal("ShowInstrReminder")
  s login=$G(%session.Data("user"))
  i '+login s %response.ServerSideRedirect="norights.csp" 
  i '##class(Common.Rights).getrights(login,2) s %response.ServerSideRedirect="norights.csp" 
  q 1
 
]]></Implementation>
</Method>

<Method name="WriteInstrField">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec>ID:%String,Answer:%String,Field</FormalSpec>
<Language>cache</Language>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  if ID="" q "Не указана инструкция."
  s obj = ##class(Operation.Instructions).%OpenId(ID)
  if '$ISOBJECT(obj) q "Невозможно найти инструкцию "_ID
  if (Field="BrakCommentAnswer")
  {
 	 s obj.BrakCommentAnswer = Answer
 	 d:+$G(%session.Data("user")) obj.BrakCommentAnswerUserSetObjectId(%session.Data("user"))
 	 s obj.BrakCommentAnswerDat = +$H
  }
  if (Field="RefuseReason")
  {
 	 s obj.RefuseReason = Answer
 	 d:+$G(%session.Data("user")) obj.RefuseReasonUserSetObjectId(%session.Data("user"))
 	 s obj.RefuseReasonDat = +$H
  }
  s ok=obj.%Save()
  if ok q 1
  else  q "Извините. Ошибка при сохранении ответа."
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\chief.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/chief.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62187,47166</Default>
</Parameter>
</Class>
</Export>
