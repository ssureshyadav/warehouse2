<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.savegoodsfromfile">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62013,62955.27051</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""LoadTree();"">"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""window.location.href='tuneup.csp'"" TITLE=""""><center>Назад</center></span>"
	Write "<br>",!
	Write "<TABLE cellSpacing=0 width=""100%"" celpadding=""0"" >",!
	Write "<TR>",!
	Write "<TD align=center style=""BACKGROUND: rgb(233,243,255); FONT-size: 18px ; font-family: arial; COLOR: rgb(0,0,102); BORDER-BOTTOM: rgb(0,0,102) 1px solid"" colspan=3><strong>Создание товаров на основании текстового файла</strong></TD></tr>",!
	Write "<tr>",!
	Write "</table>",!
	Write !
	s GroupId = %request.Get("GroupId")
	Write !,!
	If '(GroupId="") Goto %csp00001 ;{
	Write !,"<table>",!
	Write "<tr><td valign=""top"">",!
	Write "	<font face=""Arial"" size=+1 color=""darkblue""><br><font size=+2>1</font> Выберете группу в которую запишутся новые товары</font>",!
	Write "		<br><br>",!
	Write "		Классификатор:"
	Write "<select id=""Catalogues"" onchange=""LoadTree()"">"
	Write !,"		"
	w ##class(Docs.Action2).GetClassValuesOptions(,"Goods.Catalogue",,,0)
	Write !,"		"
	Write "</select>"
	Write "<br>",!
	Write "		<SKLADz:treeview id=""GroupsTree"" width=""300"" height=""350"" ImagesPath="""_(%session.Data("ImagesPath"))_""" />",!
	Write "	</td>",!
	Write "	"
	Write "<form enctype=""multipart/form-data"" method=""post"" id=""MyForm"">"
	Write !,..InsertHiddenFields(""),!
	Write !,"	<td valign=""top"" align=""middle"" style=""border-left:1 solid black"">",!
	Write "		<font face=""Arial"" size=+1 color=""darkblue""><br><font size=+2>2</font> Укажите файл с новыми товарами</font>",!
	Write "		<br><br><br><br><br><br><br><br>",!
	Write "		<p align=""left"">Файл с данными товаров: </p>",!
	Write "		"
	Write "<input name=""oFile1"" id=""oFile1"" size=30 type=file style=""width:300px"">"
	Write !,"		<br><br>",!
	Write "		"
	Write "<a href=""#"" onclick=""ShowHideFormatHelp()"">"
	Write "формат файла"
	Write "</a>"
	Write !,"		<P id=""HelpSpan"" align=""left"" style=""display:none;"">",!
	Write "		<br><br>",!
	Write "		Каждый товар должен быть записан отдельной строкой.<br>",!
	Write "		Первым должно идти наименование товара.<br>",!
	Write "		После символа табуляции должна быть записана аббревиатура и номер модели через тире (например SC - 489).<br>",!
	Write "		После следующего символа табуляции может быть записана цена товара в рублях.",!
	Write "		<br><br>",!
	Write "		Ниже приведён пример содержания файла с новыми товарами. Знаком &#60;TAB&#62; обозначен символ табуляции.<br>",!
	Write "		"
	Write "<span style=""border:solid 1 black"">"
	Write !,"		Часы&#60;TAB&#62;SC - 09B&#60;TAB&#62;195<br>",!
	Write "		Часы&#60;TAB&#62;SC - 09D&#60;TAB&#62;195<br>",!
	Write "		Часы&#60;TAB&#62;SC - 16D&#60;TAB&#62;195<br>",!
	Write "		"
	Write "</span>"
	Write !,"		",!
	Write "		</P>",!
	Write "	</td>",!
	Write "	<td valign=""top"" align=""middle"" style=""border-left:1 solid black"">",!
	Write "		<font face=""Arial"" size=+1 color=""darkblue""><br><font size=+2>3</font> Нажмите кнопку ""Загрузить""</font>",!
	Write "		<br><br><br><br><br><br><br><br>",!
	Write "		<center>"
	Write !,"<span class=ButtonDiv ID=""LoadButton"" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""LoadGoods()"" TITLE=""""><center>Загрузить</center></span>"
	Write "</center>",!
	Write "	</td>",!
	Write "	"
	Write "<input name=""GroupId"" id=""GroupId"" type=""hidden"">"
	Write !,"	"
	Write "</form>"
	Write !,"</tr>",!
	Write "<table>",!
	Goto %csp00002 ;}
%csp00001	;{
	Write !,"<br><br>",!
	Write "<font face=""Arial"" size=+1 color=""darkblue"">",!
	d:%request.ContentType="multipart/form-data"
	. if '+$G(GroupId) w "Ошибка. Не указана товарная группа в которую необходимо загрузить товары. Необходимо повторить загрузку товаров." q
	. s grObj=##class(Goods.Group).%OpenId(GroupId)
	. if '$ISOBJECT(grObj) w "ВНИМАНИЕ! Указана несуществующая товарная группа. Необходимо повторить загрузку товаров." q
	. s obj=%request.MimeData("oFile1",1)
	. q:'$ISOBJECT(obj)
	. s filename=$J_$P(obj.FileName,"\",$L(obj.FileName,"\"))
	. s fileObj=##class(%File).%New(filename)
	. Do fileObj.Open("WSN")
	. d fileObj.CopyFrom(obj)
	. s ok=fileObj.%Save()
	. if 'ok w "Извините. Ошибка сохранения файла "_obj.FileName_". Попробуйте уменьшить файл и повторить загрузку товаров."  q
	. k fileObj
	. s ok=$$ProcessFile^ReadGoodsFromFile(filename,GroupId)
	. if 'ok w ok
	. else  w "Новые товары успешно загружены в группу "_grObj.Name_"<br>"
	. s ok=##class(%File).Delete(filename)
	. if '+ok w " Не удалось удалить временный файл "_filename_"<br>"
	Write !,"</font>",!
%csp00002	;}
	Write !,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !,!
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<script language=""Jscript"" src=""common.js"">"
	Write "</script>"
	Write !,!,"<script language=""javascript"">"
	Write !,"var depot="""_($G(%session.Data("depot")))_"""",!
	Write !,"// показать дерево групп",!
	Write "function LoadTree(){",!
	Write "	if(typeof(Catalogues) == ""object"")",!
	Write "	{",!
	Write "		GroupsTree.AdditionalID=Catalogues.value;",!
	Write "		GroupsTree.DownLoad('Data.csp?class=Goods.Group&fields=Parent,Code,Name,ID&params=""'+depot+'"",""'+Catalogues.value+'""')	",!
	Write "	}",!
	Write "}",!
	Write !,"// загрузить товары из файла в базу",!
	Write "function LoadGoods(){",!
	Write "var Group=ReturnSpace(GroupsTree.NodeID);",!
	Write "if(Group==""""){alert(""Укажите пожалуйста группу, в которую необходимо записать новые товары."");return false;}",!
	Write "if(document.all.oFile1.value.length<2){alert(""Укажите, пожалуйста, файл с новыми товарами."");return false;}",!
	Write "document.all.GroupId.value = Group;",!
	Write "LoadButton.style.display=""none"";",!
	Write "MyForm.submit();",!
	Write "}",!
	Write !,"//скрыть показать справку по формату файла",!
	Write "function ShowHideFormatHelp() ",!
	Write "{",!
	Write "	if(HelpSpan.style.display==""none""){HelpSpan.style.display=""block""}",!
	Write "	else{HelpSpan.style.display=""none""}",!
	Write "}",!
	Write "</script>"
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLADz>"
	Write !,!,"<IMPORT NAMESPACE=""SKLADz"" IMPLEMENTATION=""htc/treeview.htc"">",!
	Do ..OnPageHEAD()
	Write !,!
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  i %session.NewSession d
  . s %session.EndSession=1
  . s sessionid=%request.Get("sessionid",1)
  . s %session=%session.GetSession(sessionid)
  e  s sessionid=%session.SessionId
  s login=$G(%session.Data("user"))
  i '+login s %response.ServerSideRedirect="norights.csp" 
  s Access9func=##class(Common.Rights).getrights($G(login,0),9)
  if 'Access9func s Func9Refuse="return;"
 Quit 1
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\SaveGoodsFromFile.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/SaveGoodsFromFile.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>61672,85016</Default>
</Parameter>
</Class>
</Export>
