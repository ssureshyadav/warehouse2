<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.changegoods">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>61390,43760.192018</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onkeypress=""ManageWindow();"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !,"<form name=""forma"" id=""forma"">"
	Write !,..InsertHiddenFields(""),!
	Write !
	n ID,GoodsFullName,Quantity,i,GoodsId,DocObj
	s DocId=%request.Get("DocId")
	s DocObj=##class(Docs.Rash).%OpenId(DocId)
	if '$ISOBJECT(DocObj) w "<P align=center style='font-size:14pt'><b>Ошибка</b> Невозможно извлечь информацию о документе "_DocId_"</p>" q
	s Name=DocObj.Name
	s KontrName=$S($ISOBJECT(DocObj.Kontr):DocObj.Kontr.Name,1:"")
	s Dat=$ZD(DocObj.Dat,4)
	s Tim=$ZT(DocObj.Tim)
	s DocStat=DocObj.Stat
	if DocStat=2 w "<P align=center style='font-size:14pt'><b>Внимание!</b> Документ уже закрыт. Замена товара невозможна</p>"
	&html<
	<table border=0 class=TABLE style="width:0" cellspacing=0>
	<tr><td class=TD>Номер<td class=TD>#(Name)#
	<tr><td class=TD>Контрагент<td class=TD>#(KontrName)#
	<tr><td class=TD>Дата<td class=TD>#(Dat)#
	<tr><td class=TD>Время<td class=TD>#(Tim)#
	</table>
	<Br>
	>
	s glob=$NA(^mtempTempGlob($I))
	k @glob
	w "<table width=100% class=TABLE cellspacing=0>"
	w "<tr><td class=TD>Исходный товар<td class=TD>Требуемое<br>количество<td class=TD>Количество<br>на складе<td class=TD>Замена"
	&sql(
	declare dfg cursor for 
	select ID,Goods->FullName,Quantity,Goods
	into :ID,:GoodsFullName,:Quantity,:GoodsId
	from Docs.DocItems 
	where Doc=:DocId
	)
	&sql(open dfg)
	f  &sql(fetch dfg) q:SQLCODE  d
	. s count=$I(count)
	. s @glob@(count,"GoodsFullName")=GoodsFullName
	. s @glob@(count,"Quantity")=Quantity
	. s @glob@(count,"ID")=ID
	. s Store=0
	. s ok=##class(Store.Action).GetQuantByGoods(ID,.Store)
	. s @glob@(count,"Store")=Store
	. s @glob@(count,"GoodsId")=GoodsId
	&sql(close dfg)
	s i="" f  s i=$O(@glob@(i)) q:i=""  d
	. w "<tr>"
	. w "<td valign=top class=TD>"_$G(@glob@(i,"GoodsFullName"))     //имя оригинального товара
	. w "<td valign=top class=TD>"_$G(@glob@(i,"Quantity"))          //заказанное количество
	. w "<td valign=top class=TD>"_@glob@(i,"Store")                    //имеющееся количество на складе
	. s GoodsId=@glob@(i,"GoodsId")
	. s ID=@glob@(i,"ID")
	. s InputElementName="Goods"_ID
	. s InputElementId="InputElemId"_ID
	. w "<td style='padding:5' class=TD>"     //имеющиеся замены
	. w "<table class=TABLE cellspacing=0><tr style='color:gray'><td width=100% class=TD>Замена<td class=TD>Количество<br>на складе"
	. w "<tr>"
	. w "<td class=TD><input type=radio name='"_InputElementName_"' id='"_InputElementId_"' CHECKED value='0'><span style='cursor:hand' onclick='"_InputElementId_".checked=true'>Без замены</span><br>"
	. w "<td class=TD>&nbsp;"
	. &sql(declare gok cursor for select ID,Property6625,Property6625->FullName into :ZamenaID,:Property6625,:FullName from Common.Dictionary4 where Name=:GoodsId)
	. &sql(open gok)
	. f  &sql(fetch gok) q:SQLCODE  d
	. . s InputElementId="InputElemId"_ZamenaID_ID
	. . w "<tr>"
	. . w "<td class=TD><input type=radio name='"_InputElementName_"' id='"_InputElementId_"' value='"_Property6625_"' Tag='"_ID_"'><span style='cursor:hand' onclick='"_InputElementId_".checked=true'>"_FullName_"</span><br>"
	. . k Store 
	. . s ok=##class(Store.Action).GetQuantByGoods(ID,.Store)
	. . w "<td class=TD>"_+$G(Store)
	. w "</table>"
	. &sql(close gok)
	. w "</tr>",!
	Write !,"</table>",!
	Write "</form>"
	Write !,!
	If '(DocStat=2) Goto %csp00001 ;{
	Write !,"<center><br>"
	Write !,"<span class=ButtonDiv style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""windowclose();"" ><center>Отмена</center></span>"
	Write "</center>",!
	Goto %csp00002 ;}
%csp00001	;{
	Write !,"<center><br>"
	Write !,"<span class=ButtonDiv style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""startFun();"" ><center>Заменить</center></span>"
	Write !,"<span class=ButtonDiv style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""windowclose();"" ><center>Отмена</center></span>"
	Write "</center>",!
%csp00002	;}
	Write !,!,!,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	d:%session.NewSession 
	. s %session.EndSession=1
	. s ses=%request.Get("sessionid",1)
	. s %session=%session.GetSession(ses)
	Write !
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<title>     "_($G(%session.Data("systemname")))_" </title>",!
	Write "<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<script language=""Jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<style>"
	Write !,"input{border:0;width:20px}",!
	Write ".TD { border-right:1 solid black;border-bottom:1 solid black }",!
	Write ".TABLE { border-left:1 solid black;border-top:1 solid black;width:100% }",!
	Write "</style>"
	Write !,"<script language=""Jscript"">"
	Write !,"function startFun(){",!
	Write "var ItogString="""";",!
	Write "for(var i=0;i<document.forms[0].elements.length; i++){",!
	Write "     var CurrentElement=document.forms[0].elements[i]",!
	Write "     var CurrentElementValue=CurrentElement.value;",!
	Write "     var CurrentElementTag=CurrentElement.Tag;",!
	Write "     if((CurrentElement.checked)&&(CurrentElementValue!=0))ItogString=ItogString+CurrentElementTag+""=""+CurrentElementValue+"";""",!
	Write "}",!
	Write "if(ItogString==""""){alert(""Ничего не выбрано для замены."");return}",!
	Write "if(window.confirm(""Заменить указанные товары?"")){",!
	Write "     var ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.ChangeGoodsInDoc:csp.changegoods"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',ItogString);",!
	Write "     if(isNaN(ok)){alert(ok)}",!
	Write "     else{",!
	Write "          alert(""Товары успешно заменены."");",!
	Write "          window.returnValue=true;",!
	Write "          window.close();",!
	Write "          }",!
	Write "     }",!
	Write "}",!
	Write "</script>"
	Write !,(..HyperEventHead())
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html>"
	Write !
	Do ..OnPageHEAD()
	Write !,!
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\ChangeGoods.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/ChangeGoods.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>60836,54860</Default>
</Parameter>
</Class>
</Export>
