<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.showgoodsimages">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62194,38319.062724</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onclick=""menu1.style.display='none'"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !
	s gid=%request.Get("GoodsId")
	q:gid=""
	s gobj=##class(Goods.Goods).%OpenId(gid)
	s images=gobj.Images
	w "<center><font size=+2>"_gobj.Name_"</font></center>"
	&html<
	<form enctype="multipart/form-data" method="post" onsubmit="return(myOnSubmitEventHandler());">
	<input type="hidden" name="GoodsId" value="#(gid)#" >
	Добавить изображение товара<br>
	<input name="oFile1" id="oFile1" size=30 type=file >
	<input type="submit" value="ок"><br>
	Сжимать картинку до размера 800px по широкой стороне <input type="checkbox" name="resize" value="1">
	</form>
	>
	d
	. f i=1:1:$L(images,"\") d
	. . s currentimg=$P(images,"\",i)
	. . d:$L(currentimg)>2 
	. . . w "<img src=""images/del.gif"" style='cursor:hand' onmouseover=""this.src='images/Ondel.gif'"" onmouseout=""this.src='images/del.gif'""  id=""delbut"_i_""" alt=""Удалить"" onclick=""delimg('/"_currentimg_"')"">"
	. . . w "<img src=""images/print.gif"" style='cursor:hand' onmouseover=""this.src='images/Onprint.gif'"" onmouseout=""this.src='images/print.gif'""  id=""printbut"_i_""" alt=""Печать"" onclick=""printimg('/"_currentimg_"')"">"
	. . . w "<img src=""GoodsImages/"_currentimg_""" ><hr width=80%>"
	Write !,"<div id=menu1 onclick=""clickMenu()"" onmouseover=""switchMenu()"" onmouseout=""switchMenu()"" style=""position:absolute;display:none;width:100;background-Color:menu; border: outset 3px gray"">"
	Write !,"<div class=""menuItem"" id=pri>"
	Write "Печать"
	Write "</div>"
	Write !,"<div class=""menuItem"" id=del>"
	Write "Удалить"
	Write "</div>"
	Write !,"<div class=""menuItem"" id=doel>"
	Write "</div>"
	Write !,!,"</div>"
	Write !,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !
	//<csp:CLASS SUPER="%CSP.Page,csp.super">
	s goodsid=%request.Get("GoodsId")
	//s f=..cspfile()
	s joiu=$TR($G(f),"\","?")
	d:%request.ContentType="multipart/form-data"
	. s obj=$G(%request.MimeData("oFile1",1))
	. q:'$ISOBJECT(obj)
	. //s f=$P(f,"\",1,$L(f,"\")-1)_"\GoodsImages\"
	. s f=$P($ZU(86),"\",1,$L($ZU(86),"\")-1)_"\CSP\sklad2\GoodsImages\"
	. s filename=goodsid_$P(obj.FileName,"\",$L(obj.FileName,"\"))
	. s filepath=f_filename
	. s file=##class(%File).%New(filepath)
	. Do file.Open("WSN")
	. d file.CopyFrom(obj)
	. s ok=file.%Save()
	. i '+ok d
	. . Do DecomposeStatus^%apiOBJ(ok,.Err)
	. . s ^Errors($H,"err")=Err(Err)
	. e  d
	. . d ##class(Common.Common).SaveGoodsImage(goodsid,filename)
	. . s d="window.close();"
	. . d file.Close()
	. . s cmd = "c:\progra~1\IrfanView\i_view32.exe "_filepath_" /resize_long=800 /aspectratio /resample /convert="_filename
	. . if %request.Get("resize") d $ZF(-1,cmd)
	. . //d $ZF(-1,cmd)
	Write !
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<title>"_($G(%session.Data("systemname")))_"</title>",!
	Write "<script language=""Jscript"">"
	Write !,($G(d)),!
	Write "function myOnSubmitEventHandler(){",!
	Write " if(document.all.oFile1.value.length<2)return false",!
	Write " return true",!
	Write "}",!
	Write !,"function prnt(){",!
	Write "window.print();",!
	Write "}",!
	Write !,"function displayMenu(dd) {",!
	Write "currentimg=dd.src;",!
	Write "doel.innerText=event.y+""|""+event.screenY+""|""+event.offsetY+""|""+event.clientY+""|""+event.clientTop;",!
	Write "   whichDiv=event.srcElement;",!
	Write "   menu1.style.posLeft=event.clientX;",!
	Write "   menu1.style.posTop=event.offsetY;",!
	Write "   alert(""ntgtm pxelpot"")",!
	Write "   menu1.style.pixelTop=event.y;",!
	Write "   menu1.style.display="""";",!
	Write "   menu1.setCapture();",!
	Write "}",!
	Write !,"function switchMenu() {   ",!
	Write "   el=event.srcElement;",!
	Write "   if (el.className==""menuItem"") {",!
	Write "      el.className=""highlightItem"";",!
	Write "   } else if (el.className==""highlightItem"") {",!
	Write "      el.className=""menuItem"";",!
	Write "   }",!
	Write "}",!
	Write !,"function clickMenu() {",!
	Write "   menu1.releaseCapture();",!
	Write "   menu1.style.display=""none"";",!
	Write "   el=event.srcElement;",!
	Write "   if (el.id==""pri"") {",!
	Write "      prnt();",!
	Write "   } else if (el.id==""del"") {",!
	Write "		delimg(currentimg);",!
	Write "   }",!
	Write "}",!
	Write !,"function delimg(curimg){",!
	Write "ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Goods.GoodsAction.delimg:csp.showgoodsimages"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',"""_(goodsid)_""",curimg,"""_(joiu)_""")",!
	Write "if(isNaN(ok))alert(ok);",!
	Write "else{window.close();}",!
	Write "}",!
	Write !,"function printimg(curimg){",!
	Write "window.open(""PrintImage.csp?ImageSrc=GoodsImages""+curimg);",!
	Write "}",!
	Write "</script>"
	Write !,"<STYLE>"
	Write !,".menuItem {font-family:sans-serif;font-size:10pt;width:100;padding-left:20;",!
	Write "   background-Color:menu;color:black}",!
	Write ".highlightItem {font-family:sans-serif;font-size:10pt;width:100;padding-left:20;",!
	Write "   background-Color:highlight;color:white}",!
	Write "</STYLE>"
	Write !,(..HyperEventHead())
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html>"
	Write !
	Do ..OnPageHEAD()
	Write !
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\showgoodsimages.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/showgoodsimages.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62133,58856</Default>
</Parameter>
</Class>
</Export>
