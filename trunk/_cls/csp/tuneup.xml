<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.tuneup">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62301,49213.055942</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onkeypress=""Replace126(this)"" onload=""load();"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !,"<TABLE cellSpacing=0 width=""100%"" celpadding=""0"" >",!
	Write "<TR>",!
	Write "<td width=10%>"
	Write "<img alt=""Обновить раздел"" src=""images/refresh.gif"" onclick=""window.location.reload()"">"
	Write "</td>",!
	Write "<TD width=80% align=center style=""BACKGROUND: rgb(233,243,255); FONT-size: 18px ; font-family: arial; COLOR: rgb(0,0,102); BORDER-BOTTOM: rgb(0,0,102) 1px solid"" colspan=2><strong>Настройки</strong></TD>",!
	Write "<td width=10% align=right>&nbsp;</td>",!
	Write "</TABLE>",!
	Write "<br>",!
	Write "<form name=""Tunes"" method=""post"">"
	Write !,..InsertHiddenFields(""),!
	Write !
	If '(ok=1) Goto %csp00001 ;{
	Write !,"<fieldset><legend>Настройка пользователей:</legend>",!
	Write !,"<span class=ButtonDiv ID=""users"" style=""cursor:hand;width:150px;height:40px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""loadUsers()"" TITLE=""Настройка пользователей""><center>Пользователи</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px;height:40px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""location.href='LogJournal.csp'"" TITLE=""""><center>Журнал доступа</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px;height:40px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""location.href='SendMailJournal.csp'"" TITLE=""""><center>Журнал автоматических уведомлений</center></span>"
	Write !,"</fieldset>",!
%csp00001	;}
	Write !,"<fieldset><legend>Управление</legend>",!
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""recalccells()"" TITLE=""""><center>Пересчитать объемы ячеек</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""location.href='ShowDoubleGoods.csp'"" TITLE=""""><center>Товары дубликаты</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;height:42px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""location.href='Synchronization.csp'"" TITLE=""""><center>Синхронизация</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""location.href='CreateAnalogs.csp'"" TITLE=""""><center>Управление аналогами</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""location.href='Reports.csp'"" TITLE=""""><center>Принятые отчёты</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""location.href='ArchiveBase.csp'"" TITLE=""""><center>Просмотр архивных баз</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""location.href='NegativeQnt.csp'"" TITLE=""""><center>Отрицательные остатки</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;height:42px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""location.href='Operations2.csp'"" TITLE=""""><center>Операции</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""location.href='CheckRemontPrices.csp'"" TITLE=""""><center>Проверка цен на ремонт</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""location.href='SaveGoodsFromFile.csp'"" TITLE=""""><center>Загрузка товаров из текстового документа</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""location.href='RequestsLog.csp'"" TITLE=""""><center>Журнал доступа региональных СЦ</center></span>"
	Write !,!,"<span class=ButtonDiv ID=""btnExportImages"" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""ExportImages()"" TITLE=""Выгрузить изображения товаров в указанную папку на сервере""><center>Экспорт изображений</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""CheckActs()"" TITLE=""Открыть страницу проверки актов""><center>Проверка актов</center></span>"
	Write !,"</fieldset>",!
	Write "<br>",!
	Write !
	s Tunes=$NA(^Tunes)
	s i="" f  s i=$O(%request.Data(i)) q:i=""  d
	. s where=+$G(@Tunes@(0,i))
	. s value=%request.Data(i,1)
	. s @Tunes@(where,i,"Value")=value
	. if i="innerkurs" &sql(update Store.Measures set Factor=:value where id=8)
	s Tunes=$NA(^Tunes)
	s boo="" f  s boo=$O(@Tunes@(boo)) q:boo=""  d
	. q:'+boo
	. w "<fieldset width=100%><legend>"_$G(@Tunes@(boo))_"</legend><table>"
	. s i="" f  s i=$O(@Tunes@(boo,i)) q:i=""  d
	. . s CurrentValue=$G(@Tunes@(boo,i,"Value"))
	. . w "<tr><td>"_@Tunes@(boo,i,"Caption")_"</td>"
	. . w "<td>&nbsp;&nbsp;&nbsp;</td>"
	. . w "<td>"
	. . s str="<input type=""text"" value="""_CurrentValue_""" name="""_i_""" >"
	. . d:(i="DefaultPoluh")
	. . . s str="<select name=""DefaultPoluh"" id=""ChooseKontragent"" onchange=""ChooseKontragentFunc()"">"
	. . . s str=str_"<option value=""0""> </option>"
	. . . s str=str_"<option value=""choose"">Выбрать контрагента...</option>"
	. . . i CurrentValue d
	. . . . &sql(select Name into :Name from Common.Kontragent where ID=:CurrentValue)
	. . . . s:'SQLCODE str=str_"<option value="""_CurrentValue_""" SELECTED>"_Name_"</option>"
	. . . s str=str_"</select>"
	. . d:(i="DefaultPlatejType")
	. . . s str="<select name=""DefaultPlatejType"">"
	. . . s str=str_##class(Docs.Action2).GetClassValuesOptions($G(CurrentValue),"Common.Dictionary13")
	. . . s str=str_"</select>"
	. . d:$D(^Tunes("COMBOBOX",i))
	. . . s yes=$S(CurrentValue="1":"SELECTED",1:"")
	. . . s no=$S(CurrentValue="0":"SELECTED",1:"")
	. . . s str="<select name="""_i_"""><option value=""1"" "_yes_">Да<option value=""0"" "_no_">Нет</select>"
	. . d:(i="garant")
	. . . s perepis=$S(CurrentValue="perepis":"SELECTED",1:"")
	. . . s skip=$S(CurrentValue="skip":"SELECTED",1:"")
	. . . s str="<select name="""_i_"""><option value=""perepis"" "_perepis_">Переписать последний ремонт<option value=""skip"" "_skip_">Не записывать</select>"
	. . d:(i="NotifyText")
	. . . s str="<textarea name="""_i_""" ondblclick='ShowBigTextWindow(this)'>"_CurrentValue_"</textarea>"
	. . //d:(i="AutoTemplate")
	. . //. s str="<select id=""AutoTemplate"" name=""AutoTemplate"" style=""behavior:url('#default#download');""></select>"
	. . w str,!
	. . i i="peresch" w "<SKLAD2:table id=""measures"" width=260 ClassName=""Docs.waste"" onPropChange=""chcurrency()""/>"
	. . w "</td></tr>"
	. w "</table></fieldset><Br>"
	Write !,"<br>",!
	Write "<center>"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""Tunes.submit()"" TITLE=""""><center>Сохранить изменения</center></span>"
	Write "</center>",!
	Write "</form>"
	Write !,"<a href=""MainRequest.htm"" target=_blank>"
	Write "Основные требования к системе"
	Write "</a>"
	Write !,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !
	s user=%session.Data("user")
	s ok=##class(Common.Rights).getrights(user,6)
	Write !,!
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<style>"
	Write !,"input{border:solid 1 grey;width:350px}",!
	Write "textarea{border:solid 1 grey;width:350px;}",!
	Write "</style>"
	Write !,"<script language=""Jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<script language=""jscript"">"
	Write !,"var ExportImagesTimerID="""";",!
	Write "var ExportImagesProcessNumber="""";",!
	Write "var ExportImagesRunning = false;",!
	Write !,"function loadUsers(){",!
	Write "window.location.href='selectUsers.csp';",!
	Write "}",!
	Write !,"function recalccells(){",!
	Write "ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Store.Action.recalcstore:csp.tuneup"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"')",!
	Write "if(ok==1){alert(""Объемы ячеек успешно пересчитаны"")}",!
	Write "else{alert(""Извините, при пересчете ячеек произошла внутренняя ошибка"")}",!
	Write "}",!
	Write !,"function load(){",!
	Write "measures.DownLoadPairs("""","""",""DocumentClass"");",!
	Write "//AutoTemplate.startDownload('Data.csp?class=Common.Dictionary14&fields=Property3212,Name', LoadTemplatesItems);",!
	Write "}",!
	Write !,"function LoadTemplatesItems(text){",!
	Write "addOptions(text,""AutoTemplate"");",!
	Write "}",!
	Write !,"function chcurrency(){",!
	Write "document.all.peresch.value=measures.item(""meas"");",!
	Write "}",!
	Write !,"function loadglobal(){",!
	Write "window.location.href='Globalreuse.csp';",!
	Write "	}",!
	Write !,"//открыть окно для редактирования текста",!
	Write "function ShowBigTextWindow(obj){",!
	Write "var newItem=window.showModalDialog(""widetext.csp"",obj.innerText,""center:yes;status:no;dialogHeight:300px;dialogWidth:400px;resizable:yes;"");",!
	Write "if(newItem!=null){obj.innerText=newItem;}",!
	Write "}",!
	Write !,"// Выбрать контрагента",!
	Write "function ChooseKontragentFunc(){",!
	Write "var ChooseKontragent=document.all.ChooseKontragent;",!
	Write "var UsersSelection=ChooseKontragent.options(ChooseKontragent.selectedIndex).value;",!
	Write "if(UsersSelection==""choose""){",!
	Write "	var newKontragent=window.showModalDialog(""Dictionary.csp"",""Common.Kontragent"",""center:yes;status:no;dialogHeight:400px;dialogWidth:650px;resizable:yes;"");",!
	Write "	if(newKontragent==null){",!
	Write "		ChooseKontragent.selectedIndex=0;",!
	Write "		return false;}",!
	Write "	if(ChooseKontragent.options.length==2){ChooseKontragent.options.length=3}",!
	Write "	ChooseKontragent.options(2).value=newKontragent.split(""~"")[0];",!
	Write "	ChooseKontragent.options(2).text=newKontragent.split(""~"")[1];",!
	Write "	ChooseKontragent.selectedIndex=2;",!
	Write "}",!
	Write "}",!
	Write !,"// Выгрузить изображения товаров",!
	Write "function ExportImages()",!
	Write "{",!
	Write "	if(ExportImagesRunning)",!
	Write "	{",!
	Write "		alert(""Экспорт изображений уже запущен. Пожалуйста подождите."");",!
	Write "		return;",!
	Write "	}",!
	Write "	var RootDir=window.prompt(""Введите путь к каталогу куда будут выгружены изображения товаров. Например c:\\Goods"",""c:\\Goods"");",!
	Write "	if(RootDir==null)return;",!
	Write "	var ExportForMO=window.confirm(""Экспортировать для Менеджера отчётов (иначе экспорт будет для обычного просмотра)"");",!
	Write "	ExportImagesProcessNumber="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Common.Common.ExportImages:csp.tuneup"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',RootDir,ExportForMO)",!
	Write "	//btnExportImages",!
	Write "	ExportImagesTimerID = window.setInterval(LookUpExportImages, 2000)",!
	Write "	btnExportImages.className=""ButtonDivWait"";",!
	Write "	ExportImagesRunning = true;",!
	Write "	//if(ok!=1){alert(ok);}",!
	Write "	//else{alert(""Все изображения товаров были выгружены на сервере в папку "" + RootDir);}",!
	Write "}",!
	Write !,"function LookUpExportImages()",!
	Write "{",!
	Write "	var answer="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Reports.Analyzis.NullOstatokForecastLookUp:csp.tuneup"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',"""",ExportImagesProcessNumber)",!
	Write "	if(answer=="""")",!
	Write "	{",!
	Write "		btnExportImages.innerText = ""Пожалуйста подождите...""",!
	Write "		btnExportImages.className=""ButtonDivWait"";",!
	Write "	}",!
	Write "	else",!
	Write "	{",!
	Write "		alert(""Экспорт завершён.\n"" +answer);",!
	Write "		window.clearInterval(ExportImagesTimerID);",!
	Write "		btnExportImages.className = ""ButtonDiv"";",!
	Write "		btnExportImages.innerText=""Экспорт изображений"";",!
	Write "		ExportImagesRunning = false;",!
	Write "	}",!
	Write "}",!
	Write !,"function CheckActs()",!
	Write "{",!
	Write "	window.open(""/csp/user/act.csp"");",!
	Write "}",!
	Write "</script>"
	Write !,(..HyperEventHead())
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLAD2>"
	Write !,"<IMPORT NAMESPACE=""SKLAD2"" IMPLEMENTATION=""htc/table.htc"" >",!
	Do ..OnPageHEAD()
	Write !
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  s login=$G(%session.Data("user"))
  i '+login s %response.ServerSideRedirect="norights.csp" 
  q 1
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\tuneup.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/tuneup.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>61843,10687</Default>
</Parameter>
</Class>
</Export>
