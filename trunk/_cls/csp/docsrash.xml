<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.docsrash">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62193,34770.125684</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""load()"" onkeypress=""ManageWindow();"">"
	Write !,"<table width=100%><tr><td>",!
	Write "<table class=""LeftTop"" cellspacing=0 width=100%>",!
	s DocId=%request.Get("source")
	i DocId {
	&sql(select Name,Comment,CloseDate,CloseTime,CloseUser->Name,Stat,Summa,Kontr,Kontr->Name,opl,OplatStatus,OplSumma,Platej,Platej->Name,RubSumma into 
Name,:Comment,:CloseDate,:CloseTime,:CloseUserName,:Stat,:Summa,:Kontr,:KontrName,:opl,:OplatStatus,:OplSumma,:Platej,:PlatejName,:RubSumma
	from Docs.Rash where ID=:DocId)
	i SQLCODE w "<tr><td colspan=4>Ошибка при выводе накладной "_DocId_"<br>SQLCODE="_SQLCODE_"</td></tr>"
	i Stat=2 d
	. s ClosedString=CloseUserName_" "_$S(CloseDate:$ZD(CloseDate,4),1:"")_" "_$S(CloseTime:$ZT(CloseTime),1:"")
	. s SaveButtonStyle="display:none"
	}
	w "<tr>"
	w "<td class=RightBottom>Номер<td class=RightBottom><input type=text id=Name MAXLENGTH=50 value='"_$G(Name)_"'>"
	w "<td class=RightBottom>Комментарий<td class=RightBottom><input type=text id=Comment MAXLENGTH=1000 Value='"_$G(Comment)_"'>"
	w "</tr>"
	w "<tr>"
	w "<td class=RightBottom>Контрагент<td class=RightBottom><span onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"" class=Kontragent onclick=""ChooseKonragent(this)"" oncontextmenu=""this.innerText='';this.Tag=''"" id=""Kontr"" Tag='"_$G(Kontr)_"'>"_$G(KontrName)_"</span>"
	w "<td class=RightBottom>Сумма"
	w "<td class=RightBottom><input type=""text"" id=""Summa"" Value="""_$G(Summa)_""">"
	w "</tr>"
	w "<tr>"
	w "<td class=RightBottom>Оплата"
	w "<td class=RightBottom><select id=""opl"">"
	w ##class(Docs.Action2).GetClassValuesOptions($G(opl),"Common.Dictionary7")_"</select>"
	w "<td class=RightBottom>Статус оплаты"
	w "<td class=RightBottom><select id=""OplatStatus"">"
	w ##class(Docs.Action2).GetDisplaylistOptions($G(OplatStatus),"Docs.Rash||OplatStatus")_"</select>"
	w "</tr>"
	w "<tr>"
	w "<td class=RightBottom>Оплаченная сумма<td class=RightBottom><input type=""text"" id=""OplSumma"" Value="""_$G(OplSumma)_""">"
	w "<td class=RightBottom>Платёжный документ"
	w "<td class=RightBottom><span onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"" class=Kontragent onclick=""ChoosePlatej(this)"" oncontextmenu=""this.innerText='';this.Tag=''"" id=""Platej"" Tag='"_$G(Platej)_"'>"_$G(PlatejName)_"</span>"
	w "</tr>"
	w "<tr>"
	w "<td class=RightBottom>Рублёвая сумма<td class=RightBottom><input type=""text"" id=""RubSumma"" Value="""_$G(RubSumma)_""">"
	w "<td class=RightBottom colspan=2>&nbsp;"
	w "</tr>"
	w:$G(ClosedString)'="" "<tr><td colspan=4 class=RightBottom>Накладная закрыта <i>"_ClosedString_"</i>"
	Write !,"</table>",!
	Write "<tr height=100%><td>",!
	Write "<SKLADiGrid:iGrid id=""docstr"" width=""100%"" height=""300"" Enabled=""true""  /><br>",!
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""AddGood();"" TITLE=""""><center>Добавить товар</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""RemoveRow();"" TITLE=""""><center>Удалить строку</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""ClearGrid();"" TITLE=""""><center>Очистить строки</center></span>"
	Write !,"<tr><td>",!
	Write "<center><br>"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"_($G(SaveButtonStyle))_""" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""startFun();"" TITLE=""""><center>Сохранить</center></span>"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""windowclose();"" TITLE=""""><center>Отмена</center></span>"
	Write "</center>",!
	Write "</table>",!
	Write !,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<style>"
	Write !,".LeftTop{border-left : 1 solid black;border-top : 1 solid black;}",!
	Write ".RightBottom{font-family:Arial;font-size:14px;border-right : 1 solid black;border-bottom : 1 solid black;}",!
	Write "SELECT{width:170px}",!
	Write ".Kontragent{width:170px;cursor:hand;}",!
	Write ".ZakazInstr{display:inline;}",!
	Write "</style>"
	Write !,"<script language=""jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<title>Расходная накладная</title>",!
	Write !,"<script language=""Jscript"">"
	Write !,"var DocId='"_(%request.Get("source"))_"';",!
	Write "var sessionid="""_(sessionid)_""";",!
	Write !,"function load(){",!
	Write "FillDocStr();",!
	Write "}",!
	Write !,"function FillDocStr(){",!
	Write "var Captions = new Array(6);",!
	Write "var Keys = new Array(6);",!
	Write "var Tags = new Array(6);",!
	Write "var Widths = new Array(6);",!
	Write !,"Captions[0]=""Товар"";",!
	Write "Captions[1]=""Цена"";",!
	Write "Captions[2]=""Кол-во"";",!
	Write "Captions[3]=""Сумма"";",!
	Write "Captions[4]=""Заказанный товар"";",!
	Write "Captions[5]=""Заказ (кол-во)"";",!
	Write "//Captions[6]=""Дата замены"";",!
	Write "//Captions[7]=""Время замены"";",!
	Write "//Captions[8]=""Оператор"";",!
	Write !,"Tags[0]=""Goods.Goods"";",!
	Write "Tags[1]=""%Numeric"";",!
	Write "Tags[2]=""%Numeric"";",!
	Write "Tags[3]=""%Numeric"";",!
	Write "Tags[4]=""Goods.Goods"";",!
	Write "Tags[5]=""%String"";",!
	Write "//Tags[6]=""%Date"";",!
	Write "//Tags[7]=""%Time"";",!
	Write "//Tags[8]=""Users.Dates"";",!
	Write !,"Keys[0]=""Goods"";",!
	Write "Keys[1]=""Price"";",!
	Write "Keys[2]=""Quantity"";",!
	Write "Keys[3]=""Total"";",!
	Write "Keys[4]=""ZakazGoods"";",!
	Write "Keys[5]=""Zakaz"";",!
	Write "//Keys[6]=""ZakazDat"";",!
	Write "//Keys[7]=""ZakazTim"";",!
	Write "//Keys[8]=""ZakazUser1"";",!
	Write !,"Widths[0]=200;",!
	Write "Widths[1]=60;",!
	Write "Widths[2]=60;",!
	Write "Widths[3]=60;",!
	Write "Widths[4]=200;",!
	Write "Widths[5]=80;",!
	Write "//Widths[6]=80;",!
	Write "//Widths[7]=80;",!
	Write "//Widths[8]=110;",!
	Write "docstr.DrawHeaders(Captions,Keys,Tags, Widths);",!
	Write "if(DocId!="""")",!
	Write "	{",!
	Write "	docstr.loadfrommethod(""Docs.Action2.RashStr"",DocId);",!
	Write "	}",!
	Write "}",!
	Write !,"// сохранить",!
	Write "function startFun(){",!
	Write "xmlDoc=docstr.GetXmlContentByRows();",!
	Write "InsertXmlHeader(xmlDoc,""Summa"",docstr.GetTableSumma(),""%String"");",!
	Write "InsertXmlHeader(xmlDoc,""Name"",Name.value,""%String"");",!
	Write "InsertXmlHeader(xmlDoc,""Comment"",Comment.value,""%String"");",!
	Write "InsertXmlHeader(xmlDoc,""Kontr"",Kontr.Tag,""Common.Kontragent"");",!
	Write "InsertXmlHeader(xmlDoc,""opl"",opl.value,""Common.Dictionary7"");",!
	Write "InsertXmlHeader(xmlDoc,""OplatStatus"",OplatStatus.value,""%String"");",!
	Write "InsertXmlHeader(xmlDoc,""OplSumma"",OplSumma.value,""%String"");",!
	Write "InsertXmlHeader(xmlDoc,""Platej"",Platej.Tag,""Docs.Platejka"");",!
	Write "InsertXmlHeader(xmlDoc,""RubSumma"",RubSumma.value,""%String"");",!
	Write "var DocID=SendXml(DocId,""Docs.Rash"",xmlDoc,sessionid);",!
	Write "if(isNaN(DocID)){alert(DocID)}",!
	Write "else{returnValue=1;window.close();}",!
	Write "}",!
	Write !,"//Добавить товар",!
	Write "function AddGood(){",!
	Write "WinResult=window.showModalDialog(""selectgoods2.csp"","""",""center:yes;status:no;dialogHeight:700px;dialogWidth:800px;resizable:yes;"")",!
	Write "if(WinResult==null)return",!
	Write "WinResult=WinResult.split(StringSplitter)",!
	Write "docstr.AddRowsInstruct(WinResult)",!
	Write "}",!
	Write !,"// удалить строку",!
	Write "function RemoveRow(){",!
	Write "docstr.RemoveSelectedRows()",!
	Write "}",!
	Write !,"// Очистить список",!
	Write "function ClearGrid(){",!
	Write "if(window.confirm(""Удалить все товарные строки?""))docstr.Clear()	",!
	Write "}",!
	Write !,"function ChooseKonragent(Obj){",!
	Write "var newItem=window.showModalDialog(""Dictionary.csp"",""Common.Kontragent"",""center:yes;status:no;dialogHeight:400px;dialogWidth:650px;resizable:yes;"");",!
	Write "if(newItem==null){return false;}",!
	Write "var newArr=newItem.split(InnerSplitter);",!
	Write "Obj.innerText=newArr[1];",!
	Write "Obj.Tag=newArr[0];",!
	Write "}",!
	Write !,"function ChoosePlatej(Obj){",!
	Write "var newItem=window.showModalDialog(""Dictionary.csp"",""Docs.Platejka"",""center:yes;status:no;dialogHeight:400px;dialogWidth:650px;resizable:yes;"");",!
	Write "if(newItem==null){return false;}",!
	Write "var newArr=newItem.split(InnerSplitter);",!
	Write "Obj.innerText=newArr[1];",!
	Write "Obj.Tag=newArr[0];",!
	Write "}",!
	Write "</script>"
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLADiGrid>"
	Write !,"<IMPORT NAMESPACE=""SKLADiGrid"" IMPLEMENTATION=""htc/iGridV7.htc"">",!
	Do ..OnPageHEAD()
	Write !,!
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  i %session.NewSession d
  . s %session.EndSession=1
  . s sessionid=%request.Get("sessionid",1)
  . s %session=%session.GetSession(sessionid)
  .  s login=$G(%session.Data("user"))
  . i '+login s %response.ServerSideRedirect="norights.csp" 
  e  s sessionid=%session.SessionId
 Quit 1
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\DocsRash.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/DocsRash.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62024,3616</Default>
</Parameter>
</Class>
</Export>
