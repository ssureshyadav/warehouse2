<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.docs2">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62157,82487.240438</TimeCreated>

<Method name="GetLayout">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec>TableName:%String</FormalSpec>
<Language>cache</Language>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  
  if $ISOBJECT($G(%session)) s user=$G(%session.Data("user"),"undefined")
  else  s user="undefined"
  
  s ^mtempArt("TableName")=TableName
  s ^mtempArt("user")=user
  
  s LayoutCol =$G(^Layout("Layout",user,TableName,"LayoutCol"))
  s LayoutSort=$G(^Layout("Layout",user,TableName,"LayoutSort"))
  
  s ^mtempArt("layout")=LayoutCol_$C(9)_LayoutSort
  q LayoutCol_$C(9)_LayoutSort
 
]]></Implementation>
</Method>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""load()"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !,"<TABLE cellSpacing=0 width=""100%"" celpadding=""0"" >",!
	Write "<TR>",!
	Write "<td width=10%>"
	Write "<img alt=""Обновить раздел"" src=""images/refresh.gif"" onclick=""window.location.reload()"">"
	Write "</td>",!
	Write "<TD width=80% align=center style=""BACKGROUND: rgb(233,243,255); FONT-size: 18px ; font-family: arial; COLOR: rgb(0,0,102); BORDER-BOTTOM: rgb(0,0,102) 1px solid"" ><strong>Документы</strong></TD>",!
	Write "<td width=10% align=right>"
	Write "<a href=""help/docs.htm"">"
	Write "<img src=""images/BIGHelp.bmp"" width=""20"" height=25 border=0>"
	Write "</a>"
	Write "</td>",!
	Write "</TABLE>",!
	Write !,"<TABLE cellSpacing=0 width=""100%"" celpadding=""0"" >",!
	Write "<td rowspan=99 valign=top>",!
	Write "<fieldset><legend>Типы документов</legend>",!
	Write " <SKLADList:listview width=200 height=300 id=""doctypes"" ClassName=""Docs.Docs"" onAddColumns=""show()"" zClick=""okfunc()"" zonDblClick=""CreateDocument()""/><br>",!
	Write "</fieldset>",!
	Write "</td></tr>",!
	Write "<tr>",!
	Write "<td width=10>&nbsp;</td>",!
	Write "<td width=100% valign=top>",!
	Write "<fieldset><legend id=""TypDocument""></legend>",!
	Write "Период c "
	Write "<input type=text id=""dat1"" value="""_($ZD($H-2,4))_""" onclick=""fnCalendar(this)"" class=""datar"">"
	Write " по "
	Write "<input type=text id=""dat2"" value="""_($ZD($H,4))_""" onclick=""fnCalendar(this)"" class=""datar"">"
	Write !,"<select id=""ChooseKontragent"" onchange=""ChooseKontragentFunc()"">"
	Write !,"<option value=""all"">"
	Write "Все</option>",!
	Write "<option value=""choose"">"
	Write "Выбрать контрагента...</option>",!
	Write "</select>"
	Write " "
	Write "<input type=""text"" id=""DocName"" title=""Начальные цифры номера"" style=""width:30px"">"
	Write !," "
	Write "<span id=""ActAddFields"" style=""display:none;border:solid black 1"">"
	Write !," 	Неоплаченные "
	Write "<input type=""checkbox"" style=""border:none;width:15px"" id=""ShowUnpaid"" title=""Выводить только неоплаченные акты"">"
	Write !," "
	Write "</span>"
	Write !,!,"<img src=""images/ok.gif"" onmouseover=""okbut.src='images/Onok.gif'"" onmouseout=""okbut.src='images/ok.gif'""  id=""okbut"" name=""okbut"" alt=""Показать документы"" onclick=""okfunc()"" style="""">"
	Write "<br>",!
	Write "<SKLADList:listview width=100% height=150 id=""docums"" onAddColumns=""showdocums()"" zClick=""showitems()"" zonDblClick=""CreateDocument(docums.ItemID)"" />",!
	Write "  <Table width=100%><tr><td width=100%>",!
	Write !,"<img src=""images/new.gif"" onmouseover=""newbut.src='images/Onnew.gif'"" onmouseout=""newbut.src='images/new.gif'""  id=""newbut"" name=""newbut"" alt=""Создать документ"" onclick=""CreateDocument('')"" style="""">"
	Write !,!,"<img src=""images/edit.gif"" onmouseover=""editbut.src='images/Onedit.gif'"" onmouseout=""editbut.src='images/edit.gif'""  id=""editbut"" name=""editbut"" alt=""Редактировать документ"" onclick=""CreateDocument(docums.ItemID)"" style="""">"
	Write !,!,"<img src=""images/ok.gif"" onmouseover=""okbut2.src='images/Onok.gif'"" onmouseout=""okbut2.src='images/ok.gif'""  id=""okbut2"" name=""okbut2"" alt=""Обработать документ"" onclick=""processdoc()"" style="""">"
	Write !,!,"<img src=""images/print.gif"" onmouseover=""okbwut2.src='images/Onprint.gif'"" onmouseout=""okbwut2.src='images/print.gif'""  id=""okbwut2"" name=""okbwut2"" alt=""Печать документа"" onclick=""prnt(docums.ItemID,docums.ClassName,'')"" style="""">"
	Write !,!,"<img src=""images/printword.gif"" onmouseover=""PrntButWord.src='images/Onprintword.gif'"" onmouseout=""PrntButWord.src='images/printword.gif'""  id=""PrntButWord"" name=""PrntButWord"" alt=""Печать документа Word"" onclick=""prnt(docums.ItemID,docums.ClassName,'word')"" style="""">"
	Write !,!,"<img src=""images/mail.gif"" onmouseover=""EmailDocument.src='images/Onmail.gif'"" onmouseout=""EmailDocument.src='images/mail.gif'""  id=""EmailDocument"" name=""EmailDocument"" alt=""Отправить по почте"" onclick=""EmailDocumentFn(docums.ItemID,docums.ClassName)"" style="""">"
	Write !,"<span style=""display:none"" id=""StorageOutField"">"
	Write !,"	"
	Write !,"<img src=""images/goinside.gif"" onmouseover=""goinside.src='images/Ongoinside.gif'"" onmouseout=""goinside.src='images/goinside.gif'""  id=""goinside"" name=""goinside"" alt=""Протокол сборки инструкции по отбору"" onclick=""ShowLogOfCreation()"" style="""">"
	Write !,"</span>"
	Write !,"<span style=""display:none"" id=""okbwut3"">"
	Write " ",!
	Write !,"<img src=""images/change.gif"" onmouseover=""ChangeTovInDoc.src='images/Onchange.gif'"" onmouseout=""ChangeTovInDoc.src='images/change.gif'""  id=""ChangeTovInDoc"" name=""ChangeTovInDoc"" alt=""Заменить товар в расходной накладной"" onclick=""ChangeTovInDocFn()"" style="""">"
	Write !,!,"<img src=""images/card.gif"" onmouseover=""dkfi.src='images/Oncard.gif'"" onmouseout=""dkfi.src='images/card.gif'""  id=""dkfi"" name=""dkfi"" alt=""Сформировать счет на оплату"" onclick=""makescet('Docs.Chet')"" style="""">"
	Write !,!,"<img src=""images/card.gif"" onmouseover=""okbwut4.src='images/Oncard.gif'"" onmouseout=""okbwut4.src='images/card.gif'""  id=""okbwut4"" name=""okbwut4"" alt=""Сформировать счет-фактуру"" onclick=""makescet('factura')"" style="""">"
	Write !,!,"<img src=""images/card.gif"" onmouseover=""hernya.src='images/Oncard.gif'"" onmouseout=""hernya.src='images/card.gif'""  id=""hernya"" name=""hernya"" alt=""Сформировать товарную накладную"" onclick=""maketovnakl('tovnakladn')"" style="""">"
	Write !,"</span>"
	Write !,!,"<span style=""display:none"" id=""OtchetSpecButton"">"
	Write " ",!
	Write !,"<img src=""images/txt.gif"" onmouseover=""btnShowOtchetErrors.src='images/Ontxt.gif'"" onmouseout=""btnShowOtchetErrors.src='images/txt.gif'""  id=""btnShowOtchetErrors"" name=""btnShowOtchetErrors"" alt=""Показать ошибки отчёта"" onclick=""ShowOtchetErrorsFn()"" style="""">"
	Write !,"<img src=""images/red_stop.gif"" alt=""Отклонить отчёт"" width=""20px"" height=""20px"" style=""cursor:hand"" onclick=""setOtchetFailed()"">"
	Write !,"<img src=""images/green_butt.gif"" alt=""Принять отчёт"" width=""20px"" height=""20px"" style=""cursor:hand"" onclick=""setOtchetAccepted()"">"
	Write !,!,"<img src=""images/txtok.gif"" onmouseover=""btnProveOthet.src='images/Ontxtok.gif'"" onmouseout=""btnProveOthet.src='images/txtok.gif'""  id=""btnProveOthet"" name=""btnProveOthet"" alt=""Пришло бумажное подтверждение отчёта"" onclick=""ProveOthet()"" style="""">"
	Write !,"</span>"
	Write !,!
	if  &html<
	<span style="display:none" id="ActSpecButton"> 
	<img src="images/txt.gif" onmouseover="btnShowReqsFromAct.src='images/Ontxt.gif'" onmouseout="btnShowReqsFromAct.src='images/txt.gif'"  id="btnShowReqsFromAct" name="btnShowReqsFromAct" alt="Показать заявки этого акта" onclick="ShowReqsFromActFn()">
	<img src="images/red_stop.gif" alt="Отклонить акт" width="20px" height="20px" style="cursor:hand" onclick="setActFailed()">
	<img src="images/green_butt.gif" alt="Принять акт" width="20px" height="20px" style="cursor:hand" onclick="setActAccepted()">
	<img src="images/print.gif" onmouseout="this.src='images/print.gif'" onmouseover="this.src='images/Onprint.gif'" alt="Сформировать служебную записку" width="20px" height="20px" style="cursor:hand" onclick="MakeActNote()">
	</span>
	>
	Write !,"</td><td>",!
	Write !,"<img src=""images/del.gif"" onmouseover=""dk2fi.src='images/Ondel.gif'"" onmouseout=""dk2fi.src='images/del.gif'""  id=""dk2fi"" name=""dk2fi"" alt=""Удалить документ"" onclick=""deldoc()"" style="""">"
	Write !,"</td></tr></table>",!
	Write "<!--",!
	Write "<sklad:LittleButton name=""ok"" id=""okbut3"" onclick=""printdoc()"" alt=""Распечатать документ"">",!
	Write "-->"
	Write !,"</fieldset>",!
	Write "<fieldset><legend>Строки документа</legend>",!
	Write !,"<img src=""images/mail.gif"" onmouseover=""btnSaveDocstrLayout.src='images/Onmail.gif'"" onmouseout=""btnSaveDocstrLayout.src='images/mail.gif'""  id=""btnSaveDocstrLayout"" name=""btnSaveDocstrLayout"" alt=""Удалить документ"" onclick=""SaveDocstrLayout(IGridDocstrObj)"" style="""">"
	Write !,"<input type=""button"" value=""get"" onclick=""GetDocstrLayout()"">"
	Write !,"<SKLADiGrid:iGrid id=""IGridDocstr"" width=""100%"" height=""300"" Enabled=""true"" RowMode=""true"" />",!
	Write "<!--",!
	Write "	<SKLADList:listview width=100% height=150 id=""docitems"" onAddColumns=""showitems()""/><br>",!
	Write "-->"
	Write !,"</fieldset>",!
	Write !,!,"</td></tr>",!
	Write "</table>",!
	Write "</body>"
	Write !,(..HyperEventFrame(0))
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write " "
	Write !,!,!,!
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<title>"_($G(%session.Data("systemname")))_"</title>",!
	Write "<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<style>"
	Write !,".datar{width:70;border:none;cursor:hand}",!
	Write "</style>"
	Write !,!,"<script language=""Jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<script language=""JScript"">"
	Write !,"var d1,d2;",!
	Write "var ActRights = "_(ActRights)_";",!
	Write "var ItemsClassName;	//название строк класса который кликнули в списке ""Типы документов""",!
	Write "var LastLoadedHeadersClass;	//класс заголовки которого загружены в IGridDocstr",!
	Write "var IGridDocstrObj;",!
	Write !,"sessionid="""_(%session.SessionId)_""";",!
	Write "depot="""_($G(%session.Data("depot")))_"""",!
	Write "docssame="""_($G(%session.Data("docssame")))_""";",!
	Write "OurName="""_($G(%session.Data("OurName")))_""";",!
	Write "var login = '"_($G(login))_"';",!
	Write !,"function load()",!
	Write "{",!
	Write "	IGridDocstrObj = document.getElementById(""IGridDocstr"");",!
	Write "	doctypes.LoadHeaders();",!
	Write "}",!
	Write !,"function show()",!
	Write "{",!
	Write "	doctypes.DownLoad();",!
	Write "}",!
	Write !,"function okfunc()",!
	Write "{",!
	Write "	var AdditionalFieldsDocs="""";",!
	Write "	StorageOutField.style.display=""none"";",!
	Write "	TypDocument.innerText=doctypes.ItemName;",!
	Write "	IGridDocstrObj.Clear(true);			//очистить таблицу строк",!
	Write "	var doctypesItemID=doctypes.ItemID	//название класса выбранного в списке типов документов",!
	Write "	ItemsClassName = doctypesItemID+""Items"";",!
	Write "	docums.ClassName=doctypesItemID;",!
	Write "	//if(doctypesItemID==""Docs.Platejka"")return",!
	Write "	if(doctypesItemID==""Docs.PrihKassOrder"")return",!
	Write "	//docitems.ClassName=doctypesItemID+""Items"";",!
	Write "	var ExcludeFields=""Goods,Doc,DocType,RequestItem"";",!
	Write "	var AdditionalFields="""";",!
	Write "	if(doctypesItemID!=""Docs.Platejka"")var AdditionalFields=""Goods->FullName~Наименование~~~@%String~~~~~#@#"";",!
	Write "	",!
	Write "	//if(docitems.ClassName==""Docs.RashItems"")",!
	Write "	//{",!
	Write "	//	var ExcludeFields=ExcludeFields+"",ZakazGoods"";",!
	Write "	//	var AdditionalFields=AdditionalFields+""ZakazGoods->FullName~Заказанный товар~~~@%String~~~~~#@#"";",!
	Write "	//}",!
	Write "	",!
	Write "	if(doctypes.ItemID==""Docs.Rash""){okbwut3.style.display=""inline"";}",!
	Write "	else{okbwut3.style.display=""none"";}",!
	Write "	",!
	Write "	if(doctypesItemID==""Docs.Otchet"")",!
	Write "	{",!
	Write "		OtchetSpecButton.style.display=""inline"";",!
	Write "	}",!
	Write "	else{OtchetSpecButton.style.display=""none"";}",!
	Write "	if(ActRights==1)",!
	Write "	{",!
	Write "		if(doctypesItemID==""Docs.Act"")",!
	Write "		{",!
	Write "			ActSpecButton.style.display=""inline"";",!
	Write "			ActAddFields.style.display=""inline"";",!
	Write "		}",!
	Write "		else",!
	Write "		{",!
	Write "			ActSpecButton.style.display=""none"";",!
	Write "			ActAddFields.style.display=""none"";",!
	Write "		}",!
	Write "	}",!
	Write "	if(doctypes.ItemID==""Docs.StorageOut""){StorageOutField.style.display=""inline"";}",!
	Write "	",!
	Write "	d1 = new Date();",!
	Write "	docums.LoadHeaders(""ActType"","""",AdditionalFieldsDocs);",!
	Write "	//docitems.LoadHeaders(ExcludeFields,"""",AdditionalFields);",!
	Write !,"}",!
	Write !,"//показать документы",!
	Write "function showdocums()",!
	Write "{",!
	Write "	var order="""";",!
	Write "	//if(doctypes.ItemID==""Docs.Otchet""){var order=""NameSorted""}",!
	Write "	dateArr=dat1.value.split(""/"")",!
	Write "	Data1=dateArr[2]+""-""+dateArr[1]+""-""+dateArr[0]",!
	Write "	dateArr=dat2.value.split(""/"")",!
	Write "	Data2=dateArr[2]+""-""+dateArr[1]+""-""+dateArr[0]",!
	Write "	var request=""Dat>=CAST('""+Data1+""' AS DATE) and Dat<=CAST('""+Data2+""' AS DATE)"";",!
	Write "	if(docssame==0){var requst=request+"" and Depot=""+depot;} //если  показ всех документов для всех складов то",!
	Write "	var currentKontragent=ChooseKontragent.value;",!
	Write "	if(currentKontragent!=""all""){var request=request+"" and Kontr=""+currentKontragent}",!
	Write "	if(DocName.value!=""""){var request=request+"" and Name %STARTSWITH '""+DocName.value+""'"";}",!
	Write "	var ShowUnpaidObject = document.getElementById(""ShowUnpaid"");",!
	Write "	if(typeof(ShowUnpaid)==""object"")",!
	Write "	{",!
	Write "		if(ShowUnpaidObject.checked)var request=request+"" and Paid=0""",!
	Write "	}",!
	Write "	",!
	Write "	",!
	Write "	docums.DownLoad(request,"""","""",order)",!
	Write "	//d2 = new Date();",!
	Write "	//alert(""вывод документов\n"" + (d2-d1) + ""\n"" + d1.toLocaleTimeString() + ""\n"" + d2.toLocaleTimeString());",!
	Write "}",!
	Write !,"//показать заголовки iGrid. headers формируется в ##class(Common.Common).showheaders",!
	Write "function ShowIgridHeaders(headers)",!
	Write "{",!
	Write "	if(LastLoadedHeadersClass == ItemsClassName) return;",!
	Write !,"	IGridDocstrObj.Clear(true);",!
	Write "	headersArray = headers.split(""#@#"");",!
	Write "	var headersArraylength = headersArray.length;",!
	Write "	",!
	Write "	var Captions = new Array(headersArraylength-1);",!
	Write "	var Keys = new Array(headersArraylength-1);",!
	Write "	var Tags = new Array(headersArraylength-1);",!
	Write "	var Widths = new Array(headersArraylength-1);",!
	Write "	//alert(headers )",!
	Write "	",!
	Write "	for (var i = 0; i< headersArray.length-1; i++)",!
	Write "	{",!
	Write "		//здесь каждый отдельный заголовок",!
	Write "		var h = headersArray[i];",!
	Write "		var headerArray = h.split(""~"");",!
	Write "		Captions[i] = headerArray[1];",!
	Write "		Keys[i] = headerArray[0];",!
	Write "		Tags[i] = """";",!
	Write "		Widths[i] = 80;",!
	Write "		//alert(""headerArray[1]"" + headerArray[1]);",!
	Write "	}",!
	Write "	",!
	Write "	//alert(Captions);",!
	Write "	LastLoadedHeadersClass = ItemsClassName;",!
	Write "	IGridDocstrObj.DrawHeaders(Captions,Keys,Tags);",!
	Write "	//GetDocstrLayout(""IGridDocstr||"" + ItemsClassName);	//восстановить размер и положение колонок",!
	Write "}",!
	Write !,"//загрузить данные в iGrid",!
	Write "function LoadIgridData(DocId)",!
	Write "{",!
	Write "	var AllData = "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("csp.docs2.ShowDocItems:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',ItemsClassName,DocId)",!
	Write "	var headers=AllData.split(""\t"")[0];",!
	Write "	ShowIgridHeaders(headers);",!
	Write !,"	IGridDocstrObj.Clear(false);",!
	Write "	IGridDocstrObj.LoadStringData(AllData.split(""\t"")[1]);",!
	Write "}",!
	Write !,"function CreateDocument(ItemID)",!
	Write "{",!
	Write "	CurrentDocementClass=docums.ClassName",!
	Write "	if(CurrentDocementClass==""""){alert(""Не выбран тип документа"");return}",!
	Write "	ItemID=ReturnSpace(ItemID)",!
	Write "	var doccsp=""document.csp"";",!
	Write "	//if (CurrentDocementClass==""Docs.DocBrak""){alert(""Документы на приём брака создаются и редактируются на рабочем месте сервис менеджера. Инструкциями с типом \""Приём брака\"""");return}",!
	Write "	if(CurrentDocementClass==""Docs.Rash""){var doccsp=""DocsRash.csp?source=""+ItemID;}",!
	Write "	if(CurrentDocementClass==""Docs.Utiliz"")",!
	Write "	{",!
	Write "		if(window.confirm(""Открывать в новой форме?"")){var doccsp=""UtilizationDoc.csp?DocId=""+ItemID}",!
	Write "		else{doccsp=""docutiliz.csp""}",!
	Write "	}",!
	Write "	if(CurrentDocementClass==""Docs.PrihKassOrder"")doccsp=""docplatej.csp?DocId=""+ItemID;",!
	Write "	if(CurrentDocementClass==""Docs.Platejka"")doccsp=""docplatej.csp?DocId=""+ItemID;",!
	Write "	if(CurrentDocementClass==""Docs.Invent"")",!
	Write "	{",!
	Write "		if(window.confirm(""Открывать в новой форме?"")){var doccsp=""InventarizationIgrid.csp?source=""+ItemID}",!
	Write "		else{doccsp=""docinvent.csp""}",!
	Write "	}",!
	Write "	if(CurrentDocementClass==""Docs.Inner"")doccsp=""docinner.csp""",!
	Write "	if(CurrentDocementClass==""Docs.Diff"")doccsp=""docdiff.csp""",!
	Write "	if(CurrentDocementClass==""Docs.InnerDiff"")doccsp=""docinnerdiff.csp""",!
	Write "	if(CurrentDocementClass==""Docs.Remont""){alert(""Заявка на запчасти создается инструкцией руководителя\nили в карточке контрагента"");return;}",!
	Write "	if(CurrentDocementClass==""Docs.Otchet"")",!
	Write "	{",!
	Write "		if(ItemID==""""){doccsp=""Otchet.csp?docid=""+ItemID;}",!
	Write "		else{alert(""Отчёты редактировать запрещено."");return;}",!
	Write "	}",!
	Write "	if(CurrentDocementClass==""Docs.Act"")",!
	Write "	{",!
	Write "		doccsp=""ActFromClient.CSP?docid=""+ItemID;",!
	Write "		//alert(""Акты технического состояния создаются только в менеджере отчётов"");return;",!
	Write "	}",!
	Write "	if((CurrentDocementClass==""Docs.StorageIn"")||(CurrentDocementClass==""Docs.StorageOut"")){alert(""Внутренняя инструкция создается на рабочем месте кладовщика"");return;}",!
	Write "	if(CurrentDocementClass==""Operation.Instructions""){doccsp=""createinstructIgrid.csp?source=""+ItemID}",!
	Write "	WinResult=window.showModalDialog(doccsp,CurrentDocementClass+InnerSplitter+ItemID+InnerSplitter+doctypes.ItemName,""center:yes;status:no;dialogHeight:600px;dialogWidth:800px;resizable:yes;"")",!
	Write "	if(WinResult==1)showdocums();",!
	Write "	}",!
	Write "	",!
	Write "//показать строки документа",!
	Write "function showitems()",!
	Write "{",!
	Write "	//var dd1 = new Date();",!
	Write "	var currentdoc=ReturnSpace(docums.ItemID);",!
	Write "	if(currentdoc=="""")return",!
	Write "	//docitems.DownLoad(""Doc=""+currentdoc,1)",!
	Write "	//var dd2 = new Date();",!
	Write "	LoadIgridData(currentdoc);",!
	Write "	//alert(""вывод строк\n"" + (dd2-dd1) + ""\n"" + dd1.toTimeString() + ""\n"" + dd2.toTimeString());	",!
	Write "}",!
	Write !,!,"function processdoc()",!
	Write "{",!
	Write "	if(docums.ItemID=="""")return",!
	Write "	var doc=docums.ItemID+""@""+doctypes.ItemID;",!
	Write "	var ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.processdoc:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',doc)",!
	Write "	//alert(""код результата обработки документа: "" + ok);",!
	Write "	if(isNaN(ok))",!
	Write "		{",!
	Write "			alert(ok)",!
	Write "			if(doctypes.ItemID==""Docs.Otchet"")",!
	Write "			{",!
	Write "				ShowOtchetErrorsFn();",!
	Write "			}",!
	Write "		}",!
	Write "	else{",!
	Write "			showdocums();",!
	Write "		}",!
	Write "}",!
	Write !,"function printdoc()",!
	Write "{",!
	Write "	var doc=docums.ItemID+""@""+doctypes.ItemID;",!
	Write "	var doccsp=""document.csp"";",!
	Write "	if(CurrentDocementClass==""Docs.Utiliz"")doccsp=""docutiliz.csp""",!
	Write "	if(CurrentDocementClass==""Docs.Invent"")doccsp=""docinvent.csp""",!
	Write "	if(CurrentDocementClass==""Docs.Inner"")doccsp=""docinner.csp""",!
	Write "	if(CurrentDocementClass==""Docs.Diff"")doccsp=""docdiff.csp""",!
	Write "	WinResult=window.showModalDialog(doccsp,CurrentDocementClass+InnerSplitter+ItemID+InnerSplitter+doctypes.ItemName,""cener:yes;status:no;dialogHeight:600px;dialogWidth:800px;resizable:yes;"")",!
	Write "	//window.open(""print.csp?doc=""+doc);",!
	Write "}",!
	Write !,"//распечатать документ",!
	Write "function prnt(docid,docclass,param){",!
	Write "var url=""print.csp?id=""+docid+""&class=""+docclass+""&sessionid=""+sessionid;",!
	Write "if(param==""word"")",!
	Write "{",!
	Write "	url=url+""&word=on""",!
	Write "}",!
	Write "if ((docclass==""Docs.Otchet"")&&(param==""word""))",!
	Write "{",!
	Write "	if(window.confirm(""Печатать все поля документа?"")){url=url+""&AllColumns=1""}",!
	Write "	//window.prompt(url,url);",!
	Write "}",!
	Write "window.open(url);",!
	Write "}",!
	Write !,"function makescet(cl){",!
	Write "var doc=docums.ItemID;",!
	Write "if(doc==""""){alert(""Не выбран документ - основание для формирования платежного поручения"");return}",!
	Write "WinResult=window.showModalDialog(""makescet.csp?docid=""+doc+""&class=""+cl,"""",""cener:yes;status:no;dialogHeight:250px;dialogWidth:400px;resizable:yes;"")",!
	Write "}",!
	Write "function maketovnakl(tovnakladn){",!
	Write "var doctov=docums.ItemID;",!
	Write "if(doctov==""""){alert(""Не выбран документ - основание для формирования товарной накладной"");return}",!
	Write "WinResult=window.showModalDialog(""maketovnakl.csp?docid=""+doctov+""&class=""+tovnakladn,"""",""cener:yes;status:no;dialogHeight:300px;dialogWidth:450px;resizable:yes;"")",!
	Write "}",!
	Write !,"function deldoc(){",!
	Write "if(!window.confirm(""Удалить документ "" + docums.ItemName + "" ?""))return false;",!
	Write "var classname=docums.ClassName;",!
	Write "var itemid=docums.ItemID;",!
	Write "var ok1="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.deletedoc:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',classname,itemid)",!
	Write "if(isNaN(ok1)){alert(ok1)}",!
	Write "else{okfunc();}",!
	Write "}",!
	Write !,"// Выбрать контрагента",!
	Write "function ChooseKontragentFunc(){",!
	Write "	var UsersSelection=ChooseKontragent.options(ChooseKontragent.selectedIndex).value;",!
	Write "	if(UsersSelection==""choose"")",!
	Write "	{",!
	Write "		var newKontragent=window.showModalDialog(""Dictionary.csp"",""Common.Kontragent"",""center:yes;status:no;dialogHeight:400px;dialogWidth:650px;resizable:yes;"");",!
	Write "		if(newKontragent==null){",!
	Write "			ChooseKontragent.selectedIndex=0;",!
	Write "			return false;}",!
	Write "		var ChooseKontragentLength = ChooseKontragent.options.length;",!
	Write "		ChooseKontragent.options.length= ChooseKontragentLength + 1;",!
	Write "		ChooseKontragent.options(ChooseKontragentLength).value=newKontragent.split(""~"")[0];",!
	Write "		ChooseKontragent.options(ChooseKontragentLength).text=newKontragent.split(""~"")[1];",!
	Write "		ChooseKontragent.selectedIndex=ChooseKontragentLength;",!
	Write "	}",!
	Write "}",!
	Write !,"function EmailDocumentFn(ItemID,ItemClass){",!
	Write "	var MailSetup=window.showModalDialog(""MailSetup.csp"","""",""center:yes;status:no;dialogHeight:200px;dialogWidth:500px;resizable:yes;"");",!
	Write "	//вернётся следующая строка",!
	Write "	//Формировать DOC файл (false/true);Открывать Email программу (false/true);принудительный адрес отправки;Файл-шаблон",!
	Write "	//например: ""true;true;""",!
	Write "	//или: ""false;true;artemu78@rambler.ru;first-template""",!
	Write "	if(MailSetup==null)return",!
	Write "	var values=MailSetup.split("";"");",!
	Write "	",!
	Write "	if(ReturnBoolean(values[0])){",!
	Write "		//создать файл",!
	Write "		var WaitWindow=window.open(""wait.csp"",""win2"", ""status=no,width=200,height=200"");",!
	Write "		ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Kontragent.Action.MakeFile:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',ItemID,ItemClass,values[3])",!
	Write "		WaitWindow.close();",!
	Write "		if(isNaN(ok)){alert(ok);return}",!
	Write "		else{alert(""Файл успешно создан"")}",!
	Write "	}",!
	Write "	if(ReturnBoolean(values[1])){",!
	Write "		//открыть почтовую программу",!
	Write "		if(values[2]!="""")",!
	Write "			{",!
	Write "			var MailAddress=values[2];		//",!
	Write "			}",!
	Write "		else",!
	Write "			{",!
	Write "			var MailValues="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.EmailFromDoc:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',ItemID,ItemClass)			",!
	Write "			var MailValuesArray=MailValues.split(StringSplitter);",!
	Write "			var MailAddress=MailValuesArray[0];",!
	Write "			var KontrName=MailValuesArray[1];",!
	Write "			var DocTypeName=MailValuesArray[2];",!
	Write "			var DocName=MailValuesArray[3];",!
	Write "			if(MailValues==""""){alert(""Не удалось определить E-mail у контрагента записанного в документе.\nУкажите пожалуйста адрес вручную или заполните соответствующее поле контрагента."");return}",!
	Write "			",!
	Write "			}",!
	Write "	window.open(""mailto:""+KontrName+"" <""+MailAddress+"">?subject=""+OurName+""&body=Здравствуйте ""+KontrName+""\n\n\n---------\n""+OurName)",!
	Write "	}",!
	Write "}",!
	Write !,"//заменить товар в документе",!
	Write "function ChangeTovInDocFn()",!
	Write "{",!
	Write "	var itemid=docums.ItemID;",!
	Write "	var answer=window.showModalDialog(""ChangeGoods.csp?DocId=""+itemid+""&sessionid=""+sessionid,"""",""center:yes;status:no;dialogHeight:550px;dialogWidth:800px;resizable:yes;"");",!
	Write "	if(answer)LoadIgridData(itemid)",!
	Write "}",!
	Write !,"//показать лог создания инструкции по отбору",!
	Write "function ShowLogOfCreation()",!
	Write "{",!
	Write "	var docid=docums.ItemID;",!
	Write "	if(ReturnSpace(docid)==""""){alert(""Не выбрана инструкция по отгрузке."");return;}",!
	Write "	window.open(""LogOfCreation.csp?doc=""+docums.ItemID);",!
	Write "}",!
	Write !,"//показать ошибки отчёта",!
	Write "function ShowOtchetErrorsFn()",!
	Write "{",!
	Write "	window.showModalDialog(""Info.csp?docid=""+docums.ItemID+""&class=""+doctypes.ItemID+""&property=Errors"","""",""center:yes;status:no;dialogHeight:450px;dialogWidth:600px;resizable:yes;"");",!
	Write "}",!
	Write !,!,"function setOtchetFailed()",!
	Write "{",!
	Write "	if(!window.confirm(""Отклонить отчёт?""))return;",!
	Write "	var docid=docums.ItemID;",!
	Write "	if(ReturnSpace(docid)==""""){alert(""Не выбран отчёт."");return;}",!
	Write "	var Descr = window.prompt(""Укажите причину"","""");",!
	Write "	if(Descr==null)return;",!
	Write "	var ok= "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Otchet.SetOthcetStatFailed2:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',docid,Descr)",!
	Write "	if(isNaN(ok)){alert(ok)}",!
	Write "	else{okfunc();}",!
	Write "}",!
	Write !,"function setOtchetAccepted(){",!
	Write "if(!window.confirm(""Поставить отчёту статус \""Принят\""?""))return;",!
	Write "var docid=docums.ItemID;",!
	Write "if(ReturnSpace(docid)==""""){alert(""Не выбран отчёт."");return;}",!
	Write "var ok= "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Otchet.SetOthcetStatAccepted:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',docid)",!
	Write "if(isNaN(ok)){alert(ok)}",!
	Write "else{okfunc();}",!
	Write "}",!
	Write !,!,"function setActFailed()",!
	Write "{",!
	Write "	if(!window.confirm(""Отклонить акт?""))return;",!
	Write "	var docid=docums.ItemID;",!
	Write "	if(ReturnSpace(docid)==""""){alert(""Не выбран акт."");return;}",!
	Write "	var Descr = window.prompt(""Укажите причину"","""");",!
	Write "	var ok= "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Act.SetActStatFailed:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',docid,Descr)",!
	Write "	if(isNaN(ok)){alert(ok)}",!
	Write "	else{okfunc();}",!
	Write "}",!
	Write !,"function setActAccepted(){",!
	Write "var docid=docums.ItemID;",!
	Write "var ActNumber = "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.getRashNumb:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',""Docs.Act"");",!
	Write "var ActSumma = "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Act.GetActSumma:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',docid);",!
	Write "if(isNaN(ActSumma)){alert(""Невозможно расчитать сумму акта.\n""+ActSumma);return;}",!
	Write "var ActType = "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Act.GetActType:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',docid);",!
	Write "if(isNaN(ActSumma)){alert(""Невозможно расчитать тип акта.\n""+ActType);return;}",!
	Write "var answer = window.confirm(""Поставить акту статус \""Принят\""?\n""+",!
	Write "	""Будущий номер акта ""+ActNumber + ""\n"" + ",!
	Write "	""Сумма акта "" + ActSumma);",!
	Write "if(!answer)return;",!
	Write "if(ReturnSpace(docid)==""""){alert(""Не выбран акт."");return;}",!
	Write "var ok= "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Act.SetActStatAccepted:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',docid,ActNumber,ActSumma,ActType)",!
	Write "if(isNaN(ok)){alert(ok)}",!
	Write "else{okfunc();}",!
	Write "}",!
	Write !,"function ShowReqsFromActFn()",!
	Write "{",!
	Write "	window.showModalDialog(""widetext.csp?docid=""+docums.ItemID+""&class=""+doctypes.ItemID+""&property=CheckResult"","""",""center:yes;status:no;dialogHeight:300px;dialogWidth:400px;resizable:yes;"");",!
	Write "}",!
	Write !,"//сформировать служебную записку",!
	Write "function MakeActNote()",!
	Write "{",!
	Write "	var newItem = """";",!
	Write "	//var newItem=window.showModalDialog(""Dictionary.csp"",""Common.Kontragent"",""center:yes;status:no;dialogHeight:400px;dialogWidth:650px;resizable:yes;"");",!
	Write "	//if(newItem==null)return;",!
	Write "	//var newItem=newItem.split(""~"")[0];",!
	Write "	var docids=escape(docums.ListViewGetItems('selected',1));",!
	Write "	",!
	Write "	var NoteId = "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action2.CreateActNote:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',docids,newItem)",!
	Write "	if(isNaN(NoteId))",!
	Write "	{",!
	Write "		alert(NoteId);",!
	Write "	}",!
	Write "	else",!
	Write "	{",!
	Write "		alert(""Акты погашены. Сформирована служебная записка."");",!
	Write "		//window.open('screen/actnote.csp?id='+NoteId+'&sessionid='+sessionid);",!
	Write "	}",!
	Write "}",!
	Write !,"//пришло бумажное подтверждение отчёта",!
	Write "function ProveOthet()",!
	Write "{",!
	Write "	if(!window.confirm(""Указать, что к отчёту пришло бумажное подтверждение?""))return;",!
	Write "	var ok = "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Otchet.SetParerProve:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',docums.ItemID)",!
	Write "	if(isNaN(ok)){alert(ok)}",!
	Write "	else{okfunc()}",!
	Write "}",!
	Write !,"//сохранить положение и размер колонок iGrid",!
	Write "function SaveDocstrLayout(Obj)",!
	Write "{",!
	Write "	var TableName=""IGridDocstr||""+ItemsClassName;",!
	Write "	cspCallServerMethod('"_(..Encrypt($listbuild("csp.docs2.SaveLayout:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:"")_"&WCHARSET="_%response.CharSet)_"',TableName,Obj.LayoutCol,Obj.LayoutSort)",!
	Write "}",!
	Write !,"//сохранить положение и размер колонок iGrid",!
	Write "function GetDocstrLayout()",!
	Write "{",!
	Write "	var TableName=""IGridDocstr||""+ItemsClassName;",!
	Write "	var data = "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("csp.docs2.GetLayout:csp.docs2"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',TableName);",!
	Write "	alert(data);",!
	Write "	Obj.LayoutCol = data.split(""\t"")[0];",!
	Write "	//Obj.LayoutSort =data.split(""\t"")[1]; ",!
	Write "}",!
	Write "</script>"
	Write !,(..HyperEventHead())
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLADz XMLNS:SKLAD2 XMLNS:SKLADList XMLNS:SKLADiGrid>"
	Write !,"<IMPORT NAMESPACE=""SKLADiGrid"" IMPLEMENTATION=""htc/iGridV8.htc"">",!
	Write "<IMPORT NAMESPACE=""SKLADList"" IMPLEMENTATION=""htc/listview.htc"">",!
	Do ..OnPageHEAD()
	Write !
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  s login=$G(%session.Data("user"))
  s ActRights = 1
  //i '+login s %response.ServerSideRedirect="norights.csp" 
  //i '##class(Common.Rights).getrights(login,3) s %response.ServerSideRedirect="norights.csp" 
  //s ActRights = ##class(Common.Rights).getrights(login,12)
  q 1
 
]]></Implementation>
</Method>

<Method name="SaveLayout">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec>TableName:%String,LayoutCol:%String,LayoutSort:%String</FormalSpec>
<Language>cache</Language>
<Implementation><![CDATA[
  q:TableName=""
  s user=$G(%session.Data("user"),"undefined")
  s ^Layout("Layout",user,TableName,"LayoutCol")=LayoutCol
  s ^Layout("Layout",user,TableName,"LayoutSort")=LayoutSort
  q
 
]]></Implementation>
</Method>

<Method name="ShowDocItems">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec>Class:%String,DocId:%String</FormalSpec>
<Language>cache</Language>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  n str,i,fields
  s str=##class(Common.Common).showheaders(Class,,,1)
  for i=1:1:$L(str,"#@#")
  {
 	s header=$P(str,"#@#",i) 
 	s headerKey = $P(header,"~")
 	s fields=$G(fields)_headerKey_","
  }
  s fields=$E(fields,1,$L(fields)-2)
 
  q str_$C(9)_##class(Common.Common).showdata(Class,fields,,"doc="_DocId,,1)
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\docs2.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/docs2.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62157,82476</Default>
</Parameter>
</Class>
</Export>
