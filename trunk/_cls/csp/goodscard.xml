<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.goodscard">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62196,39180.285587</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""load();"" onkeypress=""ManageWindow();"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !,"<table cellpadding=0 cellspacing=0 width=100% height=100% border=0>",!
	Write "<tr><td colspan=2 ><center><font size=+1><b>"
	Write "<span id=""TovName"" style=""color:#002044"">"
	Write "</span>"
	Write "</b></font></center>",!
	s GoodsId=%request.Get("GoodsId")
	s groupspath=%request.Get("groupspath")
	w "<fieldset><legend>Группы в которые входит товар</legend>"
	w "<ul>"
	&sql(declare rt cursor for select Groups,Groups->Name,Common.SqlProcs_GroupFullName(Groups) into Groups,GroupsName,GroupFullName from Goods.GoodsGroup where Goods=:GoodsId)
	&sql(open rt)
	f  &sql(fetch rt) q:SQLCODE  d
	. w "<li id=""li"_Groups_"""> <img src=""images/del+.gif"" onclick=""RemoveFromGroup('"_Groups_"','"_GoodsId_"')"" onmouseover=""del"_Groups_".src='images/Ondel+.gif'"" onmouseout=""del"_Groups_".src='images/del+.gif'""  id=""del"_Groups_""" name=""del"_Groups_""" alt=""Убрать из группы""> "_GroupFullName
	&sql(close rt)
	w "</ul></fieldset>"
	//f i=1:1:$L(groupspath,"~") d
	//. s res=$G(res)_$P(groupspath,"~",i)_" -> "
	//w $E(res,1,$L(res)-4)
	&html<
	<hr width=70%></td></tr>
	<tr><td valign=top>
	<table class="sved" cellspacing=0 ><tr bgcolor="#eeffff"><td class="TD">&nbsp;<td class="TD">Количество<td class="TD">Продажная цена<td>
	>
	s depots=##class(Common.Common).showdata("Store.Depot","ID,Name","","","",1)
	s ok=##class(Store.Action).GetQuantByGoods(GoodsId,.store)
	f i=1:1:$L(depots,"#@#")-1 d
	. s depot=$P($P(depots,"#@#",i),"~",1)
	. s g=##class(Goods.Goods).%OpenId(GoodsId)
	. s price=g.Price
	. w "<tr><td class=""TD"">"_$P($P(depots,"#@#",i),"~",2)_"<td class=""td"">"_+$G(store(depot))_"<td class=""td"">"_$J(price,".",2)
	Write !,"</table><br>",!
	Write "<SKLADList:listview width=100% height=100 id=""tovaddress"" />",!
	Write "<br>",!
	Write "<input type=""button"" value=""Изображения товара"" onclick=""showtovar('"_(GoodsId)_"')"">"
	Write !,"</td><td>",!
	Write "<fieldset><legend>Сведения о товаре</legend>",!
	Write "<SKLAD2:table id=""PropTable"" width=250 />",!
	Write "</fieldset>",!
	Write "</td></tr>",!
	Write !,"<tr><td width=100% align=center colspan=2 valign=top>",!
	Write "<fieldset><legend>Движение товара c "
	Write "<input type=text id=""dat1"" value="""_($ZD($H,4))_""" onclick=""fnCalendar(this)"" class=""datar"">"
	Write " по "
	Write "<input type=text id=""dat2"" value="""_($ZD($H,4))_""" onclick=""fnCalendar(this)"" class=""datar"">"
	Write !,"<select id=""selkont"">"
	Write "<option value=1>"
	Write "Все контрагенты</option>"
	Write "<option value=2>"
	Write "Выбранный контрагент</option>"
	Write "</select>"
	Write !,!,"<img src=""images/ok.gif"" onmouseover=""okbut.src='images/Onok.gif'"" onmouseout=""okbut.src='images/ok.gif'""  id=""okbut"" name=""okbut"" alt=""Показать документы"" onclick=""GetDocsByTovar()"" style="""">"
	Write "<br>",!
	Write "</legend>",!
	Write "	<SKLADList:listview width=100% height=100 id=""Movement"" />",!
	Write "</fieldset>",!
	Write "</td></tr>",!
	Write "<tr height=100%><td valign=""top"" colspan=2>",!
	Write "<fieldset><legend>Контрагенты товара</legend>",!
	Write " <SKLADList:listview width=100% height=100 id=""kontra"" ClassName=""Common.Kontragent"" onAddColumns=""LoadFromCard()"" /><br>",!
	Write "<!--",!
	Write "Поставщики: <input type=""checkbox"" style=""border:none;width:15px""><br>",!
	Write "Покупатели: <input type=""checkbox"" style=""border:none;width:15px""><br>",!
	Write "-->"
	Write !,"</fieldset>",!
	Write "</td></tr>",!
	Write "<tr><td align=center valign=bottom colspan=3>"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""startFun()"" TITLE=""""><center>Да</center></span>"
	Write "&nbsp;&nbsp;&nbsp;"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""window.close()"" TITLE=""""><center>Отмена</center></span>"
	Write "</td></tr>",!
	Write "</table>",!
	Write "</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<title>"_($G(%session.Data("systemname")))_"</title>",!
	Write "<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<style>"
	Write !,".sved.TD{border-left : 1 solid grey;border-top : 1 solid grey;}",!
	Write ".sved{border-right : 1 solid grey;border-bottom : 1 solid grey;}",!
	Write "</style>"
	Write !,"<script language=""Jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<script language=""JScript"">"
	Write !,"var NodeData = new Array();",!
	Write "sessionid="""_(%session.SessionId)_""";",!
	Write !,"Arguments=window.dialogArguments.split(InnerSplitter);",!
	Write "GoodsId=ReturnSpace(Arguments[0]);",!
	Write "GoodsName=ReturnSpace(Arguments[1]);",!
	Write "function startFun(){",!
	Write "window.close();",!
	Write "}",!
	Write !,"function load(){",!
	Write "TovName.innerText=GoodsName;",!
	Write "Movement.AddColumns(""docdata~Дата~~~@%String#@#doctype~Тип документа~~~@%String#@#Kontr~Контрагент~~~@%String#@#doc~Документ~~~@%String#@#prih~Приход~~~@%String#@#rash~Расход~~~@%String#@#kol~Количество~~~@%String#@#cena~Цена~~~@%String#@#"");",!
	Write "kontra.LoadHeaders();",!
	Write "PropTable.DownLoadPairs('',GoodsId);",!
	Write "GetDocsByTovar();",!
	Write "tovaddress.loadfrommethod(""Store.Action.GetAddrByTovar"",GoodsId,1,1)",!
	Write "}",!
	Write !,"function LoadFromCard(){",!
	Write "kontra.GetFromCard("""","""",GoodsId)",!
	Write "}",!
	Write !,"function GetDocsByTovar(){",!
	Write "if(selkont.value==1)var kont="""";",!
	Write "if(selkont.value==2)var kont=kontra.ItemID;",!
	Write "Movement.loadfrommethod(""Common.Common.GetDocsByTovar"",GoodsId,dat1.value+""~""+dat2.value,kont)",!
	Write "}",!
	Write !,"function RemoveFromGroup(Groups,Goods){",!
	Write "	if(!window.confirm(""Удалить товар из группы?""))return",!
	Write "	var ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Goods.GoodsAction.RemoveFromGroup:csp.goodscard"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',Goods,Groups)",!
	Write "	if(isNaN(ok)){alert(ok);}",!
	Write "	else{document.getElementById(""li""+Groups).style.display=""none"";}",!
	Write "}",!
	Write "</script>"
	Write !,(..HyperEventHead())
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLADz XMLNS:SKLAD2 XMLNS:SKLADList>"
	Write !,"<IMPORT NAMESPACE=""SKLADz"" IMPLEMENTATION=""htc/treeview.htc"">",!
	Write "<IMPORT NAMESPACE=""SKLAD2"" IMPLEMENTATION=""htc/table.htc"">",!
	Write "<IMPORT NAMESPACE=""SKLADList"" IMPLEMENTATION=""htc/listview2.htc"">",!
	Do ..OnPageHEAD()
	Write !
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  i %session.NewSession d
  . s %session.EndSession=1
  . s sessionid=%request.Get("sessionid",1)
  . s %session=%session.GetSession(sessionid)
  e  s sessionid=%session.SessionId
  s login=$G(%session.Data("user"),0)
  i '+login s %response.ServerSideRedirect="norights.csp" 
 
 Quit 1
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\GoodsCard.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/GoodsCard.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62164,45200</Default>
</Parameter>
</Class>
</Export>
