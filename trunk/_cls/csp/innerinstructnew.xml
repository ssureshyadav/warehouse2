<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.innerinstructnew">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62196,41246.204777</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""load()"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !,"<table border=0 width=100% height=100%>",!
	Write "<tr><td>",!
	s DocObj=$ZOBJCLASSMETHOD(ClassName,"%OpenId",DocId)
	s Stat=""
	d:$ISOBJECT(DocObj)
	. s DocName=DocObj.Name
	. s DocComment=DocObj.Comment
	. s Stat=DocObj.Stat
	. i (ClassName="Docs.StorageIn")||(ClassName="Docs.StorageOut") d
	. . s Storeman=$S($ISOBJECT(DocObj.storeman):DocObj.storeman.Name,1:"")
	. . s StoremanId=$S($ISOBJECT(DocObj.storeman):DocObj.storeman.%Id(),1:"")
	. . if ClassName="Docs.StorageOut" s Brak=DocObj.Brak
	. . if ClassName="Docs.StorageIn" s Brak=DocObj.PrihodType
	. s DatClose=$S(DocObj.CloseDate?5N:$ZD(DocObj.CloseDate,4),1:"")
	. s TimClose=$S(DocObj.CloseTime?5N:$ZT(DocObj.CloseTime),1:"")
	. s UserClose=$S($ISOBJECT(DocObj.CloseUser):DocObj.CloseUser.Name,1:"")
	s ClassNameName=##class(Docs.Action).GetDocNameFromClass(ClassName)
	w "<table width=100%><tr><td width=10%>&nbsp;<td width=80% align=center><h3>"_ClassNameName_"</h3><td width=10% align=""center"">&nbsp;"
	if $G(Brak) w " <font size=4 color=""red"">некондиционные<br>товары</font>"
	w "</table>"
	w "<table border=0>"
	w "<tr><td><b>Номер<td>"_$G(DocName)_"<td width=50>&nbsp;<td><b>Дата закрытия<td>"_$G(DatClose)
	w "<tr><td><b>Комментарий<td>"_$G(DocComment)_"<td width=50>&nbsp;<td><b>Время закрытия<td>"_$G(TimClose)
	w "<tr><td><b>Ответственный<br>за погрузку<td id=""storeman"" onmouseout=""this.style.backgroundColor='#ffffff'"" onmouseover=""this.style.backgroundColor='#ddeeee'"" style='cursor:hand' Tag="""_$G(StoremanId)_""" onclick=""ChangeStoreMan(this)"">"_$G(Storeman)_"<td width=50>&nbsp;<td><b>Ответственный<br>за закрытие<td>"_$G(UserClose)
	w "</table>"
	Write !,"<tr height=100%><td>",!
	Write "<SKLADiGrid:iGrid id=""docstr"" width=""100%"" height=""300"" Enabled=""true""/>",!
	Write "<tr><td>",!
	Write "<center><br>",!
	If '(Stat'=2) Goto %csp00001 ;{
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""startFun();"" TITLE=""""><center>Сохранить</center></span>"
	Write !
%csp00001	;}
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""winclose();"" TITLE=""""><center>Отмена</center></span>"
	Write "</center>",!
	Write "</table>",!
	Write "</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !
	s DocId=%request.Get("DocId")
	s ClassName=%request.Get("ClassName")
	Write !
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<script language=""jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<script language=""JScript"">"
	Write !,"var DocId="""_($G(DocId))_""";",!
	Write "var ClassName="""_($G(ClassName))_""";",!
	Write "var sessionid="""_($G(sessionid))_""";",!
	Write !,"function load(){",!
	Write "var Captions = new Array(5);",!
	Write "var Keys = new Array(5);",!
	Write "var Tags = new Array(5);",!
	Write !,"Captions[0]=""Место"";",!
	Write "Captions[1]=""Товар"";",!
	Write "Captions[2]=""Количество по накладной"";",!
	Write "Captions[3]=""Фактическое количество"";",!
	Write "Captions[4]=""Изображение"";",!
	Write !,"Tags[0]=""Store.Address"";",!
	Write "Tags[1]=""Goods.Goods"";",!
	Write "Tags[2]=""%Numeric"";",!
	Write "Tags[3]=""%Numeric"";",!
	Write "Tags[4]=""%String"";",!
	Write !,"Keys[0]=""addr"";",!
	Write "Keys[1]=""Goods"";",!
	Write "Keys[2]=""quantdefault"";",!
	Write "Keys[3]=""quantreal"";",!
	Write "Keys[4]=""image"";",!
	Write "docstr.DrawHeaders(Captions,Keys,Tags);",!
	Write "docstr.loadfrommethod(""Docs.Action2.InnerInstructNewStr"",DocId,"""",ClassName+""Items"");",!
	Write "}",!
	Write !,"function startFun()",!
	Write "{",!
	Write "	var InnerSplitter=""~"";",!
	Write "	xmlDoc=docstr.GetXmlContentByRows();",!
	Write "	InsertXmlHeader(xmlDoc,""storeman"",storeman.Tag,""Common.Dictionary5"")",!
	Write "	var DocID=SendXml(DocId,ClassName,xmlDoc,sessionid);",!
	Write "	if(isNaN(DocID)){alert(DocID);return}",!
	Write "	var ok3="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.PrihNeedsDiff:csp.innerinstructnew"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',DocID)",!
	Write "	if(isNaN(ok3)&&(ok3!=""yes"")){alert(ok3);return false;}",!
	Write "	if(ok3==""yes"")",!
	Write "	{",!
	Write "		okdiff=window.showModalDialog(""docinnerdiff.csp?source=""+DocID,""Docs.InnerDiff""+InnerSplitter+""""+InnerSplitter+"""",""center:yes;status:no;dialogHeight:600px;dialogWidth:800px;resizable:yes;"")",!
	Write "		if(okdiff!=1)",!
	Write "		{",!
	Write "			if(okdiff!=null)alert(okdiff);",!
	Write "			return false;",!
	Write "		}",!
	Write "	 	var ok2="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.SetSourceDoc:csp.innerinstructnew"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',""Docs.InnerDiff"",okdiff,DocID)",!
	Write "	}	 ",!
	Write "	returnValue=1;",!
	Write "	window.close();",!
	Write "}",!
	Write !,"function SendXml(DocID,ClassName,xmlDoc,sessionid)",!
	Write "{",!
	Write "	var xmlhttp = new ActiveXObject(""Msxml2.XMLHTTP"");",!
	Write "	xmlhttp.open(""POST"",""xmlmethod.csp?classmethod=Docs.Action.SaveStorageDoc&id=""+DocID+""&documentclass=""+ClassName+""&sessionid=""+sessionid, false);",!
	Write "	xmlhttp.send(xmlDoc)",!
	Write "	var ok=xmlhttp.responseText;",!
	Write "	return ok;",!
	Write "}",!
	Write !," function winclose(){",!
	Write " if(window.confirm(""Вы уверены?""))window.close();",!
	Write " }",!
	Write " ",!
	Write "function ChangeStoreMan(TdObject){",!
	Write "var newItem=window.showModalDialog(""Dictionary.csp"",""Common.Dictionary5"",""center:yes;status:no;dialogHeight:400px;dialogWidth:650px;resizable:yes;"");",!
	Write "if(newItem==null){return false;}",!
	Write "newArr=newItem.split(""~"");",!
	Write "TdObject.Tag=newArr[0];",!
	Write "TdObject.innerText=newArr[1];",!
	Write " }",!
	Write "</script>"
	Write !,"<title>"_($G(%session.Data("systemname")))_"</title>",!
	Write "<style>"
	Write !,"td{",!
	Write "font-family:Arial;",!
	Write "font-size:14px;",!
	Write "}",!
	Write "</style>"
	Write !,(..HyperEventHead())
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLADiGrid>"
	Write !,"<IMPORT NAMESPACE=""SKLADiGrid"" IMPLEMENTATION=""htc/iGridV7.htc"">",!
	Do ..OnPageHEAD()
	Write !,!
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  i %session.NewSession d
  . s %session.EndSession=1
  . s sessionid=%request.Get("sessionid",1)
  . s %session=%session.GetSession(sessionid)
  .  s login=$G(%session.Data("user"))
  . i '+login s %response.ServerSideRedirect="norights.csp" 
  e  s sessionid=%session.SessionId
  
 Quit 1
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\InnerInstructNew.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/InnerInstructNew.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62046,65254</Default>
</Parameter>
</Class>
</Export>
