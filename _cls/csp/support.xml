<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.support">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62189,53547.998195</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body TOPMARGIN=""15"" LEFTMARGIN=""15"" MARGINWIDTH=""15"" MARGINHEIGHT=""15"" BACKGROUND=""images/mainbg.gif"">"
	Write !,"<table BGCOLOR=""#BDBFC1"" width=""100%"" height=""100%"">",!
	Write "<tr><td>"
	Write "<img src=""images/logo_aska.jpg"" alt=""Логотип Aska"">"
	Write "</td>",!
	Write "<Td align=""center"" valign=""top"">",!
	Write "<b style=""font-size:16px;"">Обращения в сервисный центр Aska Elc.</b></td>",!
	Write "</td>",!
	Write "<td valign=""top"" align=""right"">",!
	n login,password,KontrId,ErrorMessage,glob,Dat,Tim,Result
	s login=%request.Get("login")
	s password=$TR(%request.Get("password")," ","")
	s Result=%request.Get("Result")
	if password'="" d
	. s KontrId=##class(Common.Rights).CheckKontragentLoginPassword(login,password)
	. if '+KontrId s ErrorMessage="<font color=""red"">неверный пароль</font>"
	w "<table><tr><td colspan=""2""><img src=""images/brace.gif"" width=""120px"" height=""1""></td></tr><form name=""mainform"" method=""post"">"
	if (password'="")&&('+$G(KontrId)) &html<
	<Tr height=1%><td colspan="2"><b style="font-size:13px;">Регистрация #($G(ErrorMessage))#</b></td></tr>
	<tr><td>Логин</td><td><input type="text" id="login" name="login" value="#(login)#"></td></tr>
	<tr><td>Пароль</td><td><input type="password" id="password" name="password"></td></tr>
	<tr><td>&nbsp;</td><td><Input type="submit" value="ok" name="ok" id="ok" style="width:50px"></td></tr>
	>
	else  if +$G(KontrId) d
	. s KontrObj=##class(Common.Kontragent).%OpenId(KontrId)
	. if '+KontrId w "<tR><td>Ошибка на сервере. Пожалуйста сообщите в сервис по телефону или посредством электронной почты.</td></tr>" q
	. s KontrName=KontrObj.Name
	. s KontrEmail=KontrObj.EMail
	. s MailDestination=KontrObj.NotifyEmails
	. s MailText = "Новое сообщение в системе Аска-Склад."_$C(13,10)_"Клиент: "_KontrName_$C(13,10)_"Дата: "_$ZDT($H,4)_$C(13,10)_"Сообщение: "_Result
	. s MailSubject = "Сообщение от клиента "_KontrName
	. if Result'="" d
	. . //сохраняем сообщение которое ввели на странице
	. . n KMeet,ok
	. . s KMeet=##class(Kontragent.Meeting).%New()
	. . s KMeet.MessageType=2
	. . s KMeet.Result=Result
	. . s KMeet.Dat=+$H
	. . s KMeet.Tim=$P($H,",",2)
	. . d KMeet.KontrSetObjectId(KontrId)
	. . s ok=KMeet.%Save()
	. . if '+ok d
	. . . w "<tR><td>Ошибка. Ваше сообщение не было сохранено.</td></tr>"
	. . else  d
	. . . s SendMailResult = ##class(Kontragent.Action).SendMailNotification(MailDestination,"",MailText,MailSubject)
	. . . if 'SendMailResult w "<tr><td>Извините. Ваше сообщение сохранено, но возникла ошибка при отправке уведомления. Сообшите пожалуйста в офис Aska Elc.</td></tr>"
	. &html<
	<tr><td colspan="2">Добро пожаловать</td></tr>
	<tr><td colspan="2"><b style="color:black">#(KontrName)#</b></td></tr>
	<Input type="hidden" name="password" value="#(password)#"> <Input type="hidden" name="login" value="#(login)#"> 
	>
	else  &html<
	<form name="mainform" method="post">
	<Tr><td colspan="2"><b style="font-size:13px;">Регистрация #($G(ErrorMessage))#</b></td></tr>
	<tr><td>Логин</td><td><input type="text" id="login" name="login" value="#(login)#"></td></tr>
	<tr><td>Пароль</td><td><input type="password" id="password" name="password"></td></tr>
	<tr><td>&nbsp;</td><td><Input type="submit" value="ok" name="ok" id="ok" style="width:50px"></td></tr>
	>
	w "</table>",!
	&html<
	</td>
	</tr>
	<tr height=1% valign="top"><td colspan="3">
	Текст письма в офис Aska Elc.<br>
	<textarea cols="60" rows="7" name="Result"></textarea><br>
	<Input type="submit" value="Отправить" name="ok" id="ok" style="width:80px">
	</form>
	</td></tr>
	<tr height="98%">
	<td valign="top" colspan="3">
	<hr width="80%">
	>
	if +$G(KontrId) d
	. s glob=$NA(^mtempGlobal($I(^mtempGlobal)))
	. k @glob
	. &sql(declare joke cursor for 
	select Dat,Tim,Result,MessageType
	into :Dat,:Tim,:Result,:MessageType
	from Kontragent.Meeting where MessageType in (2,3) and Kontr=:KontrId)
	. &sql(open joke)
	. f  &sql(fetch joke) q:SQLCODE  d
	. . s @glob@(Dat,Tim)=Result
	. . s @glob@(Dat,Tim,"MessageType")=MessageType
	. &sql(close joke)
	. s Dat="" f  s Dat=$O(@glob@(Dat),-1) q:Dat=""  d
	. . s Tim="" f  s Tim=$O(@glob@(Dat,Tim),-1) q:Tim=""  d
	. . . if @glob@(Dat,Tim,"MessageType")=3 w "<font color=""darkred"">"
	. . . w "<span style=""font-size:12px;"">"_$ZD(Dat,4)_" "_$ZT(Tim)_"</span><br>"
	. . . w $G(@glob@(Dat,Tim))_"<br><br>"
	. . . if @glob@(Dat,Tim,"MessageType")=3 w "</font>"
	Write !,"</td>",!
	Write "</tr>",!
	Write "</table>",!
	Write "</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<meta http-equiv=""Content-Type"" content=""text/html;charset=windows-1251"">"
	Write !,"<title>	Обращение в сервисный центр Asca Elc. </title>",!
	Write "<style>"
	Write !,"TD{",!
	Write "font-family:Arial;",!
	Write "font-size:14px;",!
	Write "color:#122211;",!
	Write "}",!
	Write "input{border:1 solid grey;width:150px}",!
	Write "</style>"
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html>"
	Write !
	Do ..OnPageHEAD()
	Write !,!
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Parameter name="CHARSET">
<Default>windows-1251</Default>
</Parameter>

<Parameter name="CONTENTTYPE">
<Default>text/html</Default>
</Parameter>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\Support.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/Support.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62115,46551</Default>
</Parameter>
</Class>
</Export>
