<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.createanalogs">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62155,52467.015717</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""load();"" onkeypress=""ManageWindow();"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !,"<a href=""#"" onclick=""window.location.href='tuneup.csp'"">"
	Write "Вернуться к настройкам"
	Write "</a>"
	Write !,"<table height=100% width=100% border=0>",!
	Write "<tr ><td width=50% valign=""top"">",!
	Write "<fieldset><legend>Отбор из группы</legend>",!
	Write "Классификатор:"
	Write "<select id=""Catalogues"" onchange=""LoadTree()"" style=""behavior:url('#default#download');"">"
	Write "</select>"
	Write "<br>",!
	Write "  <SKLADz:treeview id=""GroupsTree"" width=""400"" height=170 ImagesPath="""_(%session.Data("ImagesPath"))_""" zonClick=""GroupsTreeClick();"" onDownloadCmpl=""LoadPropTree()"" />",!
	Write "  <br>",!
	Write "  "
	Write "<input type=""button"" id=""SelectWholeGroup"" value=""выбрать всю ветку"" onclick=""AddFromWholeGroup()"">"
	Write !," </fieldset>",!
	Write "</td>",!
	Write "<td width=50% valign=""top"">",!
	Write "Деталь: <b>"
	Write "<span id=""DetailName"">"
	Write "</span>"
	Write "</b><br>",!
	Write "Аналог: <b>"
	Write "<span id=""AnalogName"">"
	Write "</span>"
	Write "</b>",!
	Write "<br>"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;width=100px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""startFun();"" TITLE=""""><center>Установить связь детали и аналога</center></span>"
	Write !,!,"</td></tr>",!
	Write !,"<tr><td valign=""top""  colspan=2>",!
	Write "<!--",!
	Write "<span id=""namfld""></span>&nbsp;<input type=""text"" id=""fldval"" onkeyup=""gg();"">",!
	Write "-->"
	Write !,"<fieldset id=""SelectedGoods""><legend>Выбранные товары</legend>",!
	Write " 	<SKLADList:listview width=100% height=130 id=""TempGoods""  ClassName=""Goods.Goods"" AddOnClear=""false"" zonDblClick=""ReturnSelected();""  AddHeaders=""true""/><br>",!
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""SetAsDetail();"" TITLE=""""><center>Это нужная деталь</center></span>"
	Write " ",!
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""SetAsAnalog();"" TITLE=""""><center>Это аналог</center></span>"
	Write !,"</fieldset>",!
	Write "</td></tr>",!
	Write "</table>",!
	Write "</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<title>"_($G(%session.Data("systemname")))_"</title>",!
	Write "<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<script language=""Jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<script language=""JScript"">"
	Write !,"//Arguments=window.dialogArguments.split(InnerSplitter);",!
	Write "CardId="""";",!
	Write "DetailId="""";",!
	Write "AnalogId="""";",!
	Write "var CurrentProperty;",!
	Write "var Objvalue;",!
	Write "var InCard=false;",!
	Write "var FromTable="""";",!
	Write "var FromTree="""";",!
	Write "var Number=0;",!
	Write "ExpressType2="""";",!
	Write "var ColCode="""";",!
	Write "var depot="""_($G(%session.Data("depot")))_"""",!
	Write "var commongroups="""_($G(%session.Data("commongroups")))_"""",!
	Write !,"function startFun(){",!
	Write "if(DetailId==""""){alert(""Не установлена заменяемая деталь."");return false;}",!
	Write "if(AnalogId==""""){alert(""Не установлен аналог."");return false;}",!
	Write "var ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Common.Common.SetDetailAnalogRelation:csp.createanalogs"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',DetailId,AnalogId)",!
	Write "if(isNaN(ok)){alert(ok)}",!
	Write "else{",!
	Write "	alert(""Пара взаимозаменяемых деталей установлена успешно."")",!
	Write "	DetailId="""";",!
	Write "	AnalogId="""";",!
	Write "	DetailName.innerText="""";",!
	Write "	AnalogName.innerText="""";",!
	Write "	}",!
	Write "}",!
	Write !,"function ReturnSelected(){",!
	Write "ResultArray=TempGoods.ListViewGetItems(""selected"");",!
	Write "returnValue=ResultArray;",!
	Write "window.close();	",!
	Write "}",!
	Write !,"function load(){",!
	Write "window.dialogWidth=screen.availWidth+""px"";",!
	Write "//alert(screen.availWidth+""X""+screen.availHeight+""\n""+window.dialogWidth+""X""+window.dialogHeight)",!
	Write "TempGoods.attachEvent(""onAddColumns"", addcol)",!
	Write "TempGoods.LoadHeaders(""izdelie,Description,Property312,Property675,Property9469,abbr,Composition"");",!
	Write "Catalogues.startDownload(strForGroups(depot,commongroups), putCatalogue);",!
	Write "}",!
	Write !,"function addcol(){",!
	Write "TempGoods.detachEvent(""onAddColumns"", addcol)",!
	Write "fields=TempGoods.GetColumns(""Goods->"");",!
	Write "//TempGoods.AddColumns(""quant~Количество~~~@%String#@#"")",!
	Write "}",!
	Write !,"function putCatalogue(text){",!
	Write "addOptions(text,""Catalogues"");",!
	Write "LoadTree();",!
	Write "}",!
	Write !,"function LoadTree(){",!
	Write "GroupsTree.AdditionalID=Catalogues.value;",!
	Write "GroupsTree.DownLoad('Data.csp?class=Goods.Group&fields=Parent,Code,Name,ID&params=""'+depot+'"",""'+Catalogues.value+'""')	",!
	Write "}",!
	Write !,"// добавить товар в таблицу из текущей ветки",!
	Write "function AddFromGroup(){",!
	Write "var where=""Groups='""+GroupsTree.NodeID+""'""",!
	Write "TempGoods.loadfrommethod(""Goods.GoodsAction.fromgroup"",where,fields,0)",!
	Write "}",!
	Write !,"// добавить товар в таблицу из всех подветок данной ветки",!
	Write "function AddFromWholeGroup(){",!
	Write "var where=""Groups->Depot='""+depot+""' and Groups->Catalogue='""+Catalogues.value+""' and Groups->Code %STARTSWITH '""+GroupsTree.NodeCode+""'"";",!
	Write "TempGoods.loadfrommethod(""Goods.GoodsAction.fromgroup"",where,fields);",!
	Write "}",!
	Write !,"function AddFromSelect(){",!
	Write "if(ThisGroupOnly.checked){var GroupCondition=""Groups->Depot='""+depot+""' and Groups->Catalogue='""+Catalogues.value+""' and Groups->Code %STARTSWITH '""+GroupsTree.NodeCode+""'"";}",!
	Write "else{var GroupCondition="""";}",!
	Write "var where=GroupCondition+FromTable;",!
	Write "TempGoods.loadfrommethod(""Goods.GoodsAction.fromgroup"",where,fields)",!
	Write "}",!
	Write !,"function TableClick(){",!
	Write "	ExpressType=""FromTable"";",!
	Write "	CurrentProperty=PropTable.CurrentRowTag;",!
	Write "	Pname.innerText=PropTable.CurrentRowName;",!
	Write "	newObj=PropTable.CurrentRowElement.cloneNode(true);",!
	Write "	Pvalue.innerHTML="""";",!
	Write "	Pvalue.appendChild(newObj);",!
	Write "}",!
	Write !,"//функция нужна для совместимости с table.htc",!
	Write "function cellaction(oo){",!
	Write "}",!
	Write !,"//функция нужна для совместимости с table.htc",!
	Write "function getDivChange(oo){",!
	Write "}",!
	Write !,"//открыть карточку товара",!
	Write "function OpenCard(){",!
	Write "GoodsId=SelectedItemProperty(GoodsListView,""Tag"");",!
	Write "GoodsName=SelectedItemProperty(GoodsListView,'Text');",!
	Write "if(GoodsId=="""")return",!
	Write "ok=window.showModalDialog(""GoodsCard.csp?GoodsId=""+GoodsId+""&groupspath=""+GroupsTree.ParentNames,GoodsId+InnerSplitter+GoodsName,""center:yes;status:no;dialogHeight:600px;dialogWidth:650px;resizable:yes"")",!
	Write "if(ok==1){ShowTovars()}",!
	Write "}",!
	Write !,"function GroupsTreeClick(){",!
	Write "	AddFromGroup();",!
	Write "}",!
	Write !,"// Установить текущую позицию Листа как деталь",!
	Write "function SetAsDetail(){",!
	Write "var currentSelection=TempGoods.ListViewGetItems(""selected"");",!
	Write "DetailId=currentSelection.split(InnerSplitter)[0];",!
	Write "DetailName.innerText=currentSelection.split(InnerSplitter)[8];",!
	Write "}",!
	Write !,"// Установить текущую позицию Листа как аналог выбранной детали",!
	Write "function SetAsAnalog(){",!
	Write "var currentSelection=TempGoods.ListViewGetItems(""selected"");",!
	Write "var AnalogsArray=currentSelection.split(StringSplitter);",!
	Write "AnalogId="""";",!
	Write "for(var i=0;i<AnalogsArray.length-1;i++){",!
	Write "	var CurrentAnalog=AnalogsArray[i];",!
	Write "	var CurrentAnalogArray=CurrentAnalog.split(InnerSplitter)",!
	Write "	AnalogId=AnalogId+CurrentAnalogArray[0]+InnerSplitter;",!
	Write "	AnalogName.innerHTML=AnalogName.innerHTML+""<br>""+CurrentAnalogArray[8];	",!
	Write "	}",!
	Write "}",!
	Write "</script>"
	Write !,(..HyperEventHead())
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLADz XMLNS:SKLADList XMLNS:SKLAD2>"
	Write !,"<IMPORT NAMESPACE=""SKLADList"" IMPLEMENTATION=""htc/listview.htc"">",!
	Write "<IMPORT NAMESPACE=""SKLADz"" IMPLEMENTATION=""htc/treeview.htc"">",!
	Write "<IMPORT NAMESPACE=""SKLAD2"" IMPLEMENTATION=""htc/table.htc"">",!
	Write !
	Do ..OnPageHEAD()
	Write !
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\CreateAnalogs.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/CreateAnalogs.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62155,52468</Default>
</Parameter>
</Class>
</Export>
