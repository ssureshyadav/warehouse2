<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.createinstruct">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>60953,39364.803266</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""load();"" onkeypress=""ManageWindow();"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !,"<fieldset style=""width:100%;height:200""><legend>Основные свойства</legend>",!
	Write "<span id=""RashOplatTypeBlock"" style=""display:none;"">"
	Write !,"Оплата: "
	Write "<select style=""width:150px;behavior:url(#default#download)"" name=""RashOplatType"" id=""RashOplatType"">"
	Write !,"</select>"
	Write !,"</span>"
	Write !,"<SKLAD2:table id=""PropTable"" width=""100%"" onPropChange=""prchange();""  />",!
	Write "</fieldset>",!
	Write "  "
	Write !,"<img src=""images/new.gif"" onmouseover=""newtov.src='images/Onnew.gif'"" onmouseout=""newtov.src='images/new.gif'""  id=""newtov"" name=""newtov"" alt=""Просмотреть склады"" onclick=""lookstore()"" style="""">"
	Write !,"<fieldset><legend>Товары</legend>",!
	Write "<!--",!
	Write " <SKLADList:listview width=100% height=100 id=""instritems"" ClassName=""Goods.Goods"" AddOnClear=""false"" onAddColumns=""LoadFromCard()"" /><br>",!
	Write "-->"
	Write !,"<SKLAD2:table id=""docstr"" width=100% height=180 CountTotal=""true"" displaybar=true OnCellChange=""docstrPropChange()"" />",!
	Write !,"<img src=""images/new+.gif"" onmouseover=""newtov1.src='images/Onnew+.gif'"" onmouseout=""newtov1.src='images/new+.gif'""  id=""newtov1"" name=""newtov1"" alt=""Добавить товары"" onclick=""addtovar()"" style="""">"
	Write !,!,"<img src=""images/del.gif"" onmouseover=""deltov1.src='images/Ondel.gif'"" onmouseout=""deltov1.src='images/del.gif'""  id=""deltov1"" name=""deltov1"" alt=""Удалить выбранные товары из списка"" onclick=""deltovars()"" style="""">"
	Write !,"</fieldset>",!
	Write "<center><br>"
	Write !,"<span class=ButtonDiv style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""startFun();"" ><center>Сохранить</center></span>"
	Write !,"<span class=ButtonDiv style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""winclose();"" ><center>Отмена</center></span>"
	Write "</center>",!
	Write "</table>",!
	Write "</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	s source=%request.Get("source")
	Write !
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<title>"_($G(%session.Data("systemname")))_"</title>",!
	Write "<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<script language=""Jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<script language=""JScript"">"
	Write !,"var user="""_($G(%session.Data("user")))_""";",!
	Write "var argArr=window.dialogArguments.split("";"");",!
	Write "var ClFromOper = new Array();",!
	Write "var ItemID=argArr[0];  //ID открываемого документа (или """" если новый документ)",!
	Write "var ClassName=argArr[1];  //класс документа Operation.Instructions",!
	Write "var OperationType="""";  //тип операции (напр. заказ на поставку зап частей)",!
	Write !,"// Сохранение данных по кнопке СОХРАНИТЬ",!
	Write "function startFun(){",!
	Write "var OperationType=PropTable.item(""Oper"")",!
	Write "if(OperationType==""""){alert(""Выберете, пожалуйста, шаблон операции."");return}",!
	Write "ItemID=argArr[0];",!
	Write "	",!
	Write "	if(ReturnSpace(ItemID)==""""){question=""Создать запись?""}",!
	Write "	else{question=""Изменить запись?""}",!
	Write !,"if(!window.confirm(question))return false;",!
	Write !,"var xmldoc=PropTable.GetXmlContent();",!
	Write "var xmldoc2=docstr.GetXmlContent();",!
	Write !,"if(OperationType==10){  //если выбрали комплектацию зап частей то вставим в xml способ оплаты",!
	Write "	var RashOplatTypeValue=RashOplatType.value;",!
	Write "	addnode(xmldoc,""RashOplatType"",RashOplatTypeValue)",!
	Write "	}",!
	Write !,"var ItemID=SplitSendXml(ItemID,ClassName,xmldoc,xmldoc2,"""_(%session.SessionId)_""");",!
	Write "	if(isNaN(ItemID)){alert(ItemID);}",!
	Write "	else{",!
	Write "		window.returnValue=1;",!
	Write "		window.close();",!
	Write "	}",!
	Write "}",!
	Write !,"function load(){",!
	Write "source="""_(source)_""";",!
	Write "if(ItemID!=""""){",!
	Write "	PropTable.Silent=""Oper"";",!
	Write "	var showfields=""postnumber,postdata,RashOplatType"";",!
	Write "	}",!
	Write "else{var showfields="""";}",!
	Write "PropTable.DownLoadPairs(ClassName,ItemID,""Doc,DocType,Tim,Dat,Summa,Stat,State,Source,innerinstr,Operation,User1,postnumber,postdata"",source,showfields);",!
	Write "//instritems.LoadHeaders();",!
	Write "docstr.ClassName=ClassName+""Items"";",!
	Write "docstr.attachEvent(""onAddColumns"",loadgoods2)",!
	Write "//docstr.LoadHeadersXML(""Doc,DocType,quantplan,addr,addr2,spravka,Client,goodsdir,garant,sn"");",!
	Write "docstr.LoadHeadersXML(""Doc,DocType,quantplan,addr,addr2,spravka,Client,goodsdir,garant,sn,seller,opispolomki"");",!
	Write "}",!
	Write !,"//товары взять из строк документа",!
	Write "function loadgoods2(){",!
	Write "if(ItemID!=""""){",!
	Write "docstr.loadfrommethod(""Docs.Action.GetStrFromDoc"",ItemID+""@""+docstr.ClassName,2,3)}",!
	Write "}",!
	Write !,"// функция открывает окошко со складами и записывает выбранный склад в текущую инструкцию",!
	Write "function lookstore(){",!
	Write "	mok=window.showModalDialog(""storemodal.csp"","""",""cener:yes;status:no;dialogHeight:500px;dialogWidth:600px;resizable:yes;"");",!
	Write "	if(mok==null)return",!
	Write "	PropTable.setCellValue(""Depot1"",mok.split(InnerSplitter)[1],mok.split(InnerSplitter)[0])",!
	Write "}",!
	Write !,"//function addtovar(){",!
	Write "//	tovars=window.showModalDialog(""selectgoods2.csp"","""",""cener:yes;status:no;dialogHeight:700px;dialogWidth:800px;resizable:yes;"")",!
	Write "//	if(tovars==null)return",!
	Write "//	instritems.ListViewAddItems(tovars)",!
	Write "//}",!
	Write !,"function addtovar(){",!
	Write "WinResult=window.showModalDialog(""selectgoods2.csp"","""",""center:yes;status:no;dialogHeight:700px;dialogWidth:800px;resizable:yes;"")",!
	Write "if(WinResult==null)return",!
	Write "WinResult=WinResult.split(StringSplitter)",!
	Write "var FieldCaption = new Array();",!
	Write "var FieldValue = new Array();",!
	Write "for(i=0 ; i<WinResult.length-1 ; i++){",!
	Write "	var onestr=WinResult[i].split(InnerSplitter);",!
	Write "	FieldCaption[""Goods""]=onestr[4] + "" "" + onestr[8] + "" "" + onestr[1];",!
	Write "	FieldValue[""Goods""]=onestr[0];",!
	Write "	FieldCaption[""Price""]=getPrice(FieldValue[""Goods""]);",!
	Write "	docstr.AddRow(FieldCaption,FieldValue);",!
	Write "}",!
	Write "}",!
	Write !,"function getPrice(tovid){",!
	Write "return "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Goods.GoodsAction.getprice:csp.createinstruct"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',tovid);",!
	Write "}",!
	Write !,!,"function deltovars(){",!
	Write "//	instritems.DelItems();",!
	Write "}",!
	Write !,"function LoadFromCard(){",!
	Write "//	instritems.GetFromCard(ItemID+""@""+ClassName);",!
	Write "}",!
	Write !,"function prchange(){",!
	Write "if(PropTable.ChangedProp==""Oper""){",!
	Write "	docstr.delrows(""all"");",!
	Write "	//alert(docstr.ClassName+""\n""+PropTable.item(""Oper"")+""\n""+PropTable.ChangedProp);",!
	Write "	ChangeInstructionType();",!
	Write "	",!
	Write "}",!
	Write "}",!
	Write !,"// смена типа инстрации ",!
	Write "function ChangeInstructionType(){",!
	Write "OperationType=PropTable.item(""Oper"");",!
	Write "if(ClFromOper[OperationType]==null){ClFromOper[OperationType]="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.GetPageFromOper:csp.createinstruct"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',OperationType,'cl')}",!
	Write "classn=ClFromOper[OperationType];",!
	Write "if(classn==""Docs.Rash,Docs.Remont"")docstr.LoadHeadersXML(""Doc,DocType,quantplan,addr,addr2,spravka,Client,goodsdir,sn,Total"");",!
	Write "if((classn==""Docs.Prih"")||(classn==""Docs.Rash""))docstr.LoadHeadersXML(""Doc,DocType,quantplan,addr,addr2,spravka,Client,goodsdir,garant,sn,seller,opispolomki"");",!
	Write "if(classn==""Docs.Inner"")docstr.LoadHeadersXML(""Doc,DocType,spravka,Client,goodsdir,garant,sn,quantplan,seller,opispolomki"");",!
	Write "if(classn==""Docs.Invent"")docstr.LoadHeadersXML(""Doc,DocType,addr2,spravka,Client,goodsdir,garant,sn,seller,opispolomki"");",!
	Write "if(classn==""Docs.Utiliz"")docstr.LoadHeadersXML(""Doc,DocType,addr2,quantplan,seller,opispolomki"");",!
	Write "if(classn==""Docs.DocBrak"")docstr.LoadHeadersXML(""Doc,DocType,addr2,quantplan,opispolomki,spravka,Client,goodsdir,garant,sn,seller,opispolomki,addr"");",!
	Write !,"HideOrDisplaySelect()",!
	Write "}",!
	Write !,"// скрыть или показать выпадающий список с типом оплаты (гарантия/платно)",!
	Write "function HideOrDisplaySelect(){",!
	Write "var InstructionOper = PropTable.item(""Oper"");",!
	Write "if(InstructionOper==10){",!
	Write "	RashOplatType.startDownload('Data.csp?class=Common.Dictionary7&fields=ID,Name', put);",!
	Write "}",!
	Write "else{RashOplatTypeBlock.style.display=""none"";}",!
	Write "}",!
	Write !,"function put(textStr){",!
	Write "addOptions(textStr,""RashOplatType"");",!
	Write "RashOplatTypeBlock.style.display=""block"";",!
	Write "}",!
	Write !,"function getstorecell(goods,addr){",!
	Write "var val="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Store.Action.getquantaddr:csp.createinstruct"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',goods,addr)",!
	Write "return val",!
	Write "}",!
	Write !,"function winclose(){",!
	Write "if(window.confirm(""Закрыть окно?"")){window.close();}",!
	Write "}",!
	Write !,"// обработчик события OnCellChange таблицы строк документов",!
	Write "function docstrPropChange(){",!
	Write "if(OperationType!=10){",!
	Write "	if(docstr.cellChange.colname==""Quantity""){",!
	Write "		var newQuantity=docstr.cellChange.value;",!
	Write "				",!
	Write "		var price = docstr.item(""Price"")",!
	Write "		",!
	Write "		var NewTotal=price*newQuantity;",!
	Write "		if(typeof(NewTotal)==""number""){var NewTotal=NewTotal.toFixed(2)}",!
	Write "		if(NewTotal==""NaN""){return}",!
	Write "		docstr.setCellValue(""Total"",NewTotal)",!
	Write "	}",!
	Write "}",!
	Write "}",!
	Write "</script>"
	Write !,(..HyperEventHead())
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLAD2 XMLNS:SKLADList>"
	Write !,"<IMPORT NAMESPACE=""SKLADList"" IMPLEMENTATION=""htc/listview.htc"">",!
	Write "<IMPORT NAMESPACE=""SKLAD2"" IMPLEMENTATION=""htc/table.htc"" >",!
	Do ..OnPageHEAD()
	Write !
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\createinstruct.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/createinstruct.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>60618,59632</Default>
</Parameter>
</Class>
</Export>
