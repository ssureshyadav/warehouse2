<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.planigrid">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62181,50264.582338</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""load()"" onkeypress=""ManageWindow();"">"
	Write !,"<table width=100%><tr><td>",!
	Write "<table class=""LeftTop"" cellspacing=0 width=100%>",!
	s PlanID=%request.Get("source")
	i PlanID {
	&sql(select Name,Comment,PlanDate,PlanDate2,Kontr,Kontr->Name,CloseDate,CloseTime,CloseUser->Name,Stat,DocLanguage,Summa 
	into :Name,:Comment,:PlanDate,:PlanDate2,:Kontr,:KontrName,:CloseDate,:CloseTime,:CloseUserName,:Stat,:DocLanguage,:Summa
	from Operation.Plan where ID=:PlanID)
	i SQLCODE w "<tr><td colspan=4>Ошибка при выводе плана "_InstrID_"<br>SQLCODE="_SQLCODE_"</td></tr>"
	i Stat=2 d
	. s ClosedString=CloseUserName_" "_$S(CloseDate:$ZD(CloseDate,4),1:"")_" "_$S(CloseTime:$ZT(CloseTime),1:"")
	. s SaveButtonStyle="display:none"
	}
	w "<tr>"
	w "<td class=RightBottom>Номер<td class=RightBottom><input type=text id=Name MAXLENGTH=50 value='"_$G(Name)_"'>"
	w "<td class=RightBottom>Комментарий<td class=RightBottom><input type=text id=Comment MAXLENGTH=1000 Value='"_$G(Comment)_"'>"
	w "</tr>"
	w "<tr>"
	w "<td class=RightBottom>Язык документа<td class=RightBottom><select id=""DocLanguage"">"_##class(Docs.Action2).GetDisplaylistOptions($G(DocLanguage),"Operation.Plan||DocLanguage")_"</select>"
	w "<td class=RightBottom>Контрагент<td class=RightBottom><span onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"" class=Kontragent onclick=""ChooseKonragent(this)"" oncontextmenu=""this.innerText='';this.Tag=''"" id=""Kontr"" Tag='"_$G(Kontr)_"'>"_$G(KontrName)_"</span>"
	w "</tr>"
	w "<tr>"
	w "<td class=RightBottom>Начальная дата<td class=RightBottom><input type=text id=""PlanDate"" value='"_$ZD($G(PlanDate,$H),4)_"' onclick=""fnCalendar(this)"" class=""datar"" onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"">"
	w "<td class=RightBottom>Конечная дата<td class=RightBottom><input type=text id=""PlanDate2"" value='"_$ZD($G(PlanDate2,$H),4)_"' onclick=""fnCalendar(this)"" class=""datar"" onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"">"
	w "</tr>"
	w "<tr>"
	w "<td class=RightBottom>Сумма<td class=RightBottom><input type=text id=""Summa"" value='"_$G(Summa)_"' >"
	w "<td class=RightBottom>&nbsp;<td class=RightBottom>&nbsp;"
	w "</tr>"
	w:$G(ClosedString)'="" "<tr><td colspan=4 class=RightBottom>Создана инструкция на приём <i>"_ClosedString_"</i></tr>"
	Write !,"</table>",!
	Write "<tr height=100%><td>",!
	Write "<SKLADiGrid:iGrid id=""docstr"" width=""100%"" height=""300"" Enabled=""true"" RowMode=""true"" /><br>",!
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""AddGood();"" TITLE=""""><center>Добавить товар</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""RemoveRow();"" TITLE=""""><center>Удалить строку</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""ClearGrid();"" TITLE=""""><center>Очистить строки</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:160px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""Summa.value=docstr.GetTableSumma();"" TITLE=""""><center>Пересчитать сумму</center></span>"
	Write !,"<tr><td>",!
	Write "<center><br>"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"_($G(SaveButtonStyle))_""" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""startFun();"" TITLE=""""><center>Сохранить</center></span>"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""windowclose();"" TITLE=""""><center>Отмена</center></span>"
	Write "</center>",!
	Write "</table>",!
	Write !,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<style>"
	Write !,".LeftTop{border-left : 1 solid black;border-top : 1 solid black;}",!
	Write ".RightBottom{font-family:Arial;font-size:14px;border-right : 1 solid black;border-bottom : 1 solid black;}",!
	Write "SELECT{width:170px}",!
	Write ".Kontragent{width:170px;cursor:hand;}",!
	Write ".ZakazInstr{display:inline;}",!
	Write "</style>"
	Write !,"<script language=""jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<title>План</title>",!
	Write !,"<script language=""Jscript"">"
	Write !,"var DocId='"_(%request.Get("source"))_"';",!
	Write "var OriginalInstructionId=DocId;",!
	Write "var sessionid="""_(sessionid)_""";",!
	Write !,"//функция выбора контрагента (подставит выбранного в innerText переданного объекта",!
	Write "function ChooseKonragent(Obj){",!
	Write "newItem=window.showModalDialog(""Dictionary.csp"",""Common.Kontragent"",""center:yes;status:no;dialogHeight:400px;dialogWidth:650px;resizable:yes;"");",!
	Write "if(newItem==null){return false;}",!
	Write "var newArr=newItem.split(InnerSplitter);",!
	Write "Obj.innerText=newArr[1];",!
	Write "Obj.Tag=newArr[0];",!
	Write "}",!
	Write !,"function load(){",!
	Write "FillDocStr();",!
	Write "}",!
	Write !,"function FillDocStr(){",!
	Write "var Captions = new Array(4);",!
	Write "var Keys = new Array(4);",!
	Write "var Tags = new Array(4);",!
	Write "var Widths = new Array(4);",!
	Write !,"Captions[0]=""Товар"";",!
	Write "Captions[1]=""Количество"";",!
	Write "Captions[2]=""Цена"";",!
	Write "Captions[3]=""Сумма"";",!
	Write !,"Tags[0]=""Goods.Goods"";",!
	Write "Tags[1]=""%Numeric"";",!
	Write "Tags[2]=""%Numeric"";",!
	Write "Tags[3]=""%Numeric"";",!
	Write !,"Keys[0]=""Goods"";",!
	Write "Keys[1]=""Quantity"";",!
	Write "Keys[2]=""Price"";",!
	Write "Keys[3]=""Total"";",!
	Write !,"Widths[0]=400;",!
	Write "Widths[1]=80;",!
	Write "Widths[2]=80;",!
	Write "Widths[3]=80;",!
	Write "docstr.DrawHeaders(Captions,Keys,Tags, Widths);",!
	Write "if(DocId!="""")",!
	Write "	{",!
	Write "	docstr.loadfrommethod(""Docs.Action2.ChiefInstructStr"",DocId,""Operation.PlanItems"");",!
	Write "	}",!
	Write "}",!
	Write !,"// сохранить",!
	Write "function startFun(){",!
	Write "xmlDoc=docstr.GetXmlContentByRows();",!
	Write "InsertXmlHeader(xmlDoc,""Name"",Name.value,""%String"")",!
	Write "InsertXmlHeader(xmlDoc,""Comment"",Comment.value,""%String"")",!
	Write "InsertXmlHeader(xmlDoc,""PlanDate"",PlanDate.value,""%Date"")",!
	Write "InsertXmlHeader(xmlDoc,""PlanDate2"",PlanDate2.value,""%Date"")",!
	Write "InsertXmlHeader(xmlDoc,""DocLanguage"",DocLanguage.value,""%String"")",!
	Write "InsertXmlHeader(xmlDoc,""Summa"",Summa.value,""%Numeric"")",!
	Write "InsertXmlHeader(xmlDoc,""Kontr"",Kontr.Tag,""Common.Kontragent"")",!
	Write "var DocID=SendXml(DocId,""Operation.Plan"",xmlDoc,sessionid);",!
	Write "if(isNaN(DocID)){alert(DocID)}",!
	Write "else{returnValue=1;window.close();}",!
	Write "}",!
	Write !,"// Добавить товар",!
	Write "function AddGood(){",!
	Write "//вызываем окно выбора товаров с ключом ""выводить закупочные цены"", см. Goods.GoodsAction.fromgroup()",!
	Write "WinResult=window.showModalDialog(""selectgoods2.csp?ShowBuyPrices=@1"","""",""center:yes;status:no;dialogHeight:700px;dialogWidth:800px;resizable:yes;"")",!
	Write "if(WinResult==null)return",!
	Write "WinResult=WinResult.split(StringSplitter)",!
	Write "docstr.AddRowsInstruct(WinResult)",!
	Write "Summa.value=docstr.GetTableSumma();",!
	Write "}",!
	Write !,"// удалить строку",!
	Write "function RemoveRow(){",!
	Write "docstr.RemoveSelectedRows();",!
	Write "Summa.value=docstr.GetTableSumma();",!
	Write "}",!
	Write !,"// Очистить список",!
	Write "function ClearGrid(){",!
	Write "if(window.confirm(""Удалить все товарные строки?""))",!
	Write "	{",!
	Write "	docstr.Clear();",!
	Write "	Summa.value=0;",!
	Write "	}",!
	Write "}",!
	Write !,"</script>"
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLADiGrid>"
	Write !,"<IMPORT NAMESPACE=""SKLADiGrid"" IMPLEMENTATION=""htc/iGridV9.htc"">",!
	Do ..OnPageHEAD()
	Write !,!
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  i %session.NewSession d
  . s %session.EndSession=1
  . s sessionid=%request.Get("sessionid",1)
  . s %session=%session.GetSession(sessionid)
  .  s login=$G(%session.Data("user"))
  . i '+login s %response.ServerSideRedirect="norights.csp" 
  e  s sessionid=%session.SessionId
  
 Quit 1
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\PlanIgrid.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/PlanIgrid.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62181,50207</Default>
</Parameter>
</Class>
</Export>
