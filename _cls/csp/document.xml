<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.document">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62291,59296.046036</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""load()"" onkeypress=""ManageWindow()"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !,"<center id=""TypDocument"" style=""font-size:14pt;font:Arial;color:#112255""></center>",!
	Write "<SKLAD2:table id=""PropTable"" width=400 height=200 onLoadComplete=""fillrash()"" />",!
	Write "<fieldset><legend>Строки документа</legend>",!
	Write "<SKLAD2:table id=""docstr"" width=100% height=200 CountTotal=""true"" Totalchange=""setsumm()"" displaybar=true OnCellChange=""docstrPropChange()"" />",!
	Write !,"<img src=""images/new+.gif"" onmouseover=""add2.src='images/Onnew+.gif'"" onmouseout=""add2.src='images/new+.gif'""  id=""add2"" name=""add2"" alt=""Вставить товары"" onclick=""addtovars()"" style="""">"
	Write !,!,"<img src=""images/print.gif"" onmouseover=""apint.src='images/Onprint.gif'"" onmouseout=""apint.src='images/print.gif'""  id=""apint"" name=""apint"" alt=""Распечатать документ"" onclick=""prntdoc()"" style="""">"
	Write !,"</fieldset>",!
	If '(silent'="true") Goto %csp00001 ;{
	Write !,"<center>"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""startFun()"" TITLE=""""><center>Сохранить</center></span>"
	Write "&nbsp;&nbsp;&nbsp;"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""windowclose()"" TITLE=""""><center>Отмена</center></span>"
	Write "</center>",!
%csp00001	;}
	Write !,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	s source=%request.Get("source")
	s:source'="" DocClass=##class(Docs.Action).GetClassFromSource(source)
	s:source'="" DocType=##class(Docs.Action).GetDocNameFromClass(DocClass)
	s silent=%request.Get("silent")
	Write !
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<title>"_($G(%session.Data("systemname")))_"</title>",!
	Write "<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,!,"<script language=""Jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<script language=""JScript"">"
	Write !,"var Arguments=window.dialogArguments.split(InnerSplitter);",!
	Write "var ClassName=Arguments[0];",!
	Write "var DocID=ReturnSpace(Arguments[1]);",!
	Write "var DocID333=DocID;",!
	Write "var DocType=Arguments[2];",!
	Write "//alert(""ClassName=""+ClassName+""\nDocID=""+DocID+""\nDocType=""+DocType)",!
	Write "var source="""_(source)_""";",!
	Write "if(source!=""""){",!
	Write "	var ClassName="""_($G(DocClass))_"""",!
	Write "	var DocType="""_($G(DocType))_"""",!
	Write "}",!
	Write !,"function load(){",!
	Write "PropTable.ClassName=ClassName;",!
	Write "if(ClassName==""Docs.Rash""){",!
	Write "	PropTable.Silent=""Name"";",!
	Write "	PropTable.setsilent();}",!
	Write "TypDocument.innerText=DocType;",!
	Write "var HideFields=""CloseDate,CloseTime,CloseUser,Dat,Tim,Stat,Source,DocType,User1"";",!
	Write "if(ClassName==""Docs.Brakremont""){var HideFields=HideFields+"",Kontr,Summa"";}",!
	Write "PropTable.DownLoadPairs("""",DocID,HideFields,source);",!
	Write "docstr.ClassName=ClassName+""Items"";",!
	Write "if(source!=""""){docstr.attachEvent(""onAddColumns"",loadgoods)}",!
	Write "else{docstr.attachEvent(""onAddColumns"",loadgoods2)}",!
	Write "var HideFieldsString=""Doc,DocType"";",!
	Write "if(ClassName==""Docs.Brakremont""){var HideFieldsString=HideFieldsString+"",Total,Price"";}",!
	Write "docstr.LoadHeadersXML(HideFieldsString);",!
	Write "}",!
	Write !,"//товары взять из инструкции",!
	Write "function loadgoods(){",!
	Write "docstr.GetFromCard(source,""Goods.Goods"",""Name,Price"",""AllDocuments"")",!
	Write "}",!
	Write !,"//товары взять из строк документа",!
	Write "function loadgoods2(){",!
	Write "if(DocID!=""""){",!
	Write "docstr.loadfrommethod(""Docs.Action.GetStrFromDoc"",DocID,2,3)}",!
	Write "}",!
	Write !,"function startFun(){",!
	Write "if(!window.confirm(""Сохранить?""))return",!
	Write "DocID=ReturnSpace(Arguments[1])",!
	Write "var xmldoc=PropTable.GetXmlContent();",!
	Write "var xmldoc2=docstr.GetXmlContent();",!
	Write "var DocID=SplitSendXml(DocID,ClassName,xmldoc,xmldoc2,"""_(%session.SessionId)_""");",!
	Write "if(isNaN(DocID)){",!
	Write "	alert(DocID);",!
	Write "}",!
	Write "else{",!
	Write " if(source!=""""){",!
	Write "	var ok2="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.SetSourceDoc:csp.document"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',ClassName,DocID,source)",!
	Write " 	if(isNaN(ok2))alert(ok2)",!
	Write " }",!
	Write " if(ClassName==""Docs.Prih""){",!
	Write " 	var ok3="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.PrihNeedsDiff:csp.document"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',DocID)",!
	Write " 	if(isNaN(ok3)&&(ok3!=""yes""))alert(ok3)",!
	Write " 	if(ok3==""yes""){",!
	Write "	 	okdiff=window.showModalDialog(""docdiff.csp?source=""+DocID,""Docs.Diff""+InnerSplitter+""""+InnerSplitter+"""",""cener:yes;status:no;dialogHeight:600px;dialogWidth:800px;resizable:yes;"")",!
	Write "	 	if(okdiff!=1){alert(okdiff);return false;}",!
	Write "	 	var ok2="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.SetSourceDoc:csp.document"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',""Docs.Diff"",okdiff,DocID)",!
	Write " 	}	 ",!
	Write " }returnValue=1;",!
	Write " window.close();",!
	Write "}",!
	Write "}",!
	Write !,!,"function addtovars(){",!
	Write "WinResult=window.showModalDialog(""selectgoods2.csp"","""",""cener:yes;status:no;dialogHeight:700px;dialogWidth:800px;resizable:yes;"")",!
	Write "if(WinResult==null)return",!
	Write "WinResult=WinResult.split(StringSplitter)",!
	Write "var FieldCaption = new Array();",!
	Write "var FieldValue = new Array();",!
	Write "for(i=0 ; i<WinResult.length-1 ; i++){",!
	Write "	var onestr=WinResult[i].split(InnerSplitter);",!
	Write "	FieldCaption[""Goods""]=onestr[4] + "" "" + onestr[8] + "" "" + onestr[1];",!
	Write "	FieldValue[""Goods""]=onestr[0];",!
	Write "	FieldCaption[""Price""]=getPrice(FieldValue[""Goods""]);",!
	Write "	docstr.AddRow(FieldCaption,FieldValue);",!
	Write "}",!
	Write "}",!
	Write !,"function getPrice(tovid){",!
	Write "return "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Goods.GoodsAction.getprice:csp.document"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',tovid);",!
	Write "}",!
	Write !,"function fillrash(){",!
	Write "if((ClassName==""Docs.Rash"")&(DocID=="""")){",!
	Write "var val="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.getRashNumb:csp.document"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"')",!
	Write "PropTable.setCellValue(""Name"",val);",!
	Write "PropTable.Silent=""Name"";}",!
	Write "}",!
	Write !,"function setsumm(){",!
	Write "var val=docstr.Total;",!
	Write "var val=val.toFixed(2);",!
	Write "PropTable.setCellValue(""Summa"",val);",!
	Write "}",!
	Write !,"// закрытие окна с подтверждением",!
	Write "function windowclose(){",!
	Write "if(window.confirm(""Вы уверены?""))window.close();",!
	Write "}",!
	Write !,"// обработчик события OnCellChange таблицы строк документов",!
	Write "function docstrPropChange(){",!
	Write "	if(docstr.cellChange.colname==""Quantity""){",!
	Write "		var newQuantity=docstr.cellChange.value;",!
	Write "		var price = docstr.item(""Price"")",!
	Write "		var NewTotal=price*newQuantity;",!
	Write "		if(typeof(NewTotal)==""number""){var NewTotal=NewTotal.toFixed(2)}",!
	Write "		if(NewTotal==""NaN""){return}",!
	Write "		docstr.setCellValue(""Total"",NewTotal)",!
	Write "		setsumm()",!
	Write "}",!
	Write "}",!
	Write "</script>"
	Write !,(..HyperEventHead())
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLADz XMLNS:SKLAD2 XMLNS:SKLADList>"
	Write !,"<IMPORT NAMESPACE=""SKLADz"" IMPLEMENTATION=""htc/treeview.htc"">",!
	Write "<IMPORT NAMESPACE=""SKLAD2"" IMPLEMENTATION=""htc/table.htc"">",!
	Write "<IMPORT NAMESPACE=""SKLADList"" IMPLEMENTATION=""htc/listview2.htc"">",!
	Do ..OnPageHEAD()
	Write !
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\document.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/document.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62164,45157</Default>
</Parameter>
</Class>
</Export>
