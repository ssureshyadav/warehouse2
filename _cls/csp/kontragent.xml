<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.kontragent">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62291,66787.251305</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onkeypress=""ManageWindow();"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write "<Table width=100% height=100%><tr valign=top><td>",!
	Write "<table width=100% class=""LeftTop"" cellspacing=0>",!
	d:KontrId
	. s KontrObj=##class(Common.Kontragent).%OpenId(KontrId)
	. s NewObject="var NewObject=false;"
	if (KontrId="")&(Access10func) d
	. s KontrObj=##class(Common.Kontragent).%New()
	. d KontrObj.%Save()
	. s KontrId=KontrObj.%Id()
	. w "<script language=""jscript"">"
	. w "var KontrId='"_KontrId_"';"
	. w "</"_"script>"
	. s NewObject="var NewObject=true;"
	if $ISOBJECT($G(KontrObj)) d
	. //"Region",
	. f i="Name","Status","Address","AddressUr","City","CityUr","Postalcode","PostalcodeUr","chief","ContPers","glavbuh","Agree","CityCode","EMail","Phones","fax","Code","Password","Activity","Property2506","Koeff","Manager","OtgruzPrincip","Property831","WCalc","Comment","Balance","ChangeDate","ChangeTime","NotifyEmails","Currency","Discount","NDSPayment","IsWe","AdPhone","Pseudonym" d
	. . s @i=$ZCVT($ZOBJPROPERTY(KontrObj,i),"O","HTML")
	. s Property126=$S($ISOBJECT(KontrObj.Property126):KontrObj.Property126.%Id(),1:"")
	. s Property127=$S($ISOBJECT(KontrObj.Property127):KontrObj.Property127.%Id(),1:"")
	. s ChangeUser = KontrObj.ChangeUser
	. d:$ISOBJECT(KontrObj.region2)
	. . s region2=KontrObj.region2.%Id()
	. . s region2Name=KontrObj.region2.Name
	. d:$ISOBJECT(KontrObj.Federal)
	. . s Federal=KontrObj.Federal.%Id()
	. . s FederalName=KontrObj.Federal.Name
	. if $ISOBJECT(ChangeUser) s ChangeUser=ChangeUser.Name
	. if $ISOBJECT(KontrObj.OurCompany) d
	. . s OurCompany=KontrObj.OurCompany.%Id()
	. . s OurCompanyName=KontrObj.OurCompany.Name
	. if +ChangeDate s ChangeDate=$ZD(ChangeDate,4) 
	. if +ChangeTime s ChangeTime=$ZT(ChangeTime) 
	. s CloseString=ChangeUser_" "_ChangeDate_" "_ChangeTime
	. if $ISOBJECT(KontrObj.Property831) s Property831ID=KontrObj.Property831.%Id()
	s KontragentOtgruzPrincip = ##class(Docs.Action2).GetDisplaylistOptions($G(OtgruzPrincip),"Common.Kontragent||OtgruzPrincip")
	s CommonDictionary1 = ##class(Docs.Action2).GetClassValuesOptions($G(Property831ID),"Common.Dictionary1")
	s KontragentCurrency = ##class(Docs.Action2).GetDisplaylistOptions($G(Currency),"Common.Kontragent||Currency")
	s KontragentStatus = ##class(Docs.Action2).GetDisplaylistOptions($G(Status),"Common.Kontragent||Status")
	s KontragentActivity = ##class(Docs.Action2).GetDisplaylistOptions($G(Activity),"Common.Kontragent||Activity")
	s KontragentProperty2506 = ##class(Docs.Action2).GetDisplaylistOptions($G(Property2506),"Common.Kontragent||Property2506") 
	&html<
	<tr>
	<td class=RightBottom>Наименование</td>
	<td class=RightBottom><input type=text id=Name MAXLENGTH=50 value="#($G(Name))#"></td>
	<td class=RightBottom>Псевдоним
	<td class=RightBottom><input type="text" name="Pseudonym" id="Pseudonym" value="#($G(Pseudonym))#">
	</tr>
	<tr>
	<td class=RightBottom>Адрес факт.</td>
	<td class=RightBottom><input type=text id=Address MAXLENGTH=50 value="#($G(Address))#"></td>
	<td class=RightBottom>Адрес юр.</td>
	<td class=RightBottom><input type=text id=AddressUr MAXLENGTH=50 value="#($G(AddressUr))#"></td>
	</tr>
	<tr>
	<td class=RightBottom>Город факт.</td>
	<td class=RightBottom><input type=text id=City MAXLENGTH=50 value="#($G(City))#"></td>
	<td class=RightBottom>Город юр.</td>
	<td class=RightBottom><input type=text id=CityUr MAXLENGTH=50 value="#($G(CityUr))#"></td>
	</tr>
	<tr>
	<td class=RightBottom>Индекс факт.</td>
	<td class=RightBottom><input type=text id=Postalcode MAXLENGTH=50 value="#($G(Postalcode))#"></td>
	<td class=RightBottom>Индекс юр.</td>
	<td class=RightBottom><input type=text id=PostalcodeUr MAXLENGTH=50 value="#($G(PostalcodeUr))#"></td>
	</tr>
	<tr>
	<td class=RightBottom>Федеральный округ</td>
	<td class=RightBottom><span onmouseout="UnPaint(this)" onmouseover="Paint(this)" class=Kontragent onclick="ChooseRegion2(this,'Common.Dictionary18')" oncontextmenu="this.innerText='';this.Tag=''" id="Federal" Tag="#($G(Federal))#">#($G(FederalName))#</span></td>
	<td class=RightBottom>Регион</td>
	<td class=RightBottom><span onmouseout="UnPaint(this)" onmouseover="Paint(this)" class=Kontragent onclick="ChooseRegion2(this,'User.REGION')" oncontextmenu="this.innerText='';this.Tag=''" id="region2" Tag="#($G(region2))#">#($G(region2Name))#</span></td>
	</tr>
	<tr>
	<td class=RightBottom>Директор</td>
	<td class=RightBottom><input type=text id=chief MAXLENGTH=50 value="#($G(chief))#"></td>
	<td class=RightBottom>Контактные лица</td>
	<td class=RightBottom><input type=text id=ContPers MAXLENGTH=50 value="#($G(ContPers))#"></td>
	</tr>
	<tr>
	<td class=RightBottom>Главбух</td>
	<td class=RightBottom><input type=text id=glavbuh MAXLENGTH=50 value="#($G(glavbuh))#"></td>
	<td class=RightBottom>№ Договора</td>
	<td class=RightBottom><input type=text id=Agree MAXLENGTH=50 value="#($G(Agree))#"></td>
	</tr>
	<tr>
	<td class=RightBottom>Код города</td>
	<td class=RightBottom><input type=text id=CityCode MAXLENGTH=50 value="#($G(CityCode))#"></td>
	<td class=RightBottom>E-mail</td>
	<td class=RightBottom><input type=text id=EMail MAXLENGTH=200 value="#($G(EMail))#"></td>
	</tr>
	<tr>
	<td class=RightBottom>Телефон</td>
	<td class=RightBottom><input type=text id=Phones MAXLENGTH=50 value="#($G(Phones))#"></td>
	<td class=RightBottom>Факс</td>
	<td class=RightBottom><input type=text id=fax MAXLENGTH=50 value="#($G(fax))#"></td>
	</tr>
	<tr>
	<td class=RightBottom>Телефон указанный<br>в рекламе</td>
	<td class=RightBottom><input type=text id="AdPhone" MAXLENGTH=50 value="#($G(AdPhone))#"></td>
	<td class=RightBottom>Статус</td>
	<td class=RightBottom><select name="Status" id=Status>#(KontragentStatus)#</select></td>
	</tr>
	<!-- разделитель -->
	<tr>
	<td class=RightBottom colspan=4><br><br><br>
	</tr>
	<tr>
	<td class=RightBottom>Уник. номер</td>
	<td class=RightBottom><input type=text id=Code MAXLENGTH=50 value="#($G(Code))#"></td>
	<td class=RightBottom>Пароль</td>
	<td class=RightBottom><input type=text id="Password" MAXLENGTH=50 value="#($G(Password))#">&nbsp;&nbsp;<input type="button" onclick="GeneratePassword()" value="..." style="width:30px" title="Сгенерировать новый пароль"></td>
	</tr>
	<tr>
	<td class=RightBottom>Активность</td>
	<td class=RightBottom><select name="Activity" id=Activity>#(KontragentActivity)#</select></td>
	<td class=RightBottom>Вид деятельности</td>
	<td class=RightBottom><select name="Property2506" id=Property2506>#(KontragentProperty2506)#</select></td>
	</tr>
	<tr>
	<td class=RightBottom>Работает (коэф. 1-3)</td>
	<td class=RightBottom><input type=text id=Koeff MAXLENGTH=50 value="#($G(Koeff))#"></td>
	<td class=RightBottom>Менеджер</td>
	<td class=RightBottom><input type=text id=Manager MAXLENGTH=50 value="#($G(Manager))#"></td>
	</tr>
	<tr>
	<td class=RightBottom>Категория цен<br>электроинструмент</td>
	<td class=RightBottom><select name="Property126" id=Property126>> w ##class(Docs.Action2).GetClassValuesOptions($G(Property126),"Common.Dictionary9") &html<</select>
	<td class=RightBottom>Категория цен<br>бытовая техника</td>
	<td class=RightBottom><select name="Property127" id=Property127>> w ##class(Docs.Action2).GetClassValuesOptions($G(Property127),"Common.Dictionary9") &html<</select>
	</td>
	</tr>
	<tr>
	<td class=RightBottom>Принцип отгрузки</td>
	<td class=RightBottom><select name="OtgruzPrincip" id=OtgruzPrincip>#(KontragentOtgruzPrincip)#</select></td>
	<td class=RightBottom>Уведомлять при поступлении сообщений</td>
	<td class=RightBottom><input type=text id="NotifyEmails" MAXLENGTH=50 value="#($G(NotifyEmails))#"></td>
	</tr>	
	<tr>
	<td class=RightBottom>Способ доставки</td>
	<td class=RightBottom><select name="Property831" id=Property831>#(CommonDictionary1)#</select></td>
	<td class=RightBottom>Как рассчитываемся</td>
	<td class=RightBottom><input type=text id=WCalc MAXLENGTH=50 value="#($G(WCalc))#"></td>
	</tr>
	<tr>
	<td class=RightBottom>Валюта расчётов</td>
	<td class=RightBottom><select name="Currency" id="Currency">#(KontragentCurrency)#</select></td>
	>
	if Access11func=1 d
	. w "<td class=RightBottom>Скидка (%)</td>"
	. w "<td class=RightBottom><input type=text id=""Discount"" MAXLENGTH=10 value="""_$G(Discount)_"""></td>"
	else  d
	. w "<td class=RightBottom colspan=2>Недостаточно прав для редактирования скидки</td>"
	&html<
	<tr>
	<td class=RightBottom>Оплата по договору
	<td class=RightBottom><select name="NDSPayment" id="NDSPayment">
	>
	w ##class(Docs.Action2).GetDisplaylistOptions($G(NDSPayment),"Common.Kontragent||NDSPayment")
	w "</select>",!
	w "<td class=RightBottom>Наше юр. лицо с которым работает контрагент",!
	w "<td class=RightBottom>",!
	w "<span onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"" class=Kontragent onclick=""ChooseKonragent(this)"" oncontextmenu=""this.innerText='';this.Tag=''"" id=""OurCompany"" Tag='"_$G(OurCompany)_"'>"_$G(OurCompanyName)_"</span>"
	w "</td>",!
	&html<
	<tr>
	<td class=RightBottom>Кому принадлежит юр.лицо
	<td class=RightBottom><select name="IsWe" id="IsWe">
	>
	w ##class(Docs.Action2).GetDisplaylistOptions($G(IsWe),"Common.Kontragent||IsWe")
	w "</select></td>",!
	&html<
	<td class=RightBottom colspan=2>&nbsp;
	</tr>
	</tr>
	<tr>
	<td class=RightBottom>Комментарий</td>
	<td class=RightBottom colspan=3>
	<textarea name=Comment id=Comment style="width:100%">#($G(Comment))#</textarea>
	</td>
	</tr>
	<tr>
	<td class=RightBottom colspan=3>Баланс <i>#($G(Balance))# </i><br>Последнее сохранение: <i>#($G(CloseString))#</i></td>
	<td class=RightBottom align=center valign=middle><input type="button" style="width:250;border:0" onclick="showbank()" value="Просмотреть банковские реквизиты"></td>
	</tr>
	>
	Write !,"</table>",!
	Write "</td></tr>",!
	Write "<tr valign=bottom><td align=center>",!
	If '(Access10func=1) Goto %csp00001 ;{
	Write !,"	"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"_($G(SaveButtonStyle))_""" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""startFun();"" TITLE=""""><center>Сохранить</center></span>"
	Write !
%csp00001	;}
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""windowclose("_(KontrId)_");"" TITLE=""""><center>Отмена</center></span>"
	Write !,"</td></tr>",!
	Write "</table>",!
	Write "<script language=""jscript"">"
	Write !,(NewObject)_";",!
	Write "</script>"
	Write !,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !
	s KontrId=%request.Get("KontrId")
	Write !
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,!,"<title>Контрагент</title>",!
	Write !,"<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<script language=""jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<script language=""jscript"">"
	Write !,"var KontrId="""_(KontrId)_""";",!
	Write "var sessionid="""_(sessionid)_""";",!
	Write !,"function ChooseRegion2(Obj,ClassName){",!
	Write "newItem=window.showModalDialog(""Dictionary.csp"",ClassName,""center:yes;status:no;dialogHeight:400px;dialogWidth:650px;resizable:yes;"");",!
	Write "if(newItem==null){return false;}",!
	Write "var newArr=newItem.split(InnerSplitter);",!
	Write "Obj.innerText=newArr[1];",!
	Write "Obj.Tag=newArr[0];",!
	Write "}",!
	Write !,"function startFun(){",!
	Write ($G(Func10Refuse)),!
	Write "var xmlDoc = new ActiveXObject(""Msxml2.DOMDocument.3.0"");",!
	Write "var RootElement = xmlDoc.createElement(""RootElement"");",!
	Write "xmlDoc.documentElement=RootElement;",!
	Write "//""Region"",",!
	Write "var Properties= new Array(""Name"",""Status"",""Address"",""AddressUr"",""City"",""CityUr"",""Postalcode"",""PostalcodeUr"",""chief"",""ContPers"",""glavbuh"",""Agree"",""CityCode"",""EMail"",""Phones"",""fax"",""Code"",""Password"",""Activity"",""Property2506"",""Koeff"",""Manager"",""OtgruzPrincip"",""Property126"",""Property127"",""Property831"",""WCalc"",""Currency"",""Comment"",""Discount"",""NDSPayment"",""NotifyEmails"",""IsWe"",""AdPhone"",""Pseudonym"");",!
	Write "for(var i=0;i<Properties.length;i++){",!
	Write "	var elementObject = document.getElementById(Properties[i])",!
	Write "	if(elementObject==null)continue;",!
	Write "	var elementValue=elementObject.value;",!
	Write "	InsertXmlHeader(xmlDoc,Properties[i],elementValue,""%String"");",!
	Write "}",!
	Write "InsertXmlHeader(xmlDoc,""region2"",region2.Tag,""Users.REGION"")",!
	Write "InsertXmlHeader(xmlDoc,""Federal"",Federal.Tag,""Common.Dictionary18"")",!
	Write "InsertXmlHeader(xmlDoc,""OurCompany"",OurCompany.Tag,""Common.Kontragent"")",!
	Write "var DocID=SendXml(KontrId,""Common.Kontragent"",xmlDoc,sessionid,""Docs.Action.SaveSingleGood"");",!
	Write "if(isNaN(DocID)){alert(DocID)}",!
	Write "else{",!
	Write "	returnValue=1;",!
	Write "	window.close();",!
	Write "	}",!
	Write "}",!
	Write !,"function showbank(){",!
	Write "window.showModalDialog(""bank.csp?Kontr=""+KontrId,"""",""center:yes;status:no;dialogHeight:400px;dialogWidth:600px;resizable:yes;"");",!
	Write "}",!
	Write !,"function windowclose(KontrId){",!
	Write "if(NewObject)",!
	Write "	{",!
	Write "	var ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Common.Common.DeleteItem:csp.kontragent"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',""Common.Kontragent"",KontrId);",!
	Write "	if(isNaN(ok))alert(""Ошибка удаления временного объекта\n""+ok);",!
	Write "	}",!
	Write "if(window.confirm(""Вы уверены?""))window.close();",!
	Write "}",!
	Write !,"function GeneratePassword() {",!
	Write "	if(window.confirm(""Сгенерировать новый пароль?"")) ",!
	Write "	{",!
	Write "		 var passw = "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Common.Common.GeneratePassword:csp.kontragent"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"');",!
	Write "		 Password.value = passw;",!
	Write "	}",!
	Write "}",!
	Write !,"//функция выбора контрагента (подставит выбранного в innerText переданного объекта",!
	Write "function ChooseKonragent(Obj){",!
	Write "newItem=window.showModalDialog(""Dictionary.csp"",""Common.Kontragent"",""center:yes;status:no;dialogHeight:400px;dialogWidth:650px;resizable:yes;"");",!
	Write "if(newItem==null){return false;}",!
	Write "var newArr=newItem.split(InnerSplitter);",!
	Write "Obj.innerText=newArr[1];",!
	Write "Obj.Tag=newArr[0];",!
	Write "}",!
	Write !,"</script>"
	Write !,"<style>"
	Write !,".LeftTop{border-left : 1 solid black;border-top : 1 solid black;}",!
	Write ".RightBottom{font-family:Arial;font-size:14px;border-right : 1 solid black;border-bottom : 1 solid black;}",!
	Write "SELECT{width:170px}",!
	Write ".Kontragent{width:100%;cursor:hand;border:solid 1 black}",!
	Write "</style>"
	Write !,(..HyperEventHead())
	Write !,!,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html>"
	Write !
	Do ..OnPageHEAD()
	Write !,!
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  i %session.NewSession d
  . s %session.EndSession=1
  . s sessionid=%request.Get("sessionid",1)
  . s %session=%session.GetSession(sessionid)
  e  s sessionid=%session.SessionId
  s login=$G(%session.Data("user"),0)
  i '+login s %response.ServerSideRedirect="norights.csp" 
  s Access10func=##class(Common.Rights).getrights(+login,10)
  s Access11func=##class(Common.Rights).getrights(+login,11)
  if 'Access10func s Func10Refuse="return;"
 Quit 1
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\kontragent.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/kontragent.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62167,65337</Default>
</Parameter>
</Class>
</Export>
