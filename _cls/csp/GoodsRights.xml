<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.GoodsRights">
<Description>
Установка ограничений на экспорт справочника товаров
csp.Protected</Description>
<IncludeCode>csp</IncludeCode>
<Super>csp.Protected,csp.Design</Super>
<TimeCreated>62462,61031.670471</TimeCreated>

<Parameter name="CHARSET">
<Description><![CDATA[
Specifies the default character set for the page.  This can be overriden using the
&lt;CSP:CONTENT CHARSET=&gt; tag, or by setting the <b>%response</b>.CharSet property
in the <method>OnPreHTTP</method> method.  If this parameter is not specified, then
for Unicode systems the default charset is utf-8 and for 8-bit systems it is the
system default charset.]]></Description>
<Default>utf-8</Default>
</Parameter>

<Method name="wTitle">
<Description>
write заголовок страницы</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&args:%String=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 w "Склад2 :: Привилегии" 
 Q ""
]]></Implementation>
</Method>

<Method name="wCss">
<Description>
write заголовок страницы</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&args:%String=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 &html<
 <link rel='stylesheet' type='text/css' href='css/redmond/jquery-ui-1.8.16.custom.css'/>
 <link rel='stylesheet' type='text/css' href='css/ui.jqgrid.css'/>
 <style type="text/css">
 	body {margin:0px;padding:0px;}
 	.ui-jqgrid {font-size:90%;}
 	.ui-widget {font-size:12px;}
</style>
 >
 Q ""
]]></Implementation>
</Method>

<Method name="wPageHeader">
<Description>
write заголовок на странице</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&args:%String=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 
 Q ""
]]></Implementation>
</Method>

<Method name="wBody">
<Description>
write содержимое страницы</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&args:%String=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
 s depot=$g(%session.Data("depot"),1)
 s cat=$g(args("cat",1),1), catName=""
 s:##class(Goods.Catalogue).%ExistsId(cat) catName=##class(Goods.Catalogue).NameGetStored(cat)
 &html<<table>
 	<tr><td colspan="2">>

 	&html<<div style="BACKGROUND: rgb(233,243,255); BORDER-BOTTOM: rgb(0,0,102) 1px solid">
 	<button id="btnBack">Назад</button>
 	<span style="FONT-size: 18px ; font-family: arial; COLOR: rgb(0,0,102);padding-left:30px;">
 		<strong>Ограничение использования запчастей контрагентами</strong>
 	</span>
 	</div>
 	</td></tr>
 	<tr><td style="vertical-align:top;">
 	<label for="catSel">Каталог:&nbsp;</label><input id="catId" type="hidden" value="#(cat)#"/>
 	<input id="cat" value="#(catName)#" readonly="readonly"/><button id="catSel">...</button>
 
 <div id="catDlg">
  <table id="catGrid"><tr><td></td></tr></table><div id="catBar"></div>
 </div>
 	
 	<table id="group"><tr><td></td></tr></table><div id="groupBar"></div>
 
 </td><td style="vertical-align:top;">
 
  <label for="kontrSel">Контрагент:&nbsp;</label><input id="kontrId" type="hidden" />
  <input id="kontr" /><button id="kontrSel">...</button>
  <div id="kontrDlg">
  	<table id="kontrGrid"><tr><td></td></tr></table><div id="kontrBar"></div>
  </div>
  <table id="good"><tr><td></td></tr></table><div id="goodBar"></div>
 
 </td></tr></table>
 <div id="debug"></div>>
 Q ""
]]></Implementation>
</Method>

<Method name="wCatOpts">
<Description>
В локальный массив с ключом по Наименованию</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&Args:%String]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	#define qt(%js) $tr(..QuoteJS(%js),"'","""")
	
	s depot=$g(Args("depot",1),1)
	k cats s cats=""
	&sql(Declare crs Cursor For
		Select Id,Name Into :id,:name
		From Goods.Catalogue
		Where depot=:depot
		Order By Name
	) &sql(Open crs)
	w "{rows:["
	s first=1
	for { &sql(Fetch crs) Q:SQLCODE'=0
	 w:'first "," s:first first=0
		w "{id:",id,",name:",$$$qt(name),"}"
	} &sql(Close crs)
	w "],page:1,records:",%ROWCOUNT,",total:1}"
	
	Q ""
]]></Implementation>
</Method>

<Method name="wJs">
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&args:%String=""]]></FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	
 s depot=$g(%session.Data("depot"),1)
 s cat=$g(args("cat",1),1), catName=""
 s:##class(Goods.Catalogue).%ExistsId(cat) catName=##class(Goods.Catalogue).NameGetStored(cat)
	
	
 &html<
<script type='text/javascript' src='js/jquery-1.6.4.min.js'></script>
<script type='text/javascript' src='js/jquery-ui-1.8.16.custom.min.js'></script>
<script type='text/javascript' src='js/i18n/grid.locale-ru.js'></script>
<script type='text/javascript' src='js/jquery.jqGrid-4.1.2.min.js'></script>
<script type="text/javascript">

;
var page={
	kontr: null
	
	
};

function obj2str(obj){ //преобразование js объекта в строку
  var arr=new Array();
  for (var i in obj){ arr.push(i+"="+obj[i]); }
  return arr.join("&");
 }; 
 
function catSelected(){
	 	var id=$("#catGrid").jqGrid("getGridParam","selrow");
				if (id) {
						var data=$("#catGrid").jqGrid("getRowData",id);
						var old=$("#catId").val();
						if (id!=old){
							$("#catId").val(id);
							$("#cat").val(data.name).attr("title",data.name);
							
							//обновляем дерево групп
							var postData=$("#group").jqGrid("getGridParam","postData");
							postData.cat=id; //другой каталог
							$("#group").jqGrid("setGridParam","postData",postData);
							$("#group").trigger("reloadGrid"); //перегружаем дерево групп
							
							//сбрасываем выбранную группу для товара
							postData=$("#good").jqGrid("getGridParam","postData");
							postData.group=""; 
							$("#good").jqGrid("setGridParam","postData",postData);
							$("#good").trigger("reloadGrid"); //перегружаем дерево групп
							$("#catDlg").dialog("close");
							
						}
				}
	}

function kontrSelected(){
				var id=$("#kontrGrid").jqGrid("getGridParam","selrow");
				if (id) {
						var data=$("#kontrGrid").jqGrid("getRowData",id);
						var old=$("#kontrId").val();
						if (id!=old){
							$("#kontrId").val(id);
							$("#kontr").val(data.name).attr("title",data.name);
							var goodGrid=$("#good");
							var goodPostData=goodGrid.jqGrid("getGridParam","postData");
							goodPostData.kontr=id;
							goodGrid.jqGrid("setGridParam","postData",goodPostData)
							.trigger("reloadGrid");
						}
				}
				$("#kontrDlg").dialog("close");
}
$(function(){ //общий запуск после загрузки страницы
 
 $("#btnBack").button({icons:{primary:'ui-icon-circle-arrow-w'}})
 			  .click(function(){
	 			 window.location='goods.csp'; 
	 		  });
	 		  
 $("#catDlg").dialog({  //диалог выбора каталога
	 title:"Выбор каталога"
	 ,autoOpen: false
	 ,modal: true
	 ,height:460
	 ,width:430
	 ,position:[227,35]
	 ,buttons: {
			"Выбрать":function(){
				catSelected();
			}
			,"Отмена":function(){$(this).dialog("close");} 
		}
		,hide: "slide" //эффекты закрытия диалога
		,show: "slide" //эффекты открытия диалога
	 
	});
 
 $("#catGrid").jqGrid({ //Таблица с категориями
	 url: 'json.Catalogue.cls'
	 ,colModel: [
	 				{name:'id', width:50,hidden:true}
      ,{name:'name',label:'Наименование', width:350,sortable:false}
  ]
  ,idPrefix:"cat"
  ,jsonReader : { repeatitems: false }
  ,datatype:function(/*Объект с параметрами запроса*/ p){
	   $("#catGrid")[0].addJSONData(
	   	#(..wCatOpts())#
	   );
	 }
	 ,pager:"#catBar"
  ,viewrecords:true
  ,height:300
  ,hidegrid: false
  ,gridview:true ,rownumbers:true,viewrecords:true,rowNum:100
  ,pager:"#catBar" ,/*scrollrows:true,*/hoverrows:true ,scroll:1
  ,ondblClickRow: catSelected
	}).jqGrid('navGrid',"#catBar", 
       {add:false,edit:false,del:false,view:false,search:false}
       ,{} //Параметры редактирования
       ,{} //Параметры добавления
       ,{}
 );
 $("#catBar_center").remove();
 
 $("#catSel").click(function(){
		$("#catDlg").dialog("open"); 
	});
 
 
 $("#group").jqGrid({
  
  caption: "Группы товаров каталога "
  ,colModel: [
      {name:'n',label:'Наименование', width:350,sortable:false}
      ,{name:'id',label:'id', width:40,sortable:false,hidden:true,search:false}
      ,{name:'c', width:80,sortable:false,hidden:true,search:false}
  ]
  ,idPrefix:"gg"
  ,url: "json.GoodsGroup2.cls"
  ,datatype: "json"
  ,postData: {depot: '#(depot)#',cat: '#(cat)#'}
  ,treeGrid: true
  ,treeGridModel: "adjacency"
  ,treeIcons: {plus:'ui-icon-circlesmall-plus',minus:'ui-icon-circlesmall-minus',leaf:'ui-icon-arrowstop-1-e'} 
  ,ExpandColumn: "n"
  ,ExpandColClick: true
  ,jsonReader : { repeatitems: false }
  ,treeReader : {
   	level_field: "level",
   	parent_id_field: "parent", // then why does your table use "parent_id"?
   	leaf_field: "leaf",
   	expanded_field: "expanded" //не изменять, иначе компонент глючит!!!
  }
  ,onSelectRow: function(id){ 
  	var postData=$("#good").jqGrid("getGridParam","postData");
  	$.extend(postData,{group:id});
  	$("#good").jqGrid("setGridParam","postData",postData);
  	//перезагружать только в случае выбранного контрагента
  	if ($("#kontr").val()) {
	  	$("#good").trigger("reloadGrid");
  	} else {
	  	$("#kontrDlg").dialog("open");	
	  }
  	
  }
 
  ,pager:"#groupBar"
  ,viewrecords:true
  ,height:400
  ,hidegrid: false
 }).jqGrid('navGrid',"#groupBar", 
       {add:false,edit:false,del:false,view:false,search:false}
       ,{} //Параметры редактирования
       ,{} //Параметры добавления
       ,{}
 ).jqGrid('gridResize',{minWidth:100,minHeight:100})
  .jqGrid('filterToolbar',{searchOnEnter:false})
  .jqGrid('navButtonAdd',"#groupBar",{
    caption:""
    ,buttonicon: "ui-icon-circlesmall-plus"
    ,title: "Развернуть все узлы"
    ,onClickButton : function (){
	    	  var record=$( "#group" ).jqGrid('getRowData')[0];
     	  var expand = function(record){
		       record._id_ = record.id; //hard hack 
		      	var children=$( "#group" ).jqGrid("getNodeChildren",record);
	       	if (!children.length) return;
	       	for (var child in children){
		       		expand(children[child]);
		       };
		      	$( "#group" ).jqGrid('expandRow',record);
	       	$( "#group" ).jqGrid('expandNode', record);
	       };
	       expand(record);
    }
  })
  .jqGrid('navButtonAdd',"#groupBar",{
    caption:""
    ,buttonicon: "ui-icon-circlesmall-minus"
    ,title: "Свернуть все узлы"
    ,onClickButton : function (){
       	var record=$( "#group" ).jqGrid('getRowData')[0];
     	  var collapse = function(record){
		       record._id_ = record.id; //hard hack 
		      	var children=$( "#group" ).jqGrid("getNodeChildren",record);
		      	if (!children.length) return;
	       	for (var child in children){
		       		collapse(children[child]);
		       };
		       
		      	$( "#group" ).jqGrid('collapseRow',record);
	       	$( "#group" ).jqGrid('collapseNode', record);
	       };
	       collapse(record);
 
    }
  })
  /*.jqGrid('navButtonAdd',"#groupBar",{
    caption:""
    ,title: "Настройка отображения столбцов"
    ,onClickButton : function (){
        jQuery("#group").jqGrid('columnChooser');
    }
})*/;
$("#groupBar_center").remove(); //упростили панель управления деревом (удалили пустую центральную часть)


$("#gs_n").unbind() //убрали все обработчики событий из стандартного фильтра
/*.keyup(function(e){ //привязываем свои
		
		setTimeout(function(){$("#debug").html($("#gs_n").val())},100);
})*/; 

//Контрагент 
//Форма выбора
$("#kontrDlg").dialog({
	
	title:"Выбор контрагента"
	 ,autoOpen: false
	 ,modal: true
	 ,height:480
	 ,width:530
	 ,position:[300,35]
	 ,open: function(){
		 $("#kontrGrid").trigger("reloadGrid"); //глючит прокрутка
		}
	 ,buttons: {
			"Выбрать": kontrSelected
			,"Отмена":function(){$(this).dialog("close");} 
		}
		,hide: "slide" //эффекты закрытия диалога
		,show: "slide" //эффекты открытия диалога
});

$("#kontrSel").click(function(){ //Вызов диалога
	
	$("#kontrDlg").dialog("open");
	
});

//Таблица с контрагентами

$("#kontrGrid").jqGrid({
	colModel: [
		{name:"id",hidden: true}
		,{name:"name",label:"Наименование",width:450}
	]
	,url: "json.Kontragent.cls"
	,datatype: "json"
	,jsonReader : { repeatitems: false }
	,pager: "#kontrBar"	
	,idPrefix:"kt"
 ,viewrecords:true
 ,height:300
 ,hidegrid: false
 ,gridview:true ,rownumbers:true,viewrecords:true,rowNum:100
 ,pager:"#kontrBar" ,/*scrollrows:true,*/hoverrows:true ,scroll:1
 ,ondblClickRow: kontrSelected
 })
 .jqGrid('navGrid',"#kontrBar", 
       {add:false,edit:false,del:false,view:false,search:false}
       ,{} //Параметры редактирования
       ,{} //Параметры добавления
       ,{}
 )
 .jqGrid('filterToolbar',{searchOnEnter:false})
 .jqGrid('gridResize',{})
 ;
 $("#kontrBar_center").remove(); //пагинатора не будет
 $("#kontrBar_right").css("width","70%"); //надпись о количестве записей на бОльшую часть футера




//Таблица с товарами
$("#good").jqGrid({
	caption: "Товары группы"
	,colModel: [
		{name:"id",hidden:true}
		,{name:"name",label:"Наименование", width:350}
		,{name:"kban",label:"Запрет",width:60
		  ,align: "left" 
				,formatter: 'checkbox', formatoptions: {disabled:false}
				,search:false
			}
	]
	,url: "json.GoodsRights.cls"
	,datatype: "json"
	,jsonReader : { repeatitems: false }
	,postData:{group:'',kontr:''}
 ,idPrefix:"g"
	,pager:"#goodBar"
	,height:400
 ,hidegrid: false
 ,rownumbers:true,viewrecords:true,rowNum:100
 ,scroll:1 /*,scrollrows:true,hoverrows:true,gridview:true */ 
 ,afterInsertRow: function(rowid,rowdata,rowelem){
		var gg=rowid;
		//привязываемся к событиям checkbox
		$("#"+rowid,"#good").find("input[type='checkbox']").change(function(e){
			var unban=0;
			if ($(this).val()==1){
				$(this).val(0).removeAttr("checked");
				unban=1
			} else {
				$(this).val(1).attr("checked","checked");
			}
			var kontr=$("#kontrId").val();
			var result=false;
			$.ajax({url: 'json.GoodsRights.cls'
					,async: false
					,data: { oper: 'ban'
						,gg: gg
						,kontr: kontr
						,unban: unban
					}
					,success: function(res){
						result=res;
					}
			});
			
			return result;
			
		});
	}
}).jqGrid('navGrid',"#goodBar", 
       {add:false,edit:false,del:false,view:false,search:false}
       ,{} //Параметры редактирования
       ,{} //Параметры добавления
       ,{}
 ).jqGrid('gridResize',{minWidth:100,minHeight:100})
  .jqGrid('filterToolbar',{searchOnEnter:false})
  ;
$("#goodBar_center").remove();

 });
</script>>
	Q ""
]]></Implementation>
</Method>
</Class>
</Export>
