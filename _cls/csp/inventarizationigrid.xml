<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.inventarizationigrid">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62293,58194.292886</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""load()"" onkeypress=""ManageWindow();"">"
	Write !,"<table width=100%><tr><td>",!
	Write "<table class=""LeftTop"" cellspacing=0 width=100%>",!
	s DocId=%request.Get("source")
	i DocId {
	&sql(select Name,Comment,CloseDate,CloseTime,CloseUser->Name,Stat,Summa,Address,Common.SqlProcs_AddrPath(Address) into 
Name,:Comment,:CloseDate,:CloseTime,:CloseUserName,:Stat,:Summa,:Address,:AddressPath
	from Docs.Invent where ID=:DocId)
	i SQLCODE w "<tr><td colspan=4>Ошибка при выводе инструкции "_DocId_"<br>SQLCODE="_SQLCODE_"</td></tr>"
	i Stat=2 d
	. s ClosedString=CloseUserName_" "_$S(CloseDate:$ZD(CloseDate,4),1:"")_" "_$S(CloseTime:$ZT(CloseTime),1:"")
	. s SaveButtonStyle="display:none"
	}
	w "<tr>"
	w "<td class=RightBottom>Краткое описание (номер)<td class=RightBottom><input type=text id=Name MAXLENGTH=50 value='"_$G(Name)_"'>"
	w "<td class=RightBottom>Комментарий<td class=RightBottom><input type=text id=Comment MAXLENGTH=1000 Value='"_$G(Comment)_"'>"
	w "</tr>"
	w "<tr>"
	w "<td class=RightBottom>Блокировать<td class=RightBottom><span onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"" class=Kontragent onclick=""ChooseAddress(this)"" oncontextmenu=""this.innerText='';this.Tag=''"" id=""Address"" Tag='"_$G(Address)_"'>"_$G(AddressPath)_"</span>"
	w "<td class=RightBottom>Сумма"
	w "<td class=RightBottom>"_$G(Summa)_"&nbsp;"
	w "</tr>"
	w:$G(ClosedString)'="" "<tr><td colspan=4 class=RightBottom>Инструкция завершена <i>"_ClosedString_"</i>"
	Write !,"</table>",!
	Write "<tr height=100%><td>",!
	Write "<SKLADiGrid:iGrid id=""docstr"" width=""100%"" height=""300"" Enabled=""true""  /><br>",!
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""AddGood();"" TITLE=""""><center>Добавить товар</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""RemoveRow();"" TITLE=""""><center>Удалить строку</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""ClearGrid();"" TITLE=""""><center>Очистить строки</center></span>"
	Write !,"<tr><td>",!
	Write "<center><br>"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"_($G(SaveButtonStyle))_""" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""startFun();"" TITLE=""""><center>Сохранить</center></span>"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""windowclose();"" TITLE=""""><center>Отмена</center></span>"
	Write "</center>",!
	Write "</table>",!
	Write !,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<style>"
	Write !,".LeftTop{border-left : 1 solid black;border-top : 1 solid black;}",!
	Write ".RightBottom{font-family:Arial;font-size:14px;border-right : 1 solid black;border-bottom : 1 solid black;}",!
	Write "SELECT{width:170px}",!
	Write ".Kontragent{width:170px;cursor:hand;}",!
	Write ".ZakazInstr{display:inline;}",!
	Write "</style>"
	Write !,"<script language=""jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<title>Инвентаризация</title>",!
	Write !,"<script language=""Jscript"">"
	Write !,"var DocId='"_(%request.Get("source"))_"';",!
	Write "var sessionid="""_(sessionid)_""";",!
	Write !,"function ChooseAddress(Obj,depot){",!
	Write "if(!window.confirm(""Операция изменит все строки данной инвентаризации (если они есть). Продолжить?"")){return }",!
	Write "	docstr.Clear();",!
	Write "	var depot=ReturnSpace(depot);",!
	Write "	var newItem=window.showModalDialog(""storemodal2.csp?depot=""+depot,"""",""center:yes;status:no;dialogHeight:600px;dialogWidth:800px;resizable:yes;"");",!
	Write "	if(newItem!=null){if(newItem.split(""~"")[0]==""changedepot""){DictClick(tr,newItem.split(""~"")[1])}}",!
	Write "	if(newItem==null){return false;}",!
	Write "	var newArr=newItem.split(InnerSplitter);",!
	Write "	Obj.innerText=newArr[1];",!
	Write "	Obj.Tag=newArr[0];",!
	Write "	docstr.loadfrommethod(""Docs.Action2.BlockAndShowCells"",Obj.Tag);",!
	Write "}",!
	Write !,"function load(){",!
	Write "FillDocStr();",!
	Write "}",!
	Write !,"function FillDocStr(){",!
	Write "var Captions = new Array(6);",!
	Write "var Keys = new Array(6);",!
	Write "var Tags = new Array(6);",!
	Write "var Widths = new Array(6);",!
	Write !,"Captions[0]=""Ячейка"";",!
	Write "Captions[1]=""Товар"";",!
	Write "Captions[2]=""Количество по плану"";",!
	Write "Captions[3]=""Количество фактическое"";",!
	Write "Captions[4]=""Цена"";",!
	Write "Captions[5]=""Сумма"";",!
	Write !,"Tags[0]=""Store.Address"";",!
	Write "Tags[1]=""Goods.Goods"";",!
	Write "Tags[2]=""%Numeric"";",!
	Write "Tags[3]=""%Numeric"";",!
	Write "Tags[4]=""%Numeric"";",!
	Write "Tags[5]=""%Numeric"";",!
	Write !,"Keys[0]=""addr"";",!
	Write "Keys[1]=""Goods"";",!
	Write "Keys[2]=""quantplan"";",!
	Write "Keys[3]=""Quantity"";",!
	Write "Keys[4]=""Price"";",!
	Write "Keys[5]=""Total"";",!
	Write !,"Widths[0]=200;",!
	Write "Widths[1]=240;",!
	Write "Widths[2]=90;",!
	Write "Widths[3]=90;",!
	Write "Widths[4]=60;",!
	Write "Widths[5]=60;",!
	Write "docstr.DrawHeaders(Captions,Keys,Tags, Widths);",!
	Write "if(DocId!="""")",!
	Write "	{",!
	Write "	docstr.loadfrommethod(""Docs.Action2.InventStr"",DocId);",!
	Write "	}",!
	Write "}",!
	Write !,"// сохранить",!
	Write "function startFun(){",!
	Write "xmlDoc=docstr.GetXmlContentByRows();",!
	Write "InsertXmlHeader(xmlDoc,""Summa"",docstr.GetTableSumma(),""%String"")",!
	Write "InsertXmlHeader(xmlDoc,""Name"",Name.value,""%String"")",!
	Write "InsertXmlHeader(xmlDoc,""Comment"",Comment.value,""%String"")",!
	Write "InsertXmlHeader(xmlDoc,""Address"",Address.Tag,""Store.Address"")",!
	Write !,"var DocID=SendXml(DocId,""Docs.Invent"",xmlDoc,sessionid);",!
	Write "if(isNaN(DocID)){alert(DocID)}",!
	Write "else{returnValue=1;window.close();}",!
	Write "}",!
	Write !,"//Добавить товар",!
	Write "function AddGood(){",!
	Write "WinResult=window.showModalDialog(""selectgoods2.csp"","""",""center:yes;status:no;dialogHeight:700px;dialogWidth:800px;resizable:yes;"")",!
	Write "if(WinResult==null)return",!
	Write "WinResult=WinResult.split(StringSplitter)",!
	Write "docstr.AddRowsInstruct(WinResult)",!
	Write "}",!
	Write !,"// удалить строку",!
	Write "function RemoveRow(){",!
	Write "docstr.RemoveSelectedRows()",!
	Write "}",!
	Write !,"// Очистить список",!
	Write "function ClearGrid(){",!
	Write "if(window.confirm(""Удалить все товарные строки?""))docstr.Clear()	",!
	Write "}",!
	Write "</script>"
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLADiGrid>"
	Write !,"<IMPORT NAMESPACE=""SKLADiGrid"" IMPLEMENTATION=""htc/iGridV9.htc"">",!
	Do ..OnPageHEAD()
	Write !,!
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  i %session.NewSession d
  . s %session.EndSession=1
  . s sessionid=%request.Get("sessionid",1)
  . s %session=%session.GetSession(sessionid)
  .  s login=$G(%session.Data("user"))
  . i '+login s %response.ServerSideRedirect="norights.csp" 
  e  s sessionid=%session.SessionId
  
 Quit 1
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\InventarizationIgrid.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/InventarizationIgrid.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62186,67509</Default>
</Parameter>
</Class>
</Export>
