<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.serials">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62196,49332.98258</TimeCreated>

<Method name="Find">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec>WhereToFind:%String,SearchString:%String,ShowFields:%String</FormalSpec>
<Language>cache</Language>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
  n glob,i,res,number,GarantName,ID
  
  s ShowFieldsLB = $LB("")
  f i=1:1:$L(ShowFields) s $LIST(ShowFieldsLB,i)=$P(ShowFields,";",i)
  
  // индекс свойства "комментарий" и "действителен"
  s:$LF(ShowFieldsLB,"Comment") ListIndex("Comment") = ##class(Common.Dictionary2).GetPropertyListIndex("Comment",.DataLocation)
  d:$LF(ShowFieldsLB,"Property9194") 
  . s ListIndex("Property9194") = ##class(Common.Dictionary2).GetPropertyListIndex("Property9194",.DataLocation)
  . s cl="Common.Dictionary2||Property9194"
  . d ##class(Docs.Action2).GetDisplayListArray(cl,.Property9194Array)
 
  //
  
  s res=""
  s glob=$NA(^Common.Dictionary2I(WhereToFind))
  s SearchString = " "_$ZCVT(SearchString,"U")
  
  if $D(@glob@(SearchString)) d
  . s ID = $O(@glob@(SearchString,""))
  . s GarantName=$LG(@glob@(SearchString,ID),2)
  . if GarantName="" s GarantName="(не заполнен)"
  . s res=res_"<a href=""javascript:s('"_ID_"')"">"_GarantName_"</a>"
  . s:$LF(ShowFieldsLB,"Comment") res=res_" "_##class(Common.Dictionary2).GetPropertyValue(ID,"Comment",ListIndex("Comment"),.DataLocation)
  . s Property9194 = ##class(Common.Dictionary2).GetPropertyValue(ID,"Property9194",ListIndex("Property9194"),.DataLocation)
  . if ($LF(ShowFieldsLB,"Property9194"))&(Property9194'="") s res=res_" "_$G(Property9194Array(Property9194))
  . s res=res_"<br>"
  
  s i = SearchString
  f  s i=$O(@glob@(i)) q:(i="")||(i'[SearchString)||($L(res)>32000)  d
  . s ID = $O(@glob@(i,""))
  . s GarantName=$LG(@glob@(i,ID),2)
  . if GarantName="" s GarantName="(не заполнен)"
  . s res=res_"<a href=""javascript:s('"_ID_"')"">"_GarantName_"</a>"
  . s:$LF(ShowFieldsLB,"Comment") res=res_" "_##class(Common.Dictionary2).GetPropertyValue(ID,"Comment",ListIndex("Comment"),.DataLocation)
  . s Property9194 = ##class(Common.Dictionary2).GetPropertyValue(ID,"Property9194",ListIndex("Property9194"),.DataLocation)
  . if ($LF(ShowFieldsLB,"Property9194"))&(Property9194'="") s res=res_" "_$G(Property9194Array(Property9194))
  . s res=res_"<br>"
  
  if $L(res)>32000 s res=res_"Невозможно вывести все результаты. Уточните запрос."
  if res="" s res=$ZDT($H)_" не найдено ни одной записи."
  q res
 
]]></Implementation>
</Method>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""load();"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""window.location.href='goods.csp'"" TITLE=""""><center>Товары</center></span>"
	Write "<br>",!
	Write !,"<TABLE cellSpacing=0 width=""100%"" celpadding=""0"" >",!
	Write "<TR>",!
	Write "<td width=10%>"
	Write "<img alt=""Обновить раздел"" src=""images/refresh.gif"" onclick=""window.location.reload()"">"
	Write "</td>",!
	Write "<TD width=80% align=center style=""BACKGROUND: rgb(233,243,255); FONT-size: 18px ; font-family: arial; COLOR: rgb(0,0,102); BORDER-BOTTOM: rgb(0,0,102) 1px solid"" colspan=2><strong>Управление серийными номерами</strong></TD>",!
	Write "<td  width=10% align=right>"
	Write "<!--<a href=""talk.csp"" ><img src=""images/BIGProp.gif"" width=""20"" height=25 border=0></a>-->"
	Write "</td>",!
	Write "</tr>",!
	Write "</TABLE>",!
	Write "<br><br>",!
	Write "Выводить поля: ",!
	Write "	"
	Write "<div style=""border:1 solid black;display:inline"">"
	Write !,"		"
	Write "<div style=""margin:3px;background-color:#dedeef;display:inline;"">"
	Write "Комментарий "
	Write "<input type=""checkbox"" id=""CommentCB"" style=""border:none;width:15px;"" onclick=""SetCookie('SerialsCommentCB',this.checked)"">"
	Write "</div>"
	Write !,"		"
	Write "<div style=""margin:3px;background-color:#dedeef;display:inline;"">"
	Write "Актуальность "
	Write "<input type=""checkbox"" id=""Property9194CB"" style=""border:none;width:15px;"" onclick=""SetCookie('SerialsProperty9194CB',this.checked)"">"
	Write "</div>"
	Write !,"	"
	Write "</div>"
	Write !,"<br><br>",!
	Write "Первые символы ",!
	Write "<select id=""FieldToFind"">"
	Write !,"	"
	Write "<option value=""serialInd"">"
	Write "Серийного номера</option>",!
	Write "	"
	Write "<option value=""garantInd"">"
	Write "Гарантийного номера</option>",!
	Write "</select>"
	Write !,"<input type=""text"" id=""edtSearch"" value="""" onkeyup=""edtKeyUp();"" title=""Достаточно ввести несколько первых символов"">"
	Write !," "
	Write "<input type=""button"" value=""найти"" onclick=""Find()"" style=""width:50px"" title=""Начать поиск по указанным символам (ENTER)"">"
	Write !,"<br><br>",!
	Write "<input type=""button"" value=""Создать несколько записей"" onclick=""newitems()"" title=""Создать несколько серийных номеров"" style=""width:200px;"">"
	Write !,"<input type=""button"" value=""Создать одну запись"" onclick=""newitem()"" title=""Создать один серийный номер"">"
	Write !,"<br><br>",!
	Write "<div id=""DivResult"">"
	Write "</div>"
	Write !,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !,!,!
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<script language=""jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<Script language=""Jscript"">"
	Write !,"var ColCode="""";",!
	Write "sessionid="""_(%session.SessionId)_""";",!
	Write "var divObj;",!
	Write "var FieldToFindObj;",!
	Write !,"function Find()",!
	Write "{",!
	Write "	var ShowFields = """";",!
	Write "	if (CommentCBObj.checked) ShowFields=ShowFields+""Comment;"";",!
	Write "	if (Property9194CBObj.checked) ShowFields=ShowFields+""Property9194;"";",!
	Write "	var SearchStr = edtSearch.value;",!
	Write "	ok = "_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("csp.serials.Find:csp.serials"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',FieldToFindObj.value,SearchStr,ShowFields);",!
	Write "	ShowResult(ok);",!
	Write "}",!
	Write !,"function ShowResult(res)",!
	Write "{",!
	Write "	divObj.innerHTML = res;",!
	Write "}",!
	Write !,"function edtKeyUp()",!
	Write "{",!
	Write "	if(window.event.keyCode==13)Find();",!
	Write "}",!
	Write !,"function s(currentrecord)",!
	Write "{",!
	Write "	ok=window.showModalDialog(""garant.csp?GarantId=""+currentrecord,currentrecord+"";Common.Dictionary2"",""center:yes;status:no;dialogHeight:600px;dialogWidth:800px;resizable:yes;"")",!
	Write "}",!
	Write !,"function load()",!
	Write "{",!
	Write "	divObj = document.getElementById(""DivResult"");",!
	Write "	FieldToFindObj = document.getElementById(""FieldToFind"");",!
	Write "	CommentCBObj = document.getElementById(""CommentCB"");",!
	Write "	Property9194CBObj = document.getElementById(""Property9194CB"");",!
	Write "	CommentCBObj.checked = ( GetCookie(""SerialsCommentCB"")== 'true');",!
	Write "	Property9194CBObj.checked = (GetCookie(""SerialsProperty9194CB"")== 'true');",!
	Write "}",!
	Write !,"function newitems()",!
	Write "{",!
	Write "	ok=window.showModalDialog(""ManyGarants.csp"","";Common.Dictionary2"",""center:yes;status:no;dialogHeight:600px;dialogWidth:800px;resizable:yes;"")",!
	Write "}",!
	Write !,"function newitem()",!
	Write "{",!
	Write "	ok=window.showModalDialog(""garant.csp?sessionid=""+sessionid,"";Common.Dictionary2"",""center:yes;status:no;dialogHeight:600px;dialogWidth:800px;resizable:yes;"")",!
	Write "}",!
	Write "</Script>"
	Write !,(..HyperEventHead())
	Write !,!,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html>"
	Write !
	Do ..OnPageHEAD()
	Write !,!
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  s login=$G(%session.Data("user"))
  i '+login s %response.ServerSideRedirect="norights.csp" 
  i '##class(Common.Rights).getrights(login,1) s %response.ServerSideRedirect="norights.csp" 
  //s Access9func=##class(Common.Rights).getrights(login,9)
  q 1
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\Serials.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/Serials.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62193,60069</Default>
</Parameter>
</Class>
</Export>
