<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.garant">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62196,49337.828036</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body>"
	Write !,"<table width=100% class=""LeftTop"" cellspacing=0>",!
	Write "<tr>",!
	Write "	<td class=RightBottom colspan=4>",!
	Write "	<table cellspacing=0><tr>",!
	Write "		<td width=""23%"" class=RightBottom>Серийный номер</td>",!
	Write "		<td width=""23%"" class=RightBottom>"
	Write "<input type=text id=""serial"" value="""_($G(serial))_""" onkeyup=""SerialKeyPress()"">"
	Write "</td>",!
	Write "		<td width=""8%"" class=RightBottom>&nbsp;"
	Write "<span style=""display:"_(displaycheckbox)_""">"
	Write !,"			"
	Write "<input type=""checkbox"" id=""cbNumbersEqual"" style=""border:none;width:15px"" "_(displaycheckboxCHECKED),">"
	Write " номера идентичны"
	Write "</span>"
	Write "</td>",!
	Write "		<td width=""23%"" class=RightBottom>Гарантийный номер</td>",!
	Write "		<td width=""23%"" class=RightBottom>"
	Write "<input type=text id=Name MAXLENGTH=50 value="""_($G(Name))_""" onkeyup=""NameKeyPress()"">"
	Write "</td>",!
	Write "	</table>",!
	Write "<tr>",!
	Write "	<td class=RightBottom>Дата создания</td>",!
	Write "	<td class=RightBottom>"
	Write "<input type=text id=""Dat"" value="""_($G(Dat,$ZD($H,4)))_""" onclick=""fnCalendar(this)"" class=""datar"" onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"">"
	Write " "_($G(Tim))_"</td>",!
	Write "	<td class=RightBottom>Дата выдачи</td>",!
	Write "	<td class=RightBottom>"
	Write "<input type=text id=""Property8550"" value="""_($G(Property8550))_""" onclick=""fnCalendar(this)"" class=""datar"" onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"">"
	Write "</td>",!
	Write "<tr>",!
	Write "	<td class=RightBottom>Дата продажи</td>",!
	Write "	<td class=RightBottom>"
	Write "<input type=text id=""SaleDate"" value="""_($G(SaleDate))_""" onclick=""fnCalendar(this)"" class=""datar"" onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"">"
	Write " </td>",!
	Write "	<td class=RightBottom>&nbsp;</td>",!
	Write "	<td class=RightBottom>&nbsp;</td>",!
	Write "<tr>",!
	Write "	<td class=RightBottom>Контрагент</td>",!
	Write "	<td class=RightBottom>"
	Write "<span onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"" class=Kontragent onclick=""ChooseKonragent(this)"" oncontextmenu=""this.innerText='';this.Tag=''"" id=""Kontr"" Tag='"_($G(Kontr))_"'>"
	Write ($G(KontrName))
	Write "</span>"
	Write "</td>",!
	Write "	<td class=RightBottom>Модель изделия</td>",!
	Write "	<td class=RightBottom>"
	Write "<input type=text id=""tovar"" value="""_($G(tovar))_""">"
	Write "</td>",!
	Write "<tr>",!
	Write "	<td class=RightBottom>Актуальность</td>",!
	Write "	<td class=RightBottom colspan=3>",!
	Write "		"
	w "<select id=""Property9194"">"
	w ##class(Docs.Action2).GetDisplaylistOptions($G(Property9194,2),"Common.Dictionary2||Property9194")
	w "</select>&nbsp;",!
	Write !,"		</td>",!
	Write "<tr>",!
	Write "	<td class=RightBottom>Акт утилизации</td>",!
	Write "	<td class=RightBottom>"_($G(Utiliz))_"&nbsp;</td>",!
	Write "	<td class=RightBottom>Акт технического состояния</td>",!
	Write "	<td class=RightBottom>"_($G(Act))_"&nbsp;</td>",!
	Write "<tr>",!
	Write "	<td class=RightBottom>1 заявка</td>",!
	Write "	<td class=RightBottom>"_($G(remont1))_"&nbsp;</td>",!
	Write "	<td class=RightBottom>1 отчет</td>",!
	Write "	<td class=RightBottom>"_($G(remont1otch))_"&nbsp;</td>",!
	Write "<tr>",!
	Write "	<td class=RightBottom>2 заявка</td>",!
	Write "	<td class=RightBottom>"_($G(remont2))_"&nbsp;</td>",!
	Write "	<td class=RightBottom>2 отчет</td>",!
	Write "	<td class=RightBottom>"_($G(remont2otch))_"&nbsp;</td>",!
	Write "<tr>",!
	Write "	<td class=RightBottom>3 заявка</td>",!
	Write "	<td class=RightBottom>"_($G(remont3))_"&nbsp;</td>",!
	Write "	<td class=RightBottom>3 отчет</td>",!
	Write "	<td class=RightBottom>"_($G(remont3otch))_"&nbsp;</td>",!
	Write "<tr>",!
	Write "	<td class=RightBottom colspan=2>&nbsp;</td>",!
	Write "	<td class=RightBottom>4 отчет</td>",!
	Write "	<td class=RightBottom>"_($G(remont4otch))_"&nbsp;</td>",!
	Write "<tr><td colspan=4>Примечание к гарантийному талону:<br> "
	Write "<textarea id=""Comment"" rows=4 cols=50>"
	Write ($G(Comment))
	Write "</textarea>"
	Write "<br><br>",!
	w:$G(ClosedString)'="" "<tr><td colspan=4 class=RightBottom>Документ закрыт <i>"_ClosedString_"</i>"
	Write !,"</table>",!
	Write "<center>",!
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""Save();"" TITLE=""""><center>Сохранить</center></span>"
	Write " ",!
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""windowclose();"" TITLE=""""><center>Отмена</center></span>"
	Write !,"</center>",!
	Write "</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !
	s GarantId=%request.Get("GarantId")
	s GarantName=%request.Get("GarantName")
	if (GarantId="")&&(GarantName'="")
	{
	s GarantId = $O(^Common.Dictionary2I("garantInd"," "_GarantName,""))
	}
	if (GarantId="") 
	{
	s displaycheckbox="block"
	s displaycheckboxCHECKED="CHECKED"
	}
	else
	{
	s displaycheckbox="none"
	s displaycheckboxCHECKED=""
	}
	//s Property9194 = 2 	//по умолчанию гар талон недействительный
	if $G(GarantId)'=""
	{
	// s ID = $O(^Common.Dictionary2I("garantInd"," "_GarantId,""))
	s ID=GarantId
	s GarantObj = ##class(Common.Dictionary2).%OpenId(ID)
	if $ISOBJECT(GarantObj)
	{
	i GarantObj.Property9194=2 
	{
	if (GarantObj.CloseUser) s CloseUserName=GarantObj.CloseUser.Name
	e  s CloseUserName=""
	s ClosedString=CloseUserName_" "_$S(GarantObj.CloseDat:$ZD(GarantObj.CloseDat,4),1:"")_" "_$S(GarantObj.CloseTime:$ZT(GarantObj.CloseTime),1:"")
	s SaveButtonStyle="display:none"
	}
	s Name=GarantObj.Name
	if $ISOBJECT(GarantObj.Property5330)
	{
	s Kontr=GarantObj.Property5330.%Id()
	s KontrName=GarantObj.Property5330.Name
	}
	s:+GarantObj.Dat Dat=$ZD(GarantObj.Dat,4)
	s:+GarantObj.Property8550 Property8550=$ZD(GarantObj.Property8550,4)
	s:+GarantObj.SaleDate SaleDate=$ZD(GarantObj.SaleDate,4)
	s serial=GarantObj.serial
	s tovar=GarantObj.tovar
	s Property9194=GarantObj.Property9194
	s Comment=GarantObj.Comment
	s Tim = $ZT(GarantObj.Tim)
	if $ISOBJECT(GarantObj.remont1),$ISOBJECT(GarantObj.remont1.Source) s remont1="<a href=""screen/ChiefInstr.csp?docid="_GarantObj.remont1.Source.%Id()_""">"_GarantObj.remont1.Source.Name_"</a>"
	if $ISOBJECT(GarantObj.remont2),$ISOBJECT(GarantObj.remont2.Source) s remont2="<a href=""screen/ChiefInstr.csp?docid="_GarantObj.remont2.Source.%Id()_""">"_GarantObj.remont2.Source.Name_"</a>"
	if $ISOBJECT(GarantObj.remont3),$ISOBJECT(GarantObj.remont3.Source) s remont3="<a href=""screen/ChiefInstr.csp?docid="_GarantObj.remont3.Source.%Id()_""">"_GarantObj.remont3.Source.Name_"</a>"
	if $ISOBJECT(GarantObj.remont1otch) s remont1="<a href=""screen/otchet2.csp?id="_GarantObj.remont1otch.%Id()_""">"_GarantObj.remont1otch.Name_"</a>"
	if $ISOBJECT(GarantObj.remont2otch) s remont2="<a href=""screen/otchet2.csp?id="_GarantObj.remont2otch.%Id()_""">"_GarantObj.remont2otch.Name_"</a>"
	if $ISOBJECT(GarantObj.remont3otch) s remont3="<a href=""screen/otchet2.csp?id="_GarantObj.remont3otch.%Id()_""">"_GarantObj.remont3otch.Name_"</a>"
	if $ISOBJECT(GarantObj.remont4otch) s remont4="<a href=""screen/otchet2.csp?id="_GarantObj.remont4otch.%Id()_""">"_GarantObj.remont4otch.Name_"</a>"
	if $ISOBJECT(GarantObj.Act) s Act="<a href=""print.csp?id="_GarantObj.Act.%Id()_"&class=Docs.Act"">"_GarantObj.Act.Name_"</a>"
	if $ISOBJECT(GarantObj.Utiliz) s Utiliz="<a href=""print.csp?id="_GarantObj.Utiliz.%Id()_"&class=Docs.Utiliz"">"_GarantObj.Utiliz.Name_"</a>"
	}
	}
	Write !
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<title>	Гарантийный талон </title>",!
	Write "<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<script language=""jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<script language=""jscript"">"
	Write !,"var DocId="""_($G(ID))_""";",!
	Write "var sessionid="""_(sessionid)_""";",!
	Write !,"function windowclose(KontrId)",!
	Write "{",!
	Write "	if(window.confirm(""Вы уверены?""))window.close();",!
	Write "}",!
	Write !,"function ChooseKonragent(Obj)",!
	Write "{",!
	Write "	newItem=window.showModalDialog(""Dictionary.csp"",""Common.Kontragent"",""center:yes;status:no;dialogHeight:400px;dialogWidth:650px;resizable:yes;"");",!
	Write "	if(newItem==null){return false;}",!
	Write "	var newArr=newItem.split(InnerSplitter);",!
	Write "	Obj.innerText=newArr[1];",!
	Write "	Obj.Tag=newArr[0];",!
	Write "}",!
	Write !,"function Save()",!
	Write "{",!
	Write "	var xmlDoc = new ActiveXObject(""Msxml2.DOMDocument.3.0"");",!
	Write "	xmlDoc.documentElement= xmlDoc.createElement(""RootElement"");",!
	Write "	",!
	Write "	InsertXmlHeader(xmlDoc,""serial"",serial.value,""%String"")",!
	Write "	InsertXmlHeader(xmlDoc,""Dat"",Dat.value,""%Date"")",!
	Write "	InsertXmlHeader(xmlDoc,""SaleDate"",SaleDate.value,""%Date"")",!
	Write "	InsertXmlHeader(xmlDoc,""Property8550"",Property8550.value,""%Date"")",!
	Write "	InsertXmlHeader(xmlDoc,""Property5330"",Kontr.Tag,""Common.Kontragent"")",!
	Write "	InsertXmlHeader(xmlDoc,""tovar"",tovar.value,""%String"")",!
	Write "	InsertXmlHeader(xmlDoc,""Property9194"",Property9194.value,""%String"")",!
	Write "	InsertXmlHeader(xmlDoc,""Comment"",Comment.value,""%String"")",!
	Write "	InsertXmlHeader(xmlDoc,""Name"",Name.value,""%String"")",!
	Write "	",!
	Write "	var Answer=SendXml(DocId,""Common.Dictionary2"",xmlDoc,sessionid);",!
	Write "	",!
	Write "	if((isNaN(Answer))||(Answer==""""))",!
	Write "	{",!
	Write "		if (Answer=="""") var Answer=""Ошибка при сохранении гарантийного талона. Но ошибка не указана.""",!
	Write "		alert(Answer)",!
	Write "	}",!
	Write "	else",!
	Write "	{",!
	Write "		window.close();",!
	Write "	}",!
	Write "}",!
	Write !,"function SerialKeyPress()",!
	Write "{",!
	Write "	if(cbNumbersEqual.checked)Name.value = serial.value;",!
	Write "}",!
	Write !,"function NameKeyPress()",!
	Write "{",!
	Write "	if(cbNumbersEqual.checked)serial.value = Name.value;",!
	Write "}",!
	Write !,"</script>"
	Write !,"<style>"
	Write !,".LeftTop{border-left : 1 solid black;border-top : 1 solid black;}",!
	Write ".RightBottom{font-family:Arial;font-size:14px;border-right : 1 solid black;border-bottom : 1 solid black;}",!
	Write "SELECT{width:170px}",!
	Write ".Kontragent{width:100%;cursor:hand;}",!
	Write "</style>"
	Write !,!,!,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html>"
	Write !
	Do ..OnPageHEAD()
	Write !,!
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  i %session.NewSession d
  . s %session.EndSession=1
  . s sessionid=%request.Get("sessionid",1)
  . s %session=%session.GetSession(sessionid)
  e  s sessionid=%session.SessionId
  s login=$G(%session.Data("user"))
  i '+login s %response.ServerSideRedirect="norights.csp" 
 Quit 1
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\garant.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/garant.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62192,63243</Default>
</Parameter>
</Class>
</Export>
