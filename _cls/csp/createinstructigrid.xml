<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="20">
<Class name="csp.createinstructigrid">
<ClassType/>
<Hidden>1</Hidden>
<Import>User</Import>
<Language>cache</Language>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>
<TimeCreated>62196,35597.11364</TimeCreated>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Do ..OnPageCSPROOT()
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="OnPageBODY">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<body onload=""load()"" onkeypress=""ManageWindow();"">"
	Write !,(##class(%CSP.Response).HyperEventBody())
	Write !,"<table width=100%><tr><td>",!
	Write "<table class=""LeftTop"" cellspacing=0 width=100%>",!
	s InstrID=%request.Get("source")
	i InstrID {
	&sql(select Oper,Name,Comment,InstDate,Kontr,imp,showcolor,Depot1,dostavka,RashOplatType,Kontr->Name,CloseDate,CloseTime,CloseUser->Name,Stat,postnumber,postdata,Summa,%external(HasBeenSent),BrakComment,PhotoFile 
	into 
Oper,:Name,:Comment,:InstDate,:Kontr,:imp,:showcolor,:Depot1,:dostavka,:RashOplatType,:KontrName,:CloseDate,:CloseTime,:CloseUserName,:Stat,:postnumber,:postdata,:Summa,:HasBeenSent,:BrakComment,:PhotoFile
	from Operation.Instructions where ID=:InstrID)
	i SQLCODE w "<tr><td colspan=4>Ошибка при выводе инструкции "_InstrID_"<br>SQLCODE="_SQLCODE_"</td></tr>"
	i Stat=2 d
	. s ClosedString=CloseUserName_" "_$S(CloseDate:$ZD(CloseDate,4),1:"")_" "_$S(CloseTime:$ZT(CloseTime),1:"")
	. s ClosedString=ClosedString_" "_HasBeenSent
	. s SaveButtonStyle="display:none"
	i postdata s postdata=$ZD(postdata,4)
	}
	w "<tr>"
	w "<td class=RightBottom>Шаблон операции"
	w "<td class=RightBottom>"
	w "<select id='Oper' onchange='ShowHideRashOplatType(this)'>"
	w ##class(Docs.Action2).GetClassValuesOptions($G(Oper),"Operation.OperTemplate")
	w "</select>"
	w "<td class=RightBottom>Сумма"
	w "<td class=RightBottom>"_$G(Summa)_"&nbsp;"
	w "</tr>"
	w "<tr>"
	w "<td class=RightBottom>Краткое описание (номер)<td class=RightBottom><input type=text id=Name MAXLENGTH=50 value='"_$G(Name)_"'>"
	w "<td class=RightBottom>Комментарий<td class=RightBottom><input type=text id=Comment MAXLENGTH=1000 Value='"_$G(Comment)_"'>"
	w "</tr>"
	w "<tr>"
	w "<td class=RightBottom>Дата<td class=RightBottom><input type=text id=""InstDate"" value='"_$ZD($G(InstDate,$H),4)_"' onclick=""fnCalendar(this)"" class=""datar"" onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"">"
	w "<td class=RightBottom>Контрагент<td class=RightBottom><span onmouseout=""UnPaint(this)"" onmouseover=""Paint(this)"" class=Kontragent onclick=""ChooseKonragent(this)"" oncontextmenu=""this.innerText='';this.Tag=''"" id=""Kontr"" Tag='"_$G(Kontr)_"'>"_$G(KontrName)_"</span>"
	w "</tr>"
	w "<tr>"
	w "<td class=RightBottom>Важность"
	w "<td class=RightBottom>"
	w "<select id=""imp"">"
	w ##class(Docs.Action2).GetDisplaylistOptions($G(imp),"Operation.Instructions||imp")
	w "</select>&nbsp;",!
	w "<td class=RightBottom>Выделить цветом"
	w "<td class=RightBottom>"
	w "<select id=""showcolor"">"
	w ##class(Docs.Action2).GetDisplaylistOptions($G(showcolor),"Operation.Instructions||showcolor")
	w "</select>"
	w "<tr>"
	w "<td class=RightBottom>Склад"
	w "<td class=RightBottom>"
	w "<select id='Depot1'>"
	w ##class(Docs.Action2).GetClassValuesOptions($G(Depot1),"Store.Depot")
	w "</select>"
	w "<td class=RightBottom><span id=ZakazInstr5 class=ZakazInstr>Почтовый документ</span>&nbsp;"
	w "<td class=RightBottom><span id=ZakazInstr6 class=ZakazInstr>"_$G(postnumber)_"&nbsp;"_$G(postdata)_"</span>&nbsp;"
	w "<tr>"
	w "<td class=RightBottom><span id=ZakazInstr1 class=ZakazInstr>Способ оплаты</span>&nbsp;"
	w "<td class=RightBottom><span id=ZakazInstr2 class=ZakazInstr><select id='RashOplatType'>"
	w ##class(Docs.Action2).GetClassValuesOptions($G(RashOplatType),"Common.Dictionary7")
	w "</select></span>&nbsp;"
	w "<td class=RightBottom><span id=ZakazInstr3 class=ZakazInstr>Способ доставки</span>&nbsp;"
	w "<td class=RightBottom><span id=ZakazInstr4 class=ZakazInstr>"
	w "<select id='dostavka'>"
	w ##class(Docs.Action2).GetClassValuesOptions($G(dostavka),"Common.Dictionary1")
	w "</select></span>&nbsp;"
	w "</tr>"
	if $G(BrakComment)'="" d
	. w "<tr>"
	. w "<td class=RightBottom>Комментарий клиента&nbsp;"
	. w "<td class=RightBottom colspan=""3"">"_$G(BrakComment)
	. w:$G(PhotoFile)'="" " <a href=""ClientImages\"_$G(PhotoFile)_""" target=_blank>фотоприложение</a>"
	w:$G(ClosedString)'="" "<tr><td colspan=4 class=RightBottom>Инструкция завершена <i>"_ClosedString_"</i>"
	Write !,"</table>",!
	Write "<tr height=100%><td>",!
	Write "<SKLADiGrid:iGrid id=""docstr"" width=""100%"" height=""300"" Enabled=""true"" RowMode=""true"" /><br>",!
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""AddGood();"" TITLE=""""><center>Добавить товар</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""RemoveRow();"" TITLE=""""><center>Удалить строку</center></span>"
	Write !,!,"<span class=ButtonDiv ID="""" style=""cursor:hand;width:150px"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""ClearGrid();"" TITLE=""""><center>Очистить строки</center></span>"
	Write !,"<tr><td>",!
	Write "<center><br>"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"_($G(SaveButtonStyle))_""" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""startFun();"" TITLE=""""><center>Сохранить</center></span>"
	Write !,"<span class=ButtonDiv ID="""" style=""cursor:hand;"" onmouseover=""this.className='ButtonDivHover'"" onmouseout=""this.className='ButtonDiv'"" onclick=""windowclose();"" TITLE=""""><center>Отмена</center></span>"
	Write "</center>",!
	Write "</table>",!
	Write !,"</body>"
]]></Implementation>
</Method>

<Method name="OnPageCSPROOT">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write !
	Do ..OnPageHTML()
]]></Implementation>
</Method>

<Method name="OnPageHEAD">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<head>"
	Write !,"<link href=""style.css"" type=text/css rel=stylesheet>"
	Write !,"<style>"
	Write !,".LeftTop{border-left : 1 solid black;border-top : 1 solid black;}",!
	Write ".RightBottom{font-family:Arial;font-size:14px;border-right : 1 solid black;border-bottom : 1 solid black;}",!
	Write "SELECT{width:170px}",!
	Write ".Kontragent{width:170px;cursor:hand;}",!
	Write ".ZakazInstr{display:inline;}",!
	Write "</style>"
	Write !,"<script language=""jscript"" src=""common.js"">"
	Write "</script>"
	Write !,"<title>Инструкция руководителя</title>",!
	Write !,"<script language=""Jscript"">"
	Write !,"var DocId='"_(%request.Get("source"))_"';",!
	Write "var OriginalInstructionId=DocId;",!
	Write "var sessionid="""_(sessionid)_""";",!
	Write !,"//функция выбора контрагента (подставит выбранного в innerText переданного объекта",!
	Write "function ChooseKonragent(Obj){",!
	Write "newItem=window.showModalDialog(""Dictionary.csp"",""Common.Kontragent"",""center:yes;status:no;dialogHeight:400px;dialogWidth:650px;resizable:yes;"");",!
	Write "if(newItem==null){return false;}",!
	Write "var newArr=newItem.split(InnerSplitter);",!
	Write "Obj.innerText=newArr[1];",!
	Write "Obj.Tag=newArr[0];",!
	Write "}",!
	Write !,"// Скрыть или показать ",!
	Write "function ShowHideRashOplatType(Obj){",!
	Write "if(Obj.value==10)",!
	Write "	{",!
	Write "	ZakazInstr1.style.display='inline';",!
	Write "	ZakazInstr2.style.display='inline';",!
	Write "	ZakazInstr3.style.display='inline';",!
	Write "	ZakazInstr4.style.display='inline';",!
	Write "	ZakazInstr5.style.display='inline';",!
	Write "	ZakazInstr6.style.display='inline';",!
	Write "	}",!
	Write "else",!
	Write "	{",!
	Write "	ZakazInstr1.style.display='none';",!
	Write "	ZakazInstr2.style.display='none';",!
	Write "	ZakazInstr3.style.display='none';",!
	Write "	ZakazInstr4.style.display='none';",!
	Write "	ZakazInstr5.style.display='none';",!
	Write "	ZakazInstr6.style.display='none';",!
	Write "	}",!
	Write "}",!
	Write !,"function load(){",!
	Write "ShowHideRashOplatType(document.getElementById('Oper'));",!
	Write "FillDocStr();",!
	Write "}",!
	Write !,"function FillDocStr(){",!
	Write "var Captions = new Array(4);",!
	Write "var Keys = new Array(4);",!
	Write "var Tags = new Array(4);",!
	Write "var Widths = new Array(4);",!
	Write !,"Captions[0]=""Товар"";",!
	Write "Captions[1]=""Количество"";",!
	Write "Captions[2]=""Цена"";",!
	Write "Captions[3]=""Сумма"";",!
	Write "Captions[4]=""Отзыв клиента"";",!
	Write !,"Tags[0]=""Goods.Goods"";",!
	Write "Tags[1]=""%Numeric"";",!
	Write "Tags[2]=""%Numeric"";",!
	Write "Tags[3]=""%Numeric"";",!
	Write "Tags[4]=""%String"";",!
	Write !,"Keys[0]=""Goods"";",!
	Write "Keys[1]=""Quantity"";",!
	Write "Keys[2]=""Price"";",!
	Write "Keys[3]=""Total"";",!
	Write "Keys[4]=""BrakComment"";",!
	Write !,"Widths[0]=400;",!
	Write "Widths[1]=80;",!
	Write "Widths[2]=80;",!
	Write "Widths[3]=80;",!
	Write "Widths[4]=80;",!
	Write "docstr.DrawHeaders(Captions,Keys,Tags, Widths);",!
	Write "if(DocId!="""")",!
	Write "	{",!
	Write "	docstr.loadfrommethod(""Docs.Action2.ChiefInstructStr"",DocId);",!
	Write "	}",!
	Write "}",!
	Write !,"// сохранить",!
	Write "function startFun(){",!
	Write "xmlDoc=docstr.GetXmlContentByRows();",!
	Write "InsertXmlHeader(xmlDoc,""Summa"",docstr.GetTableSumma(),""%String"")",!
	Write "InsertXmlHeader(xmlDoc,""Oper"",Oper.value,""Operation.OperTemplate"")",!
	Write "InsertXmlHeader(xmlDoc,""Name"",Name.value,""%String"")",!
	Write "InsertXmlHeader(xmlDoc,""Comment"",Comment.value,""%String"")",!
	Write "InsertXmlHeader(xmlDoc,""InstDate"",InstDate.value,""%Date"")",!
	Write "InsertXmlHeader(xmlDoc,""Kontr"",Kontr.Tag,""Common.Kontragent"")",!
	Write "InsertXmlHeader(xmlDoc,""imp"",imp.value,""%String"")",!
	Write "InsertXmlHeader(xmlDoc,""showcolor"",showcolor.value,""%String"")",!
	Write "InsertXmlHeader(xmlDoc,""Depot1"",Depot1.value,""Store.Depot"")",!
	Write "if(Oper.value==10){",!
	Write "	InsertXmlHeader(xmlDoc,""RashOplatType"",RashOplatType.value,""Common.Dictionary7"");",!
	Write "	InsertXmlHeader(xmlDoc,""dostavka"",dostavka.value,""Common.Dictionary1"");",!
	Write "	}",!
	Write !,"var DocID=SendXml(DocId,""Operation.Instructions"",xmlDoc,sessionid);",!
	Write "if(isNaN(DocID)){alert(DocID)}",!
	Write "else{returnValue=1;window.close();}",!
	Write "}",!
	Write !,"function AddBrak(){",!
	Write "WinResult=window.showModalDialog(""SelectBrak.csp"","""",""center:yes;status:no;dialogHeight:700px;dialogWidth:800px;resizable:yes;"")",!
	Write "if(WinResult==null)return",!
	Write "var ok="_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action2.MakeBrakInstruction:csp.createinstructigrid"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',WinResult,ReturnSpace(DocId))",!
	Write "if(isNaN(ok)){alert(ok)}",!
	Write "else{",!
	Write "	//alert('Надо перезагрузить таблицу строк');",!
	Write "	DocId=ok;",!
	Write "	docstr.Clear();",!
	Write "	docstr.loadfrommethod(""Docs.Action2.ChiefInstructStr"",DocId);",!
	Write "	}",!
	Write "}",!
	Write !,"// Добавить товар",!
	Write "function AddGood()",!
	Write "{",!
	Write "	if(Oper.value==11)",!
	Write "		{",!
	Write "		AddBrak();",!
	Write "		return;",!
	Write "		}",!
	Write "	WinResult=window.showModalDialog(""selectgoods2.csp"","""",""center:yes;status:no;dialogHeight:700px;dialogWidth:800px;resizable:yes;"");",!
	Write "	if(WinResult==null)return;",!
	Write "	WinResult=WinResult.split(StringSplitter);",!
	Write "	docstr.AddRowsInstruct(WinResult);",!
	Write "}",!
	Write !,"// удалить строку",!
	Write "function RemoveRow(){",!
	Write "docstr.RemoveSelectedRows();",!
	Write "}",!
	Write !,"// Очистить список",!
	Write "function ClearGrid(){",!
	Write "if(window.confirm(""Удалить все товарные строки?""))docstr.Clear()	",!
	Write "}",!
	Write !,"function windowclose(){",!
	Write "if(window.confirm(""Вы уверены?"")){",!
	Write "	if((OriginalInstructionId=="""")&&(DocId!=""""))",!
	Write "		{",!
	Write "		"_($case(%session.BrokerImplementation,1:"cspRunServerMethod",2:"cspHttpServerMethod",:"cspSelectServerMethod"))_"('"_(..Encrypt($listbuild("Docs.Action.deletedoc:csp.createinstructigrid"))_$select(%session.UseSessionCookie'=2:"&CSPCHD="_%session.CSPSessionCookie,1:""))_"',""Operation.Instructions"",DocId)",!
	Write "		}",!
	Write "	window.close();",!
	Write "}",!
	Write "}",!
	Write !,"</script>"
	Write !,(..HyperEventHead())
	Write !,"</head>"
]]></Implementation>
</Method>

<Method name="OnPageHTML">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	Write "<html XMLNS:SKLADiGrid>"
	Write !,"<IMPORT NAMESPACE=""SKLADiGrid"" IMPLEMENTATION=""htc/iGridV9.htc"">",!
	Do ..OnPageHEAD()
	Write !,!
	Do ..OnPageBODY()
	Write !,"</html>"
]]></Implementation>
</Method>

<Method name="OnPreHTTP">
<ClassMethod>1</ClassMethod>
<CodeMode>code</CodeMode>
<FormalSpec/>
<Language>cache</Language>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
  i %session.NewSession d
  . s %session.EndSession=1
  . s sessionid=%request.Get("sessionid",1)
  . s %session=%session.GetSession(sessionid)
  .  s login=$G(%session.Data("user"))
  . i '+login s %response.ServerSideRedirect="norights.csp" 
  e  s sessionid=%session.SessionId
  
 Quit 1
 
]]></Implementation>
</Method>

<Parameter name="CSPFILE">
<Default>c:\cachesys\csp\sklad2\createinstructIgrid.csp</Default>
</Parameter>

<Parameter name="CSPURL">
<Default>/csp/sklad2/createinstructIgrid.csp</Default>
</Parameter>

<Parameter name="FileTimestamp">
<Default>62181,50215</Default>
</Parameter>
</Class>
</Export>
