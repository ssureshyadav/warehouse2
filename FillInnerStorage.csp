<html>
<head>

<!-- Put your page Title here -->
<title>Дополнить внутренние инструкции недостающими строками</title>

</head>

<body>

<form>
Пароль <input type="text" name="dfg"><br>
Введите номер расходной накладной<br>
<input type=text name="zzz" value="#(%request.Get("zzz"))#"><input type=submit value="Отправить">
</form>
<script language="cache" runat="server">
 s dfg=%request.Get("dfg")
 s zzz=%request.Get("zzz")
 i (dfg'="mahmah")&(zzz'="") w "Пароль неверный."
 i (dfg="mahmah")&(zzz'="") d
 . s Name=%request.Get("dfg")
 . &sql(select ID into :DocId from Docs.Rash where Name=:zzz)
 . &sql(select ID,Name,Dat into :StoreId,:StName,:StDat from Docs.StorageOut where Source=:DocId)
 . i SQLCODE w "Не найдено внутренних инструкций от расходной "_zzz_" ("_DocId_")" q
 . w "Обработана внутренняя инструкция №"_StName_" ("_StoreId_") от "_$ZD(StDat,4)_"<br>"
 . &sql(declare h1 cursor for select Goods->FullName,ID,Goods,Price,Quantity,Total,Zakaz into :GoodsFullName,:ID,:Goods,:Price,:Quantity,:Total,:Zakaz  from Docs.RashItems where doc=:DocId)
 . &sql(OPEN h1)
 . F  &SQL(fetch h1) q:SQLCODE  d
 . . &sql(select id from Docs.StorageOutItems where doc=:StoreId and Goods=:Goods)
 . . d:SQLCODE
 . . . //если не нашли внутреннюю строку с таким же товаров как у расходной строки
 . . . &sql(insert into Docs.StorageOutItems (DocType,doc,Goods,quantdefault,Price,Total) VALUES ('Docs.StorageOut',:StoreId,:Goods,:Quantity,:Price,:Total))
 . . . i SQLCODE w "SQLCODE="_SQLCODE_"<br>"
 . . . e  w "Добавлена строка с товаром "_GoodsFullName_"<br>"
 . &sql(close h1)
</script>
</body>
</html>
